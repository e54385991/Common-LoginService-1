<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支付订单 - Common Login Service 管理后台</title>
    <link href="/static/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/static/vendor/bootstrap-icons/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/admin.css" rel="stylesheet">
</head>
<body>
    <div class="admin-wrapper">
        {{template "admin_sidebar" .}}

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1 class="page-title"><i class="bi bi-receipt me-2"></i>支付订单</h1>
            </header>

            <div class="admin-content">
                <!-- Statistics Cards -->
                <div class="row mb-4" id="statisticsCards">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card bg-primary text-white h-100">
                            <div class="card-body">
                                <h6 class="card-title mb-2"><i class="bi bi-currency-dollar me-1"></i>总收入</h6>
                                <h3 class="mb-0">¥<span id="totalAmount">0.00</span></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card bg-success text-white h-100">
                            <div class="card-body">
                                <h6 class="card-title mb-2"><i class="bi bi-check-circle me-1"></i>成功订单</h6>
                                <h3 class="mb-0"><span id="successOrders">0</span></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card bg-warning text-dark h-100">
                            <div class="card-body">
                                <h6 class="card-title mb-2"><i class="bi bi-clock me-1"></i>待支付</h6>
                                <h3 class="mb-0"><span id="pendingOrders">0</span></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card bg-info text-white h-100">
                            <div class="card-body">
                                <h6 class="card-title mb-2"><i class="bi bi-calendar-day me-1"></i>今日收入</h6>
                                <h3 class="mb-0">¥<span id="todayAmount">0.00</span></h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Secondary Stats -->
                <div class="row mb-4">
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted mb-2"><i class="bi bi-gem me-1"></i>VIP收入</h6>
                                <h4 class="mb-0 text-primary">¥<span id="vipTotal">0.00</span></h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted mb-2"><i class="bi bi-wallet2 me-1"></i>充值收入</h6>
                                <h4 class="mb-0 text-success">¥<span id="rechargeTotal">0.00</span></h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title text-muted mb-2"><i class="bi bi-calendar-check me-1"></i>今日订单</h6>
                                <h4 class="mb-0 text-info"><span id="todayOrders">0</span></h4>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h5 class="mb-0">订单列表</h5>
                            </div>
                            <div class="col-md-9">
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <input type="text" class="form-control form-control-sm" id="filterKeyword" placeholder="订单号/用户ID">
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select form-select-sm" id="filterStatus">
                                            <option value="">全部状态</option>
                                            <option value="pending">待支付</option>
                                            <option value="success">成功</option>
                                            <option value="fail">失败</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select form-select-sm" id="filterProductType">
                                            <option value="">全部类型</option>
                                            <option value="vip">VIP</option>
                                            <option value="recharge">充值</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-primary btn-sm w-100" onclick="loadOrders()">
                                            <i class="bi bi-search me-1"></i>筛选
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>订单号</th>
                                        <th>用户ID</th>
                                        <th>产品类型</th>
                                        <th>产品详情</th>
                                        <th>金额</th>
                                        <th>状态</th>
                                        <th>创建时间</th>
                                        <th>支付时间</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center text-muted py-4">
                                            <i class="bi bi-hourglass-split fs-1 d-block mb-2"></i>
                                            加载中...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                共 <span id="totalCount">0</span> 条记录
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/static/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        const pageSize = 20;

        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadOrders();
        });

        async function loadStatistics() {
            try {
                const response = await fetch('/api/admin/payment-orders/statistics');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('totalAmount').textContent = (data.data.total_amount || 0).toFixed(2);
                    document.getElementById('successOrders').textContent = data.data.success_orders || 0;
                    document.getElementById('pendingOrders').textContent = data.data.pending_orders || 0;
                    document.getElementById('todayAmount').textContent = (data.data.today_amount || 0).toFixed(2);
                    document.getElementById('todayOrders').textContent = data.data.today_orders || 0;
                    document.getElementById('vipTotal').textContent = (data.data.vip_total || 0).toFixed(2);
                    document.getElementById('rechargeTotal').textContent = (data.data.recharge_total || 0).toFixed(2);
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }

        async function loadOrders(page = 1) {
            currentPage = page;
            const keyword = document.getElementById('filterKeyword').value.trim();
            const status = document.getElementById('filterStatus').value;
            const productType = document.getElementById('filterProductType').value;

            let url = `/api/admin/payment-orders?page=${page}&per_page=${pageSize}`;
            if (keyword) url += `&keyword=${encodeURIComponent(keyword)}`;
            if (status) url += `&status=${status}`;
            if (productType) url += `&product_type=${productType}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.success) {
                    renderOrders(data.data.orders);
                    document.getElementById('totalCount').textContent = data.data.total;
                    renderPagination(data.data.total, data.data.page, data.data.total_pages);
                }
            } catch (error) {
                console.error('Failed to load orders:', error);
            }
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            
            if (!orders || orders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            暂无订单数据
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>${order.id}</td>
                    <td><code class="small">${order.order_id}</code></td>
                    <td><a href="/admin/users?search=${order.user_id}" class="text-decoration-none">${order.user_id}</a></td>
                    <td>${getProductTypeLabel(order.product_type)}</td>
                    <td>${getProductDetail(order)}</td>
                    <td class="text-primary fw-bold">¥${order.amount.toFixed(2)}</td>
                    <td>${getStatusBadge(order.status)}</td>
                    <td>${formatDate(order.created_at)}</td>
                    <td>${order.paid_at ? formatDate(order.paid_at) : '<span class="text-muted">-</span>'}</td>
                </tr>
            `).join('');
        }

        function getProductTypeLabel(type) {
            const labels = {
                'vip': '<span class="badge bg-warning">VIP</span>',
                'recharge': '<span class="badge bg-success">充值</span>'
            };
            return labels[type] || `<span class="badge bg-secondary">${type}</span>`;
        }

        function getProductDetail(order) {
            if (order.product_type === 'vip') {
                let detail = `VIP${order.product_id}`;
                if (order.duration > 0) {
                    detail += ` (${order.duration}天)`;
                }
                return detail;
            }
            return '-';
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge bg-warning text-dark">待支付</span>',
                'success': '<span class="badge bg-success">成功</span>',
                'fail': '<span class="badge bg-danger">失败</span>'
            };
            return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function renderPagination(total, page, totalPages) {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            
            // Previous button
            html += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadOrders(${page - 1}); return false;">上一页</a>
            </li>`;

            // Page numbers
            const startPage = Math.max(1, page - 2);
            const endPage = Math.min(totalPages, page + 2);

            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadOrders(1); return false;">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadOrders(${i}); return false;">${i}</a>
                </li>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadOrders(${totalPages}); return false;">${totalPages}</a></li>`;
            }

            // Next button
            html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadOrders(${page + 1}); return false;">下一页</a>
            </li>`;

            pagination.innerHTML = html;
        }
    </script>
</body>
</html>
