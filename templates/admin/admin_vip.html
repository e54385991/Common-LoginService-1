<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP配置 - {{.config.Site.Title}} 管理后台</title>
    <link href="/static/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/static/vendor/bootstrap-icons/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/admin.css" rel="stylesheet">
    <style>
        .vip-card {
            border-radius: 16px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
        }
        .vip-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .vip-header {
            padding: 24px;
            text-align: center;
            color: white;
        }
        .vip-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        .vip-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .vip-price {
            font-size: 2.5rem;
            font-weight: 800;
        }
        .vip-price small {
            font-size: 1rem;
            font-weight: 400;
        }
        .vip-body {
            padding: 24px;
            background: white;
        }
        .vip-description {
            color: #666;
            margin-bottom: 16px;
            min-height: 48px;
        }
        .vip-description > *:first-child {
            margin-top: 0 !important;
        }
        .vip-duration {
            color: #888;
            font-size: 0.9rem;
        }
        .vip-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }
        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: inline-block;
            vertical-align: middle;
            border: 2px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        {{template "admin_sidebar" .}}

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1 class="page-title"><i class="bi bi-gem me-2"></i>VIP配置</h1>
            </header>

            <div class="admin-content">
                <div id="alert-container"></div>

                <!-- VIP Preview Cards -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-eye me-2"></i>VIP等级预览（卡片式）</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4" id="vip-preview-container">
                            <!-- VIP cards will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Payment Settings -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-credit-card me-2"></i>支付设置 (PyPay)</h5>
                        <div class="d-flex gap-3">
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="payment-demo-mode" {{if .config.Payment.DemoMode}}checked{{end}}>
                                <label class="form-check-label" for="payment-demo-mode">演示模式</label>
                            </div>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="payment-enabled" {{if .config.Payment.Enabled}}checked{{end}}>
                                <label class="form-check-label" for="payment-enabled">启用支付</label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            使用 <a href="https://pypay.meilanyv.cn/docs" target="_blank">PyPay</a> 支付系统处理充值和VIP购买。
                            <strong>演示模式</strong>开启时，支付将模拟进行而不会实际跳转到支付页面。
                        </div>
                        <form id="payment-form">
                            <div class="mb-3">
                                <label for="payment-api-url" class="form-label">API URL</label>
                                <input type="text" class="form-control" id="payment-api-url" value="{{.config.Payment.ApiURL}}" placeholder="https://pypay.meilanyv.cn/api/">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="payment-merchant-id" class="form-label">商户ID</label>
                                    <input type="text" class="form-control" id="payment-merchant-id" value="{{.config.Payment.MerchantID}}" placeholder="输入商户ID">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="payment-api-key" class="form-label">API Key</label>
                                    <input type="password" class="form-control" id="payment-api-key" placeholder="输入 API Key（留空则不修改）">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="payment-notify-url" class="form-label">异步通知 URL</label>
                                    <input type="text" class="form-control" id="payment-notify-url" value="{{.config.Payment.NotifyURL}}" placeholder="https://your-domain.com/api/payment/notify">
                                    <small class="text-muted">支付系统（PyPay）异步通知本系统支付结果的回调地址，需填写本站可被外网访问的完整URL，路由固定为 <code>/api/payment/notify</code></small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="payment-return-url" class="form-label">同步跳转 URL</label>
                                    <input type="text" class="form-control" id="payment-return-url" value="{{.config.Payment.ReturnURL}}" placeholder="https://your-domain.com/payment/result">
                                    <small class="text-muted">用户支付完成后，浏览器跳转回本站的页面地址</small>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存支付设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- VIP Levels Configuration -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-star me-2"></i>VIP等级配置</h5>
                        <button type="button" class="btn btn-success btn-sm" onclick="addVIPLevel()">
                            <i class="bi bi-plus-lg me-1"></i>添加等级
                        </button>
                    </div>
                    <div class="card-body">
                        <form id="vip-levels-form">
                            <div id="vip-levels-container">
                                <!-- VIP level forms will be rendered here -->
                            </div>
                            <button type="submit" class="btn btn-primary mt-3">
                                <i class="bi bi-save me-2"></i>保存VIP配置
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast for notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-bell me-2"></i>
                <strong class="me-auto">通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <script src="/static/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script>
        let vipLevels = [];
        let notificationToast;

        document.addEventListener('DOMContentLoaded', function() {
            notificationToast = new bootstrap.Toast(document.getElementById('notificationToast'));
            loadVIPLevels();
        });

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        function showModal(type, message) {
            const iconMap = {
                'success': 'bi-check-circle-fill',
                'danger': 'bi-exclamation-circle-fill',
                'warning': 'bi-exclamation-triangle-fill'
            };
            const colorMap = {
                'success': '#28a745',
                'danger': '#dc3545',
                'warning': '#ffc107'
            };
            const titleMap = {
                'success': '保存成功',
                'danger': '保存失败',
                'warning': '警告'
            };
            
            // Remove existing modal
            const existingModal = document.getElementById('resultModal');
            if (existingModal) existingModal.remove();
            
            const modalHtml = `
                <div class="modal fade" id="resultModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-body text-center py-5">
                                <i class="bi ${iconMap[type]} display-1 mb-3" style="color: ${colorMap[type]}"></i>
                                <h4 class="mb-3">${titleMap[type]}</h4>
                                <p class="text-muted mb-0">${message}</p>
                            </div>
                            <div class="modal-footer justify-content-center border-0 pt-0">
                                <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">确定</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            modal.show();
        }

        function showToast(message, isError = false) {
            const toastEl = document.getElementById('notificationToast');
            const toastBody = document.getElementById('toastMessage');
            toastBody.textContent = message;
            toastEl.classList.remove('bg-success', 'bg-danger');
            toastEl.classList.add(isError ? 'bg-danger' : 'bg-success');
            toastEl.classList.add('text-white');
            notificationToast.show();
        }

        // Helper function to escape HTML for textarea display
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadVIPLevels() {
            try {
                const response = await fetch('/api/admin/settings/vip-levels');
                const result = await response.json();
                if (result.success) {
                    vipLevels = result.data || [];
                    renderVIPLevels();
                    renderVIPPreview();
                }
            } catch (error) {
                console.error('Failed to load VIP levels:', error);
            }
        }

        function renderVIPLevels() {
            const container = document.getElementById('vip-levels-container');
            container.innerHTML = '';
            
            vipLevels.forEach((level, index) => {
                // Generate upgrade price inputs for all lower levels
                let upgradePricesHtml = '';
                const lowerLevels = vipLevels.filter(l => l.level < level.level);
                if (lowerLevels.length > 0) {
                    upgradePricesHtml = `
                        <div class="row mt-3">
                            <div class="col-12">
                                <label class="form-label"><i class="bi bi-arrow-up-circle me-1"></i>升级价格配置 <small class="text-muted">(从低等级升级到此等级的优惠价格)</small></label>
                            </div>
                            ${lowerLevels.map(lower => {
                                // Use string key for upgrade_prices lookup (JSON uses string keys)
                                const lowerLevelKey = String(lower.level);
                                const upgradePrice = level.upgrade_prices ? (level.upgrade_prices[lowerLevelKey] || '') : '';
                                return `
                                    <div class="col-md-4 mb-2">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">从 VIP${lower.level}</span>
                                            <input type="number" step="0.01" class="form-control" value="${upgradePrice}" 
                                                placeholder="默认原价" 
                                                onchange="updateUpgradePrice(${index}, ${lower.level}, this.value)">
                                            <span class="input-group-text">¥</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                container.innerHTML += `
                    <div class="card mb-3 vip-level-card" data-index="${index}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span><i class="${level.icon || 'bi-star'}" style="color: ${level.color || '#ffd700'}"></i> VIP ${level.level}</span>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeVIPLevel(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">等级</label>
                                    <input type="number" class="form-control" value="${level.level}" onchange="updateVIPLevel(${index}, 'level', parseInt(this.value))">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">名称</label>
                                    <input type="text" class="form-control" value="${level.name}" onchange="updateVIPLevel(${index}, 'name', this.value)">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">原价 (¥)</label>
                                    <input type="number" step="0.01" class="form-control" value="${level.price}" onchange="updateVIPLevel(${index}, 'price', parseFloat(this.value))">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">有效期 (天)</label>
                                    <input type="number" class="form-control" value="${level.duration}" onchange="updateVIPLevel(${index}, 'duration', parseInt(this.value))" placeholder="0 = 永久">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">描述 <small class="text-muted">(支持HTML代码)</small></label>
                                    <textarea class="form-control" rows="3" onchange="updateVIPLevel(${index}, 'description', this.value)" placeholder="支持HTML标签，如 &lt;b&gt;加粗&lt;/b&gt;、&lt;br&gt;换行等">${escapeHtml(level.description)}</textarea>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">图标 (Bootstrap Icons)</label>
                                    <input type="text" class="form-control" value="${level.icon || 'bi-star'}" onchange="updateVIPLevel(${index}, 'icon', this.value)" placeholder="bi-star">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">颜色</label>
                                    <div class="input-group">
                                        <input type="color" class="form-control form-control-color" value="${level.color || '#ffd700'}" onchange="updateVIPLevel(${index}, 'color', this.value)">
                                        <input type="text" class="form-control" value="${level.color || '#ffd700'}" onchange="updateVIPLevel(${index}, 'color', this.value)">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="allow-renewal-${index}" 
                                               ${level.allow_renewal ? 'checked' : ''} 
                                               onchange="updateVIPLevel(${index}, 'allow_renewal', this.checked)">
                                        <label class="form-check-label" for="allow-renewal-${index}">
                                            <i class="bi bi-arrow-repeat me-1"></i>允许用户续期
                                            <small class="text-muted d-block">开启后，已有此VIP等级的用户可以续期（在现有到期时间基础上累加）</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Specifications Section -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0"><i class="bi bi-list-ul me-1"></i>多种时长规格 <small class="text-muted">(可选，添加多种时长/价格选项)</small></label>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addSpecification(${index})">
                                            <i class="bi bi-plus-lg me-1"></i>添加规格
                                        </button>
                                    </div>
                                    <div id="specifications-${index}" class="specifications-container">
                                        ${renderSpecifications(level, index)}
                                    </div>
                                </div>
                            </div>
                            
                            ${upgradePricesHtml}
                        </div>
                    </div>
                `;
            });
        }
        
        function renderSpecifications(level, levelIndex) {
            if (!level.specifications || level.specifications.length === 0) {
                return '<div class="text-muted small">暂无多种规格，使用默认价格和时长。</div>';
            }
            
            let html = '<div class="table-responsive"><table class="table table-sm table-bordered mb-0"><thead><tr><th>时长(天)</th><th>价格(¥)</th><th>操作</th></tr></thead><tbody>';
            
            level.specifications.forEach((spec, specIndex) => {
                html += `
                    <tr>
                        <td>
                            <input type="number" class="form-control form-control-sm" value="${spec.duration}" 
                                onchange="updateSpecification(${levelIndex}, ${specIndex}, 'duration', parseInt(this.value))" 
                                placeholder="0 = 永久">
                        </td>
                        <td>
                            <input type="number" step="0.01" class="form-control form-control-sm" value="${spec.price}" 
                                onchange="updateSpecification(${levelIndex}, ${specIndex}, 'price', parseFloat(this.value))">
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeSpecification(${levelIndex}, ${specIndex})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            return html;
        }
        
        function addSpecification(levelIndex) {
            if (!vipLevels[levelIndex].specifications) {
                vipLevels[levelIndex].specifications = [];
            }
            vipLevels[levelIndex].specifications.push({
                duration: 30,
                price: vipLevels[levelIndex].price
            });
            const container = document.getElementById(`specifications-${levelIndex}`);
            container.innerHTML = renderSpecifications(vipLevels[levelIndex], levelIndex);
        }
        
        function updateSpecification(levelIndex, specIndex, field, value) {
            if (vipLevels[levelIndex].specifications && vipLevels[levelIndex].specifications[specIndex]) {
                vipLevels[levelIndex].specifications[specIndex][field] = value;
            }
        }
        
        function removeSpecification(levelIndex, specIndex) {
            if (vipLevels[levelIndex].specifications) {
                vipLevels[levelIndex].specifications.splice(specIndex, 1);
                if (vipLevels[levelIndex].specifications.length === 0) {
                    delete vipLevels[levelIndex].specifications;
                }
                const container = document.getElementById(`specifications-${levelIndex}`);
                container.innerHTML = renderSpecifications(vipLevels[levelIndex], levelIndex);
            }
        }

        function updateUpgradePrice(levelIndex, fromLevel, value) {
            if (!vipLevels[levelIndex].upgrade_prices) {
                vipLevels[levelIndex].upgrade_prices = {};
            }
            // Use string key for consistency with JSON serialization
            const fromLevelKey = String(fromLevel);
            if (value === '' || isNaN(parseFloat(value))) {
                delete vipLevels[levelIndex].upgrade_prices[fromLevelKey];
            } else {
                vipLevels[levelIndex].upgrade_prices[fromLevelKey] = parseFloat(value);
            }
            // Clean up empty upgrade_prices object
            if (Object.keys(vipLevels[levelIndex].upgrade_prices).length === 0) {
                delete vipLevels[levelIndex].upgrade_prices;
            }
        }

        function renderVIPPreview() {
            const container = document.getElementById('vip-preview-container');
            container.innerHTML = '';
            
            vipLevels.forEach(level => {
                container.innerHTML += `
                    <div class="col-md-4">
                        <div class="vip-card shadow">
                            <div class="vip-header" style="background: linear-gradient(135deg, ${level.color || '#ffd700'} 0%, ${adjustColor(level.color || '#ffd700', -30)} 100%)">
                                <div class="vip-icon"><i class="${level.icon || 'bi-star'}"></i></div>
                                <div class="vip-name">${level.name}</div>
                                <div class="vip-price">¥${level.price}<small>/${level.duration > 0 ? level.duration + '天' : '永久'}</small></div>
                            </div>
                            <div class="vip-body text-center">
                                ${level.description ? `<p class="vip-description">${level.description}</p>` : ''}
                                <p class="vip-duration">
                                    <i class="bi bi-clock me-1"></i>
                                    ${level.duration > 0 ? level.duration + ' 天' : '永久'}
                                </p>
                                <button class="btn btn-primary w-100" disabled>立即开通</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            const num = parseInt(hex, 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
        }

        function updateVIPLevel(index, field, value) {
            vipLevels[index][field] = value;
            renderVIPPreview();
        }

        function addVIPLevel() {
            const maxLevel = vipLevels.length > 0 ? Math.max(...vipLevels.map(l => l.level)) : 0;
            vipLevels.push({
                level: maxLevel + 1,
                name: `VIP ${maxLevel + 1}`,
                description: '会员特权描述',
                price: 0,
                duration: 30,
                icon: 'bi-star',
                color: '#ffd700'
            });
            renderVIPLevels();
            renderVIPPreview();
        }

        function removeVIPLevel(index) {
            vipLevels.splice(index, 1);
            renderVIPLevels();
            renderVIPPreview();
        }

        // Payment Settings Form
        document.getElementById('payment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('payment-enabled').checked,
                demo_mode: document.getElementById('payment-demo-mode').checked,
                api_url: document.getElementById('payment-api-url').value,
                merchant_id: document.getElementById('payment-merchant-id').value,
                api_key: document.getElementById('payment-api-key').value,
                notify_url: document.getElementById('payment-notify-url').value,
                return_url: document.getElementById('payment-return-url').value
            };
            
            try {
                const response = await fetch('/api/admin/settings/payment', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // VIP Levels Form
        document.getElementById('vip-levels-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const response = await fetch('/api/admin/settings/vip-levels', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vip_levels: vipLevels })
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });
    </script>
</body>
</html>
