<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>余额变更日志 - Common Login Service 管理后台</title>
    <link href="/static/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/static/vendor/bootstrap-icons/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/admin.css" rel="stylesheet">
</head>
<body>
    <div class="admin-wrapper">
        {{template "admin_sidebar" .}}

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1 class="page-title"><i class="bi bi-journal-text me-2"></i>余额变更日志</h1>
            </header>

            <div class="admin-content">
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0">日志列表</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <input type="number" class="form-control form-control-sm" id="filterUserId" placeholder="用户ID">
                                    </div>
                                    <div class="col-md-4">
                                        <select class="form-select form-select-sm" id="filterType">
                                            <option value="">全部类型</option>
                                            <option value="admin">管理员操作</option>
                                            <option value="api">API操作</option>
                                            <option value="gift_card">礼品卡</option>
                                            <option value="purchase_vip">购买VIP</option>
                                            <option value="payment">在线支付</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-primary btn-sm w-100" onclick="loadLogs()">
                                            <i class="bi bi-search me-1"></i>筛选
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>用户ID</th>
                                        <th>变更金额</th>
                                        <th>变更前</th>
                                        <th>变更后</th>
                                        <th>类型</th>
                                        <th>原因</th>
                                        <th>操作来源</th>
                                        <th>时间</th>
                                    </tr>
                                </thead>
                                <tbody id="logsTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center text-muted py-4">
                                            <i class="bi bi-hourglass-split fs-1 d-block mb-2"></i>
                                            加载中...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                共 <span id="totalCount">0</span> 条记录
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/static/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        const pageSize = 20;

        document.addEventListener('DOMContentLoaded', function() {
            loadLogs();
        });

        function getTypeLabel(type) {
            const types = {
                'admin': '<span class="badge bg-primary">管理员操作</span>',
                'api': '<span class="badge bg-info">API操作</span>',
                'gift_card': '<span class="badge bg-success">礼品卡</span>',
                'purchase_vip': '<span class="badge bg-warning">购买VIP</span>',
                'payment': '<span class="badge bg-secondary">在线支付</span>'
            };
            return types[type] || `<span class="badge bg-dark">${type}</span>`;
        }

        function getOperatorTypeLabel(type) {
            const types = {
                'admin': '管理员',
                'api_token': 'API令牌',
                'system': '系统',
                'user': '用户'
            };
            return types[type] || type;
        }

        function formatAmount(amount) {
            if (amount > 0) {
                return `<span class="text-success">+${amount.toFixed(2)}</span>`;
            } else if (amount < 0) {
                return `<span class="text-danger">${amount.toFixed(2)}</span>`;
            }
            return `<span class="text-muted">0.00</span>`;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function loadLogs(page = 1) {
            currentPage = page;
            const userId = document.getElementById('filterUserId').value;
            const type = document.getElementById('filterType').value;

            let url = `/api/admin/balance-logs?page=${page}&page_size=${pageSize}`;
            if (userId) url += `&user_id=${userId}`;
            if (type) url += `&type=${type}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    renderLogs(data.data.logs);
                    renderPagination(data.data.total, data.data.page);
                    document.getElementById('totalCount').textContent = data.data.total;
                } else {
                    document.getElementById('logsTableBody').innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-danger py-4">
                                <i class="bi bi-exclamation-circle fs-1 d-block mb-2"></i>
                                加载失败: ${data.message}
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                document.getElementById('logsTableBody').innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-danger py-4">
                            <i class="bi bi-exclamation-circle fs-1 d-block mb-2"></i>
                            加载失败: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function renderLogs(logs) {
            const tbody = document.getElementById('logsTableBody');
            
            if (!logs || logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            暂无日志记录
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>${log.id}</td>
                    <td><a href="/admin/users?keyword=${log.user_id}">${log.user_id}</a></td>
                    <td>${formatAmount(log.amount)}</td>
                    <td>¥${log.balance_before.toFixed(2)}</td>
                    <td>¥${log.balance_after.toFixed(2)}</td>
                    <td>${getTypeLabel(log.type)}</td>
                    <td>${log.reason || '-'}</td>
                    <td>${getOperatorTypeLabel(log.operator_type)}</td>
                    <td>${formatDate(log.created_at)}</td>
                </tr>
            `).join('');
        }

        function renderPagination(total, currentPage) {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(total / pageSize);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';
            
            // Previous button
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadLogs(${currentPage - 1}); return false;">上一页</a>
            </li>`;

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadLogs(1); return false;">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadLogs(${i}); return false;">${i}</a>
                </li>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item"><a class="page-link" href="#" onclick="loadLogs(${totalPages}); return false;">${totalPages}</a></li>`;
            }

            // Next button
            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadLogs(${currentPage + 1}); return false;">下一页</a>
            </li>`;

            pagination.innerHTML = html;
        }
    </script>
</body>
</html>
