<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - Common Login Service 管理后台</title>
    <link href="/static/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/static/vendor/bootstrap-icons/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/admin.css" rel="stylesheet">
</head>
<body>
    <div class="admin-wrapper">
        {{template "admin_sidebar" .}}

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1 class="page-title"><i class="bi bi-gear me-2"></i>系统设置</h1>
            </header>

            <div class="admin-content">
                <div id="alert-container"></div>

                <!-- Google OAuth Settings -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-google me-2"></i>Google OAuth 设置
                        </h5>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="google-oauth-enabled" {{if .config.GoogleOAuth.Enabled}}checked{{end}}>
                            <label class="form-check-label" for="google-oauth-enabled">启用</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="google-oauth-form">
                            <div class="mb-3">
                                <label for="google-client-id" class="form-label">Client ID</label>
                                <input type="text" class="form-control" id="google-client-id" value="{{.config.GoogleOAuth.ClientID}}" placeholder="输入 Google OAuth Client ID">
                            </div>
                            <div class="mb-3">
                                <label for="google-client-secret" class="form-label">Client Secret</label>
                                <input type="password" class="form-control" id="google-client-secret" placeholder="输入 Google OAuth Client Secret（留空则不修改）">
                            </div>
                            <div class="mb-3">
                                <label for="google-redirect-url" class="form-label">Redirect URL</label>
                                <input type="text" class="form-control" id="google-redirect-url" value="{{.config.GoogleOAuth.RedirectURL}}" placeholder="例如: http://localhost:8080/api/auth/google/callback">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存 Google OAuth 设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Steam OAuth Settings -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-steam me-2"></i>Steam 登录设置
                        </h5>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="steam-oauth-enabled" {{if .config.SteamOAuth.Enabled}}checked{{end}}>
                            <label class="form-check-label" for="steam-oauth-enabled">启用</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="steam-oauth-form">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                Steam 使用 OpenID 2.0 协议进行身份验证。您需要在 <a href="https://steamcommunity.com/dev/apikey" target="_blank">Steam API Key</a> 页面获取 API Key。
                            </div>
                            <div class="mb-3">
                                <label for="steam-api-key" class="form-label">Steam API Key</label>
                                <input type="password" class="form-control" id="steam-api-key" placeholder="输入 Steam API Key（留空则不修改）">
                            </div>
                            <div class="mb-3">
                                <label for="steam-redirect-url" class="form-label">Redirect URL</label>
                                <input type="text" class="form-control" id="steam-redirect-url" value="{{.config.SteamOAuth.RedirectURL}}" placeholder="例如: http://localhost:8080/api/auth/steam/callback">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存 Steam 登录设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Discord OAuth Settings -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-discord me-2"></i>Discord OAuth 设置
                        </h5>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="discord-oauth-enabled" {{if .config.DiscordOAuth.Enabled}}checked{{end}}>
                            <label class="form-check-label" for="discord-oauth-enabled">启用</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="discord-oauth-form">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                您可以在 <a href="https://discord.com/developers/applications" target="_blank">Discord Developer Portal</a> 创建应用并获取 OAuth2 凭据。
                            </div>
                            <div class="mb-3">
                                <label for="discord-client-id" class="form-label">Client ID</label>
                                <input type="text" class="form-control" id="discord-client-id" value="{{.config.DiscordOAuth.ClientID}}" placeholder="输入 Discord OAuth Client ID">
                            </div>
                            <div class="mb-3">
                                <label for="discord-client-secret" class="form-label">Client Secret</label>
                                <input type="password" class="form-control" id="discord-client-secret" placeholder="输入 Discord OAuth Client Secret（留空则不修改）">
                            </div>
                            <div class="mb-3">
                                <label for="discord-redirect-url" class="form-label">Redirect URL</label>
                                <input type="text" class="form-control" id="discord-redirect-url" value="{{.config.DiscordOAuth.RedirectURL}}" placeholder="例如: http://localhost:8080/api/auth/discord/callback">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存 Discord OAuth 设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Gmail API Settings -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-envelope me-2"></i>Gmail API 设置
                        </h5>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="gmail-api-enabled" {{if .config.GmailAPI.Enabled}}checked{{end}}>
                            <label class="form-check-label" for="gmail-api-enabled">启用</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="gmail-api-form">
                            <div class="mb-3">
                                <label for="gmail-sender" class="form-label">发送邮箱</label>
                                <input type="email" class="form-control" id="gmail-sender" value="{{.config.GmailAPI.SenderEmail}}" placeholder="用于发送邮件的 Gmail 地址">
                            </div>
                            <hr class="my-4">
                            <h6 class="mb-3"><i class="bi bi-key me-2"></i>OAuth 2.0 凭据</h6>
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                您可以通过 OAuth 2.0 凭据直接配置 Gmail API，无需上传 credentials.json 文件。
                                <br><small>请在 <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a> 创建 OAuth 2.0 凭据。</small>
                            </div>
                            <div class="mb-3">
                                <label for="gmail-client-id" class="form-label">Client ID</label>
                                <input type="text" class="form-control" id="gmail-client-id" value="{{.config.GmailAPI.ClientID}}" placeholder="OAuth 2.0 Client ID">
                            </div>
                            <div class="mb-3">
                                <label for="gmail-client-secret" class="form-label">Client Secret</label>
                                <input type="password" class="form-control" id="gmail-client-secret" placeholder="OAuth 2.0 Client Secret（留空则不修改）">
                            </div>
                            <div class="mb-3">
                                <label for="gmail-refresh-token" class="form-label">Refresh Token</label>
                                <input type="password" class="form-control" id="gmail-refresh-token" placeholder="OAuth 2.0 Refresh Token（留空则不修改）">
                                <small class="text-muted">您可以使用 <a href="https://developers.google.com/oauthplayground/" target="_blank">OAuth 2.0 Playground</a> 获取 Refresh Token</small>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存 Gmail API 设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- JWT Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-key me-2"></i>JWT 设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="jwt-form">
                            <div class="mb-3">
                                <label for="jwt-expire" class="form-label">Token 有效期（小时）</label>
                                <input type="number" class="form-control" id="jwt-expire" value="{{.config.JWT.ExpireHour}}" min="1" max="720">
                            </div>
                            <div class="mb-3">
                                <label for="jwt-secret" class="form-label">JWT Secret</label>
                                <input type="password" class="form-control" id="jwt-secret" placeholder="输入新的 JWT Secret（留空则不修改）">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存 JWT 设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Captcha Settings -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-shield-check me-2"></i>验证码设置
                        </h5>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="captcha-enabled" {{if .config.Captcha.Enabled}}checked{{end}}>
                            <label class="form-check-label" for="captcha-enabled">启用</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="captcha-form">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                启用后，用户在登录和注册时需要完成滑块验证码验证。这有助于防止恶意机器人攻击。
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存验证码设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Access Control Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-door-open me-2"></i>访问控制设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="access-form">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                关闭登录或注册功能将阻止用户进行相应操作。请谨慎使用此功能。
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0"><i class="bi bi-box-arrow-in-right me-2"></i>登录功能</h6>
                                                <div class="form-check form-switch mb-0">
                                                    <input class="form-check-input" type="checkbox" id="login-enabled" {{if .config.Access.LoginEnabled}}checked{{end}}>
                                                    <label class="form-check-label" for="login-enabled">启用</label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="login-message" class="form-label small text-muted">关闭提示消息（可选）</label>
                                                <input type="text" class="form-control form-control-sm" id="login-message" value="{{.config.Access.LoginMessage}}" placeholder="默认：登录功能已关闭">
                                            </div>
                                            <hr class="my-3">
                                            <div class="mb-2">
                                                <label class="form-label small text-muted"><i class="bi bi-key me-2"></i>允许的登录方式</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="allow-email-login" {{if .config.Access.AllowEmailLogin}}checked{{end}}>
                                                <label class="form-check-label" for="allow-email-login">
                                                    <i class="bi bi-envelope me-1"></i>邮箱登录
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="allow-username-login" {{if .config.Access.AllowUsernameLogin}}checked{{end}}>
                                                <label class="form-check-label" for="allow-username-login">
                                                    <i class="bi bi-person me-1"></i>用户名登录
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0"><i class="bi bi-person-plus me-2"></i>注册功能</h6>
                                                <div class="form-check form-switch mb-0">
                                                    <input class="form-check-input" type="checkbox" id="registration-enabled" {{if .config.Access.RegistrationEnabled}}checked{{end}}>
                                                    <label class="form-check-label" for="registration-enabled">启用</label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="registration-message" class="form-label small text-muted">关闭提示消息（可选）</label>
                                                <input type="text" class="form-control form-control-sm" id="registration-message" value="{{.config.Access.RegistrationMessage}}" placeholder="默认：注册功能已关闭">
                                            </div>
                                            <hr class="my-3">
                                            <div class="mb-2">
                                                <label for="registration-start-uid" class="form-label small text-muted">
                                                    <i class="bi bi-hash me-2"></i>注册起始UID
                                                </label>
                                                <input type="number" class="form-control form-control-sm" id="registration-start-uid" value="{{.config.Access.RegistrationStartUID}}" min="0" placeholder="0 = 自动分配">
                                                <small class="text-muted">设置为0表示自动分配，设置为其他值则从该值开始分配UID</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save me-2"></i>保存访问控制设置
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Custom Settings (Global CSS/HTML, Footer) -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-code-slash me-2"></i>自定义设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="custom-form">
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>安全提示：</strong>以下设置允许注入自定义代码到所有公共页面。请确保只添加可信任的代码，不当配置可能导致安全风险。
                            </div>
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                在此处添加自定义CSS、HTML代码以及底部文字。这些内容将应用到所有公共页面。常见用途：网站统计代码、在线客服、自定义样式等。
                            </div>
                            <div class="mb-3">
                                <label for="global-css" class="form-label">全局 CSS</label>
                                <textarea class="form-control font-monospace" id="global-css" rows="5" placeholder="/* 输入自定义 CSS 样式 */&#10;body { }">{{.config.Custom.GlobalCSS}}</textarea>
                                <small class="text-muted">自定义CSS将注入到所有页面的&lt;head&gt;中</small>
                            </div>
                            <div class="mb-3">
                                <label for="global-html" class="form-label">全局 HTML</label>
                                <textarea class="form-control font-monospace" id="global-html" rows="5" placeholder="<!-- 输入自定义 HTML 代码，如分析脚本 -->&#10;<script>...</script>">{{.config.Custom.GlobalHTML}}</textarea>
                                <small class="text-muted">自定义HTML将注入到所有页面的&lt;body&gt;底部（如统计代码、在线客服等）</small>
                            </div>
                            <div class="mb-3">
                                <label for="footer-text" class="form-label">底部文字</label>
                                <textarea class="form-control" id="footer-text" rows="3" placeholder="© 2024 Your Company. All rights reserved.">{{.config.Custom.FooterText}}</textarea>
                                <small class="text-muted">支持HTML格式，留空则使用默认底部文字</small>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存自定义设置
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-5">
                    <i class="bi display-1 mb-3" id="modal-icon"></i>
                    <h4 class="mb-3" id="modal-title"></h4>
                    <p class="text-muted mb-0" id="modal-message"></p>
                </div>
                <div class="modal-footer justify-content-center border-0 pt-0">
                    <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script>
        let resultModal;
        
        document.addEventListener('DOMContentLoaded', function() {
            resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        });

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        function showModal(type, message) {
            const iconMap = {
                'success': 'bi-check-circle-fill',
                'danger': 'bi-exclamation-circle-fill',
                'warning': 'bi-exclamation-triangle-fill'
            };
            const colorMap = {
                'success': '#28a745',
                'danger': '#dc3545',
                'warning': '#ffc107'
            };
            const titleMap = {
                'success': '保存成功',
                'danger': '保存失败',
                'warning': '警告'
            };
            
            document.getElementById('modal-icon').className = `bi ${iconMap[type]} display-1 mb-3`;
            document.getElementById('modal-icon').style.color = colorMap[type];
            document.getElementById('modal-title').textContent = titleMap[type];
            document.getElementById('modal-message').textContent = message;
            
            resultModal.show();
        }

        // Google OAuth Form
        document.getElementById('google-oauth-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('google-oauth-enabled').checked,
                client_id: document.getElementById('google-client-id').value,
                client_secret: document.getElementById('google-client-secret').value,
                redirect_url: document.getElementById('google-redirect-url').value
            };
            
            try {
                const response = await fetch('/api/admin/settings/google-oauth', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Steam OAuth Form
        document.getElementById('steam-oauth-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('steam-oauth-enabled').checked,
                api_key: document.getElementById('steam-api-key').value,
                redirect_url: document.getElementById('steam-redirect-url').value
            };
            
            try {
                const response = await fetch('/api/admin/settings/steam-oauth', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Discord OAuth Form
        document.getElementById('discord-oauth-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('discord-oauth-enabled').checked,
                client_id: document.getElementById('discord-client-id').value,
                client_secret: document.getElementById('discord-client-secret').value,
                redirect_url: document.getElementById('discord-redirect-url').value
            };
            
            try {
                const response = await fetch('/api/admin/settings/discord-oauth', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Gmail API Form
        document.getElementById('gmail-api-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('gmail-api-enabled').checked,
                sender_email: document.getElementById('gmail-sender').value,
                client_id: document.getElementById('gmail-client-id').value,
                client_secret: document.getElementById('gmail-client-secret').value,
                refresh_token: document.getElementById('gmail-refresh-token').value
            };
            
            try {
                const response = await fetch('/api/admin/settings/gmail-api', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // JWT Form
        document.getElementById('jwt-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                expire_hour: parseInt(document.getElementById('jwt-expire').value),
                secret: document.getElementById('jwt-secret').value
            };
            
            try {
                const response = await fetch('/api/admin/settings/jwt', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Captcha Form
        document.getElementById('captcha-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('captcha-enabled').checked
            };
            
            try {
                const response = await fetch('/api/admin/settings/captcha', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Access Control Form
        document.getElementById('access-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                login_enabled: document.getElementById('login-enabled').checked,
                registration_enabled: document.getElementById('registration-enabled').checked,
                login_message: document.getElementById('login-message').value,
                registration_message: document.getElementById('registration-message').value,
                registration_start_uid: parseInt(document.getElementById('registration-start-uid').value) || 0,
                allow_email_login: document.getElementById('allow-email-login').checked,
                allow_username_login: document.getElementById('allow-username-login').checked
            };
            
            try {
                const response = await fetch('/api/admin/settings/access', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Custom Settings Form
        document.getElementById('custom-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                global_css: document.getElementById('global-css').value,
                global_html: document.getElementById('global-html').value,
                footer_text: document.getElementById('footer-text').value
            };
            
            try {
                const response = await fetch('/api/admin/settings/custom', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });
    </script>
</body>
</html>
