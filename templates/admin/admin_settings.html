<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - Common Login Service 管理后台</title>
    <link href="/static/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/static/vendor/bootstrap-icons/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/admin.css" rel="stylesheet">
</head>
<body>
    <div class="admin-wrapper">
        {{template "admin_sidebar" .}}

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1 class="page-title"><i class="bi bi-gear me-2"></i>系统设置</h1>
            </header>

            <div class="admin-content">
                <div id="alert-container"></div>

                <!-- Website Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-globe me-2"></i>网站设置</h5>
                    </div>
                    <div class="card-body">
                        <form id="site-form">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="site-title" class="form-label">网站标题（默认）</label>
                                        <input type="text" class="form-control" id="site-title" value="{{.config.Site.Title}}" placeholder="输入网站标题">
                                        <small class="text-muted">作为默认标题，当没有对应语言的标题时使用</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="site-description" class="form-label">网站描述</label>
                                        <input type="text" class="form-control" id="site-description" value="{{.config.Site.Description}}" placeholder="输入网站描述">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="site-title-zh" class="form-label">网站标题（中文）</label>
                                        <input type="text" class="form-control" id="site-title-zh" value="{{if .config.Site.TitleI18n}}{{index .config.Site.TitleI18n "zh"}}{{end}}" placeholder="输入中文标题">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="site-title-en" class="form-label">网站标题（英文）</label>
                                        <input type="text" class="form-control" id="site-title-en" value="{{if .config.Site.TitleI18n}}{{index .config.Site.TitleI18n "en"}}{{end}}" placeholder="Enter English title">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="site-logo" class="form-label">Logo URL</label>
                                <input type="text" class="form-control" id="site-logo" value="{{.config.Site.Logo}}" placeholder="输入 Logo 图片 URL（可选）">
                            </div>
                            <div class="mb-3">
                                <label for="site-base-url" class="form-label">站点URL</label>
                                <input type="text" class="form-control" id="site-base-url" value="{{.config.Site.BaseURL}}" placeholder="例如: https://user.yuelk.com">
                                <small class="text-muted">强制设置站点URL，用于生成API地址、邮件链接等。留空则自动从请求中获取。</small>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存网站设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Google OAuth Settings -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-google me-2"></i>Google OAuth 设置
                        </h5>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="google-oauth-enabled" {{if .config.GoogleOAuth.Enabled}}checked{{end}}>
                            <label class="form-check-label" for="google-oauth-enabled">启用</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="google-oauth-form">
                            <div class="mb-3">
                                <label for="google-client-id" class="form-label">Client ID</label>
                                <input type="text" class="form-control" id="google-client-id" value="{{.config.GoogleOAuth.ClientID}}" placeholder="输入 Google OAuth Client ID">
                            </div>
                            <div class="mb-3">
                                <label for="google-client-secret" class="form-label">Client Secret</label>
                                <input type="password" class="form-control" id="google-client-secret" placeholder="输入 Google OAuth Client Secret（留空则不修改）">
                            </div>
                            <div class="mb-3">
                                <label for="google-redirect-url" class="form-label">Redirect URL</label>
                                <input type="text" class="form-control" id="google-redirect-url" value="{{.config.GoogleOAuth.RedirectURL}}" placeholder="例如: http://localhost:8080/api/auth/google/callback">
                            </div>
                            <hr class="my-3">
                            <h6 class="mb-3"><i class="bi bi-link-45deg me-2"></i>{{t .lang "admin.binding_settings"}}</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="google-allow-bind" {{if .config.GoogleOAuth.AllowBind}}checked{{end}}>
                                        <label class="form-check-label" for="google-allow-bind">{{t .lang "admin.allow_bind_google"}}</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="google-allow-unbind" {{if .config.GoogleOAuth.AllowUnbind}}checked{{end}}>
                                        <label class="form-check-label" for="google-allow-unbind">{{t .lang "admin.allow_unbind_google"}}</label>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted d-block mb-3">{{t .lang "admin.binding_hint_google"}}</small>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存 Google OAuth 设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Steam OAuth Settings -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-steam me-2"></i>Steam 登录设置
                        </h5>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="steam-oauth-enabled" {{if .config.SteamOAuth.Enabled}}checked{{end}}>
                            <label class="form-check-label" for="steam-oauth-enabled">启用</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="steam-oauth-form">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                Steam 使用 OpenID 2.0 协议进行身份验证。您需要在 <a href="https://steamcommunity.com/dev/apikey" target="_blank">Steam API Key</a> 页面获取 API Key。
                            </div>
                            <div class="mb-3">
                                <label for="steam-api-key" class="form-label">Steam API Key</label>
                                <input type="password" class="form-control" id="steam-api-key" placeholder="输入 Steam API Key（留空则不修改）">
                            </div>
                            <div class="mb-3">
                                <label for="steam-redirect-url" class="form-label">Redirect URL</label>
                                <input type="text" class="form-control" id="steam-redirect-url" value="{{.config.SteamOAuth.RedirectURL}}" placeholder="例如: http://localhost:8080/api/auth/steam/callback">
                            </div>
                            <hr class="my-3">
                            <h6 class="mb-3"><i class="bi bi-link-45deg me-2"></i>{{t .lang "admin.binding_settings"}}</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="steam-allow-bind" {{if .config.SteamOAuth.AllowBind}}checked{{end}}>
                                        <label class="form-check-label" for="steam-allow-bind">{{t .lang "admin.allow_bind_steam"}}</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="steam-allow-unbind" {{if .config.SteamOAuth.AllowUnbind}}checked{{end}}>
                                        <label class="form-check-label" for="steam-allow-unbind">{{t .lang "admin.allow_unbind_steam"}}</label>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted d-block mb-3">{{t .lang "admin.binding_hint_steam"}}</small>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存 Steam 登录设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Discord OAuth Settings -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-discord me-2"></i>Discord OAuth 设置
                        </h5>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="discord-oauth-enabled" {{if .config.DiscordOAuth.Enabled}}checked{{end}}>
                            <label class="form-check-label" for="discord-oauth-enabled">启用</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="discord-oauth-form">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                您可以在 <a href="https://discord.com/developers/applications" target="_blank">Discord Developer Portal</a> 创建应用并获取 OAuth2 凭据。
                            </div>
                            <div class="mb-3">
                                <label for="discord-client-id" class="form-label">Client ID</label>
                                <input type="text" class="form-control" id="discord-client-id" value="{{.config.DiscordOAuth.ClientID}}" placeholder="输入 Discord OAuth Client ID">
                            </div>
                            <div class="mb-3">
                                <label for="discord-client-secret" class="form-label">Client Secret</label>
                                <input type="password" class="form-control" id="discord-client-secret" placeholder="输入 Discord OAuth Client Secret（留空则不修改）">
                            </div>
                            <div class="mb-3">
                                <label for="discord-redirect-url" class="form-label">Redirect URL</label>
                                <input type="text" class="form-control" id="discord-redirect-url" value="{{.config.DiscordOAuth.RedirectURL}}" placeholder="例如: http://localhost:8080/api/auth/discord/callback">
                            </div>
                            <hr class="my-3">
                            <h6 class="mb-3"><i class="bi bi-link-45deg me-2"></i>{{t .lang "admin.binding_settings"}}</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="discord-allow-bind" {{if .config.DiscordOAuth.AllowBind}}checked{{end}}>
                                        <label class="form-check-label" for="discord-allow-bind">{{t .lang "admin.allow_bind_discord"}}</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="discord-allow-unbind" {{if .config.DiscordOAuth.AllowUnbind}}checked{{end}}>
                                        <label class="form-check-label" for="discord-allow-unbind">{{t .lang "admin.allow_unbind_discord"}}</label>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted d-block mb-3">{{t .lang "admin.binding_hint_discord"}}</small>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存 Discord OAuth 设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Email Service Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-envelope me-2"></i>邮件服务设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Email Provider Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">选择邮件服务提供商</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="email-provider" id="email-provider-gmail" value="gmail_api" {{if eq .config.Email.Provider "gmail_api"}}checked{{end}}>
                                <label class="btn btn-outline-primary" for="email-provider-gmail">
                                    <i class="bi bi-google me-2"></i>Gmail API
                                </label>
                                <input type="radio" class="btn-check" name="email-provider" id="email-provider-smtp" value="smtp" {{if eq .config.Email.Provider "smtp"}}checked{{end}}>
                                <label class="btn btn-outline-primary" for="email-provider-smtp">
                                    <i class="bi bi-server me-2"></i>SMTP
                                </label>
                            </div>
                            <small class="text-muted d-block mt-2">选择后请点击下方"保存邮件服务提供商"按钮</small>
                            <button type="button" class="btn btn-sm btn-primary mt-2" id="save-email-provider-btn">
                                <i class="bi bi-save me-2"></i>保存邮件服务提供商
                            </button>
                        </div>

                        <hr class="my-4">

                        <!-- Gmail API Settings Panel -->
                        <div id="gmail-api-panel" class="{{if eq .config.Email.Provider "smtp"}}d-none{{end}}">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0"><i class="bi bi-google me-2"></i>Gmail API 设置</h6>
                                <div class="form-check form-switch mb-0">
                                    <input class="form-check-input" type="checkbox" id="gmail-api-enabled" {{if .config.GmailAPI.Enabled}}checked{{end}}>
                                    <label class="form-check-label" for="gmail-api-enabled">启用</label>
                                </div>
                            </div>
                            <form id="gmail-api-form">
                                <div class="mb-3">
                                    <label for="gmail-sender" class="form-label">发送邮箱</label>
                                    <input type="email" class="form-control" id="gmail-sender" value="{{.config.GmailAPI.SenderEmail}}" placeholder="用于发送邮件的 Gmail 地址">
                                </div>
                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-info-circle me-2"></i>
                                    您可以通过 OAuth 2.0 凭据直接配置 Gmail API。
                                    <br><small>请在 <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a> 创建 OAuth 2.0 凭据。</small>
                                </div>
                                <div class="mb-3">
                                    <label for="gmail-client-id" class="form-label">Client ID</label>
                                    <input type="text" class="form-control" id="gmail-client-id" value="{{.config.GmailAPI.ClientID}}" placeholder="OAuth 2.0 Client ID">
                                </div>
                                <div class="mb-3">
                                    <label for="gmail-client-secret" class="form-label">Client Secret</label>
                                    <input type="password" class="form-control" id="gmail-client-secret" placeholder="OAuth 2.0 Client Secret（留空则不修改）">
                                </div>
                                <div class="mb-3">
                                    <label for="gmail-refresh-token" class="form-label">Refresh Token</label>
                                    <input type="password" class="form-control" id="gmail-refresh-token" placeholder="OAuth 2.0 Refresh Token（留空则不修改）">
                                    <small class="text-muted">您可以使用 <a href="https://developers.google.com/oauthplayground/" target="_blank">OAuth 2.0 Playground</a> 获取 Refresh Token</small>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save me-2"></i>保存 Gmail API 设置
                                </button>
                            </form>
                        </div>

                        <!-- SMTP Settings Panel -->
                        <div id="smtp-panel" class="{{if ne .config.Email.Provider "smtp"}}d-none{{end}}">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0"><i class="bi bi-server me-2"></i>SMTP 设置</h6>
                                <div class="form-check form-switch mb-0">
                                    <input class="form-check-input" type="checkbox" id="smtp-enabled" {{if .config.SMTP.Enabled}}checked{{end}}>
                                    <label class="form-check-label" for="smtp-enabled">启用</label>
                                </div>
                            </div>
                            <form id="smtp-form">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="smtp-host" class="form-label">SMTP 服务器</label>
                                            <input type="text" class="form-control" id="smtp-host" value="{{.config.SMTP.Host}}" placeholder="例如: smtp.gmail.com">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="smtp-port" class="form-label">端口</label>
                                            <input type="number" class="form-control" id="smtp-port" value="{{.config.SMTP.Port}}" placeholder="587">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="smtp-username" class="form-label">用户名</label>
                                            <input type="text" class="form-control" id="smtp-username" value="{{.config.SMTP.Username}}" placeholder="SMTP 登录用户名">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="smtp-password" class="form-label">密码</label>
                                            <input type="password" class="form-control" id="smtp-password" placeholder="SMTP 密码（留空则不修改）">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="smtp-sender-email" class="form-label">发送邮箱地址</label>
                                            <input type="email" class="form-control" id="smtp-sender-email" value="{{.config.SMTP.SenderEmail}}" placeholder="noreply@example.com">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="smtp-sender-name" class="form-label">发送者名称</label>
                                            <input type="text" class="form-control" id="smtp-sender-name" value="{{.config.SMTP.SenderName}}" placeholder="Common Login Service">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="smtp-use-tls" {{if .config.SMTP.UseTLS}}checked{{end}}>
                                                <label class="form-check-label" for="smtp-use-tls">
                                                    使用 TLS (STARTTLS, 端口 587)
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="smtp-use-ssl" {{if .config.SMTP.UseSSL}}checked{{end}}>
                                                <label class="form-check-label" for="smtp-use-ssl">
                                                    使用 SSL (隐式 SSL, 端口 465)
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>常用 SMTP 服务器配置:</strong><br>
                                    <small>
                                    • Gmail: smtp.gmail.com:587 (TLS) - 需要应用专用密码<br>
                                    • Outlook: smtp.office365.com:587 (TLS)<br>
                                    • QQ邮箱: smtp.qq.com:465 (SSL) 或 587 (TLS)<br>
                                    • 163邮箱: smtp.163.com:465 (SSL) 或 25
                                    </small>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save me-2"></i>保存 SMTP 设置
                                </button>
                            </form>
                        </div>

                        <hr class="my-4">
                        <h6 class="mb-3"><i class="bi bi-send me-2"></i>发送测试邮件</h6>
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            发送测试邮件前，请先保存上方的邮件服务设置。
                        </div>
                        <form id="email-test-form">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="email-test-address" class="form-label">测试收件邮箱</label>
                                        <input type="email" class="form-control" id="email-test-address" placeholder="输入接收测试邮件的邮箱地址">
                                    </div>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <div class="mb-3 w-100">
                                        <button type="submit" class="btn btn-success w-100" id="email-test-btn">
                                            <i class="bi bi-send me-2"></i>发送测试邮件
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Test Result Display -->
                        <div id="email-test-result" class="d-none">
                            <div class="card bg-light">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-terminal me-2"></i>邮件服务返回内容</h6>
                                </div>
                                <div class="card-body">
                                    <div id="email-test-status" class="mb-3"></div>
                                    <div id="email-test-response">
                                        <pre class="mb-0 p-3 bg-dark text-light rounded" style="max-height: 300px; overflow-y: auto;"><code id="email-test-response-code"></code></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JWT Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-key me-2"></i>JWT 设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="jwt-form">
                            <div class="mb-3">
                                <label for="jwt-expire" class="form-label">Token 有效期（小时）</label>
                                <input type="number" class="form-control" id="jwt-expire" value="{{.config.JWT.ExpireHour}}" min="1" max="720">
                            </div>
                            <div class="mb-3">
                                <label for="jwt-secret" class="form-label">JWT Secret</label>
                                <input type="password" class="form-control" id="jwt-secret" placeholder="输入新的 JWT Secret（留空则不修改）">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存 JWT 设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Captcha Settings -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-shield-check me-2"></i>验证码设置
                        </h5>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="captcha-enabled" {{if .config.Captcha.Enabled}}checked{{end}}>
                            <label class="form-check-label" for="captcha-enabled">启用</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="captcha-form">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                启用后，用户在登录和注册时需要完成滑块验证码验证。这有助于防止恶意机器人攻击。
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存验证码设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Access Control Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-door-open me-2"></i>访问控制设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="access-form">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                关闭登录或注册功能将阻止用户进行相应操作。请谨慎使用此功能。
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0"><i class="bi bi-box-arrow-in-right me-2"></i>登录功能</h6>
                                                <div class="form-check form-switch mb-0">
                                                    <input class="form-check-input" type="checkbox" id="login-enabled" {{if .config.Access.LoginEnabled}}checked{{end}}>
                                                    <label class="form-check-label" for="login-enabled">启用</label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="login-message" class="form-label small text-muted">关闭提示消息（可选）</label>
                                                <input type="text" class="form-control form-control-sm" id="login-message" value="{{.config.Access.LoginMessage}}" placeholder="默认：登录功能已关闭">
                                            </div>
                                            <hr class="my-3">
                                            <div class="mb-2">
                                                <label class="form-label small text-muted"><i class="bi bi-key me-2"></i>允许的登录方式</label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="allow-email-login" {{if .config.Access.AllowEmailLogin}}checked{{end}}>
                                                <label class="form-check-label" for="allow-email-login">
                                                    <i class="bi bi-envelope me-1"></i>邮箱登录
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="allow-username-login" {{if .config.Access.AllowUsernameLogin}}checked{{end}}>
                                                <label class="form-check-label" for="allow-username-login">
                                                    <i class="bi bi-person me-1"></i>用户名登录
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0"><i class="bi bi-person-plus me-2"></i>注册功能</h6>
                                                <div class="form-check form-switch mb-0">
                                                    <input class="form-check-input" type="checkbox" id="registration-enabled" {{if .config.Access.RegistrationEnabled}}checked{{end}}>
                                                    <label class="form-check-label" for="registration-enabled">启用</label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="registration-message" class="form-label small text-muted">关闭提示消息（可选）</label>
                                                <input type="text" class="form-control form-control-sm" id="registration-message" value="{{.config.Access.RegistrationMessage}}" placeholder="默认：注册功能已关闭">
                                            </div>
                                            <hr class="my-3">
                                            <div class="mb-2">
                                                <label for="registration-start-uid" class="form-label small text-muted">
                                                    <i class="bi bi-hash me-2"></i>注册起始UID
                                                </label>
                                                <input type="number" class="form-control form-control-sm" id="registration-start-uid" value="{{.config.Access.RegistrationStartUID}}" min="0" placeholder="0 = 自动分配">
                                                <small class="text-muted">设置为0表示自动分配，设置为其他值则从该值开始分配UID</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Email Verification Settings -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0"><i class="bi bi-envelope-check me-2"></i>强制邮箱验证</h6>
                                                <div class="form-check form-switch mb-0">
                                                    <input class="form-check-input" type="checkbox" id="require-email-verification" {{if .config.Access.RequireEmailVerification}}checked{{end}}>
                                                    <label class="form-check-label" for="require-email-verification">启用</label>
                                                </div>
                                            </div>
                                            <div class="alert alert-info mb-0">
                                                <i class="bi bi-info-circle me-2"></i>
                                                启用后，未验证邮箱的用户将被重定向到邮箱验证页面。用户可以在该页面设置或更换邮箱，每60秒只能发送1次验证邮件，需要验证码。
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Password Complexity Settings -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="mb-3"><i class="bi bi-key me-2"></i>密码复杂度要求</h6>
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label for="password-min-length" class="form-label">最小长度</label>
                                                        <input type="number" class="form-control" id="password-min-length" value="{{if .config.Access.PasswordMinLength}}{{.config.Access.PasswordMinLength}}{{else}}6{{end}}" min="1" max="128">
                                                    </div>
                                                </div>
                                                <div class="col-md-9">
                                                    <label class="form-label">必须包含</label>
                                                    <div class="d-flex flex-wrap gap-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="password-require-letter" {{if .config.Access.PasswordRequireLetter}}checked{{end}}>
                                                            <label class="form-check-label" for="password-require-letter">
                                                                <i class="bi bi-alphabet me-1"></i>字母（不区分大小写）
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="password-require-number" {{if .config.Access.PasswordRequireNumber}}checked{{end}}>
                                                            <label class="form-check-label" for="password-require-number">
                                                                <i class="bi bi-123 me-1"></i>数字
                                                            </label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="password-require-special" {{if .config.Access.PasswordRequireSpecial}}checked{{end}}>
                                                            <label class="form-check-label" for="password-require-special">
                                                                <i class="bi bi-hash me-1"></i>特殊字符
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save me-2"></i>保存访问控制设置
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Registration Rate Limiting Settings -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-person-plus me-2"></i>注册限制设置
                        </h5>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="registration-protection-enabled" {{if .config.RegistrationProtection.Enabled}}checked{{end}}>
                            <label class="form-check-label" for="registration-protection-enabled">启用</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="registration-protection-form">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                注册限制功能可以防止恶意批量注册。当同一IP地址在指定时间窗口内注册次数超过阈值时，该IP将被临时禁止注册。
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="max-registrations" class="form-label">最大注册次数</label>
                                        <input type="number" class="form-control" id="max-registrations" value="{{.config.RegistrationProtection.MaxRegistrations}}" min="1" max="100">
                                        <small class="text-muted">同一IP在时间窗口内允许的最大注册次数</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="registration-window-seconds" class="form-label">时间窗口（秒）</label>
                                        <input type="number" class="form-control" id="registration-window-seconds" value="{{.config.RegistrationProtection.WindowSeconds}}" min="1">
                                        <small class="text-muted">统计注册次数的时间窗口（例如：3600秒=1小时）</small>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存注册限制设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Password Reset Rate Limiting Settings -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-envelope-exclamation me-2"></i>密码重置限制设置
                        </h5>
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="password-reset-protection-enabled" {{if .config.PasswordResetProtection.Enabled}}checked{{end}}>
                            <label class="form-check-label" for="password-reset-protection-enabled">启用</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="password-reset-protection-form">
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                密码重置限制功能可以防止恶意请求密码重置邮件。当同一IP地址在指定时间窗口内请求次数超过阈值时，该IP将被临时禁止发送请求。
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="max-reset-requests" class="form-label">最大请求次数</label>
                                        <input type="number" class="form-control" id="max-reset-requests" value="{{.config.PasswordResetProtection.MaxRequests}}" min="1" max="100">
                                        <small class="text-muted">同一IP在时间窗口内允许的最大密码重置请求次数</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="reset-window-seconds" class="form-label">时间窗口（秒）</label>
                                        <input type="number" class="form-control" id="reset-window-seconds" value="{{.config.PasswordResetProtection.WindowSeconds}}" min="1">
                                        <small class="text-muted">统计请求次数的时间窗口（例如：300秒=5分钟）</small>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存密码重置限制设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Appearance Settings (Dark Mode) -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-palette me-2"></i>外观设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="appearance-form">
                            <div class="mb-3">
                                <label for="dark-mode" class="form-label">暗色模式</label>
                                <select class="form-select" id="dark-mode">
                                    <option value="system" {{if eq .config.Site.DarkMode "system"}}selected{{end}}>跟随系统</option>
                                    <option value="dark" {{if eq .config.Site.DarkMode "dark"}}selected{{end}}>默认暗色</option>
                                    <option value="light" {{if eq .config.Site.DarkMode "light"}}selected{{end}}>默认亮色</option>
                                </select>
                                <small class="text-muted">
                                    <ul class="mb-0 ps-3 mt-2">
                                        <li><strong>跟随系统</strong>：用户可以手动切换暗色/亮色模式，默认跟随浏览器/系统设置</li>
                                        <li><strong>默认暗色</strong>：强制使用暗色模式，隐藏切换按钮</li>
                                        <li><strong>默认亮色</strong>：强制使用亮色模式，隐藏切换按钮</li>
                                    </ul>
                                </small>
                            </div>
                            <hr class="my-3">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-house-door me-2"></i>首页重定向到个人中心</h6>
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" type="checkbox" id="redirect-home-to-profile" {{if .config.Site.RedirectHomeToProfile}}checked{{end}}>
                                        <label class="form-check-label" for="redirect-home-to-profile">启用</label>
                                    </div>
                                </div>
                                <small class="text-muted">启用后，已登录用户访问首页时将自动跳转到个人中心页面</small>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存外观设置
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Custom Settings (Global CSS/HTML, Footer) -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-code-slash me-2"></i>自定义设置
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="custom-form">
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>安全提示：</strong>以下设置允许注入自定义代码到所有公共页面。请确保只添加可信任的代码，不当配置可能导致安全风险。
                            </div>
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle me-2"></i>
                                在此处添加自定义CSS、HTML代码以及底部文字。这些内容将应用到所有公共页面。常见用途：网站统计代码、在线客服、自定义样式等。
                            </div>
                            <div class="mb-3">
                                <label for="global-css" class="form-label">全局 CSS</label>
                                <textarea class="form-control font-monospace" id="global-css" rows="5" placeholder="/* 输入自定义 CSS 样式 */&#10;body { }">{{.config.Custom.GlobalCSS}}</textarea>
                                <small class="text-muted">自定义CSS将注入到所有页面的&lt;head&gt;中</small>
                            </div>
                            <div class="mb-3">
                                <label for="global-html" class="form-label">全局 HTML</label>
                                <textarea class="form-control font-monospace" id="global-html" rows="5" placeholder="<!-- 输入自定义 HTML 代码，如分析脚本 -->&#10;<script>...</script>">{{.config.Custom.GlobalHTML}}</textarea>
                                <small class="text-muted">自定义HTML将注入到所有页面的&lt;body&gt;底部（如统计代码、在线客服等）</small>
                            </div>
                            <div class="mb-3">
                                <label for="footer-text" class="form-label">底部文字</label>
                                <textarea class="form-control" id="footer-text" rows="3" placeholder="© 2024 Your Company. All rights reserved.">{{.config.Custom.FooterText}}</textarea>
                                <small class="text-muted">支持HTML格式，留空则使用默认底部文字</small>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-2"></i>保存自定义设置
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-5">
                    <i class="bi display-1 mb-3" id="modal-icon"></i>
                    <h4 class="mb-3" id="modal-title"></h4>
                    <p class="text-muted mb-0" id="modal-message"></p>
                </div>
                <div class="modal-footer justify-content-center border-0 pt-0">
                    <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script>
        let resultModal;
        
        document.addEventListener('DOMContentLoaded', function() {
            resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        });

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        function showModal(type, message) {
            const iconMap = {
                'success': 'bi-check-circle-fill',
                'danger': 'bi-exclamation-circle-fill',
                'warning': 'bi-exclamation-triangle-fill'
            };
            const colorMap = {
                'success': '#28a745',
                'danger': '#dc3545',
                'warning': '#ffc107'
            };
            const titleMap = {
                'success': '保存成功',
                'danger': '保存失败',
                'warning': '警告'
            };
            
            document.getElementById('modal-icon').className = `bi ${iconMap[type]} display-1 mb-3`;
            document.getElementById('modal-icon').style.color = colorMap[type];
            document.getElementById('modal-title').textContent = titleMap[type];
            document.getElementById('modal-message').textContent = message;
            
            resultModal.show();
        }

        // Site Settings Form
        document.getElementById('site-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const titleI18n = {};
            const titleZh = document.getElementById('site-title-zh').value.trim();
            const titleEn = document.getElementById('site-title-en').value.trim();
            if (titleZh) titleI18n['zh'] = titleZh;
            if (titleEn) titleI18n['en'] = titleEn;
            
            const data = {
                title: document.getElementById('site-title').value,
                title_i18n: Object.keys(titleI18n).length > 0 ? titleI18n : null,
                description: document.getElementById('site-description').value,
                logo: document.getElementById('site-logo').value,
                base_url: document.getElementById('site-base-url').value
            };
            
            try {
                const response = await fetch('/api/admin/settings/site', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Google OAuth Form
        document.getElementById('google-oauth-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('google-oauth-enabled').checked,
                client_id: document.getElementById('google-client-id').value,
                client_secret: document.getElementById('google-client-secret').value,
                redirect_url: document.getElementById('google-redirect-url').value,
                allow_bind: document.getElementById('google-allow-bind').checked,
                allow_unbind: document.getElementById('google-allow-unbind').checked
            };
            
            try {
                const response = await fetch('/api/admin/settings/google-oauth', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Steam OAuth Form
        document.getElementById('steam-oauth-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('steam-oauth-enabled').checked,
                api_key: document.getElementById('steam-api-key').value,
                redirect_url: document.getElementById('steam-redirect-url').value,
                allow_bind: document.getElementById('steam-allow-bind').checked,
                allow_unbind: document.getElementById('steam-allow-unbind').checked
            };
            
            try {
                const response = await fetch('/api/admin/settings/steam-oauth', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Discord OAuth Form
        document.getElementById('discord-oauth-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('discord-oauth-enabled').checked,
                client_id: document.getElementById('discord-client-id').value,
                client_secret: document.getElementById('discord-client-secret').value,
                redirect_url: document.getElementById('discord-redirect-url').value,
                allow_bind: document.getElementById('discord-allow-bind').checked,
                allow_unbind: document.getElementById('discord-allow-unbind').checked
            };
            
            try {
                const response = await fetch('/api/admin/settings/discord-oauth', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Gmail API Form
        document.getElementById('gmail-api-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('gmail-api-enabled').checked,
                sender_email: document.getElementById('gmail-sender').value,
                client_id: document.getElementById('gmail-client-id').value,
                client_secret: document.getElementById('gmail-client-secret').value,
                refresh_token: document.getElementById('gmail-refresh-token').value
            };
            
            try {
                const response = await fetch('/api/admin/settings/gmail-api', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // SMTP Form
        document.getElementById('smtp-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('smtp-enabled').checked,
                host: document.getElementById('smtp-host').value,
                port: parseInt(document.getElementById('smtp-port').value) || 587,
                username: document.getElementById('smtp-username').value,
                password: document.getElementById('smtp-password').value,
                sender_email: document.getElementById('smtp-sender-email').value,
                sender_name: document.getElementById('smtp-sender-name').value,
                use_tls: document.getElementById('smtp-use-tls').checked,
                use_ssl: document.getElementById('smtp-use-ssl').checked
            };
            
            try {
                const response = await fetch('/api/admin/settings/smtp', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Email Provider Selection
        document.querySelectorAll('input[name="email-provider"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const provider = this.value;
                if (provider === 'gmail_api') {
                    document.getElementById('gmail-api-panel').classList.remove('d-none');
                    document.getElementById('smtp-panel').classList.add('d-none');
                } else {
                    document.getElementById('gmail-api-panel').classList.add('d-none');
                    document.getElementById('smtp-panel').classList.remove('d-none');
                }
            });
        });

        // Save Email Provider Button
        document.getElementById('save-email-provider-btn').addEventListener('click', async function() {
            const provider = document.querySelector('input[name="email-provider"]:checked').value;
            
            try {
                const response = await fetch('/api/admin/settings/email-provider', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: provider })
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Email Test Form (unified for both Gmail API and SMTP)
        document.getElementById('email-test-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const testEmail = document.getElementById('email-test-address').value;
            if (!testEmail) {
                showModal('warning', '请输入测试收件邮箱地址');
                return;
            }
            
            const testBtn = document.getElementById('email-test-btn');
            const resultDiv = document.getElementById('email-test-result');
            const statusDiv = document.getElementById('email-test-status');
            const responseCode = document.getElementById('email-test-response-code');
            
            // Disable button and show loading state
            testBtn.disabled = true;
            testBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>发送中...';
            
            try {
                const response = await fetch('/api/admin/settings/gmail-api/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to_email: testEmail })
                });
                
                const result = await response.json();
                
                // Show result section
                resultDiv.classList.remove('d-none');
                
                // Helper function to escape HTML to prevent XSS
                function escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
                
                // Update status with provider info
                const providerLabel = result.provider === 'smtp' ? 'SMTP' : 'Gmail API';
                if (result.success) {
                    statusDiv.innerHTML = '<div class="alert alert-success mb-0"><i class="bi bi-check-circle me-2"></i>' + escapeHtml(result.message) + ' <span class="badge bg-primary">' + providerLabel + '</span></div>';
                } else {
                    let errorHtml = '<div class="alert alert-danger mb-0"><i class="bi bi-x-circle me-2"></i>' + escapeHtml(result.message);
                    if (result.error) {
                        errorHtml += '<br><small class="text-muted">错误详情: ' + escapeHtml(result.error) + '</small>';
                    }
                    errorHtml += ' <span class="badge bg-secondary">' + providerLabel + '</span></div>';
                    statusDiv.innerHTML = errorHtml;
                }
                
                // Format and display API response
                const apiResponse = {
                    success: result.success,
                    message: result.message,
                    provider: result.provider,
                    error: result.error || null,
                    api_response: result.api_response || {}
                };
                responseCode.textContent = JSON.stringify(apiResponse, null, 2);
                
            } catch (error) {
                resultDiv.classList.remove('d-none');
                statusDiv.innerHTML = '<div class="alert alert-danger mb-0"><i class="bi bi-x-circle me-2"></i>网络错误，请稍后重试</div>';
                responseCode.textContent = JSON.stringify({ error: error.message }, null, 2);
            } finally {
                // Reset button state
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="bi bi-send me-2"></i>发送测试邮件';
            }
        });

        // JWT Form
        document.getElementById('jwt-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                expire_hour: parseInt(document.getElementById('jwt-expire').value),
                secret: document.getElementById('jwt-secret').value
            };
            
            try {
                const response = await fetch('/api/admin/settings/jwt', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Captcha Form
        document.getElementById('captcha-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('captcha-enabled').checked
            };
            
            try {
                const response = await fetch('/api/admin/settings/captcha', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Access Control Form
        document.getElementById('access-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                login_enabled: document.getElementById('login-enabled').checked,
                registration_enabled: document.getElementById('registration-enabled').checked,
                login_message: document.getElementById('login-message').value,
                registration_message: document.getElementById('registration-message').value,
                registration_start_uid: parseInt(document.getElementById('registration-start-uid').value) || 0,
                allow_email_login: document.getElementById('allow-email-login').checked,
                allow_username_login: document.getElementById('allow-username-login').checked,
                require_email_verification: document.getElementById('require-email-verification').checked,
                password_min_length: parseInt(document.getElementById('password-min-length').value) || 6,
                password_require_letter: document.getElementById('password-require-letter').checked,
                password_require_number: document.getElementById('password-require-number').checked,
                password_require_special: document.getElementById('password-require-special').checked
            };
            
            try {
                const response = await fetch('/api/admin/settings/access', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Registration Protection Form
        document.getElementById('registration-protection-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('registration-protection-enabled').checked,
                max_registrations: parseInt(document.getElementById('max-registrations').value) || 3,
                window_seconds: parseInt(document.getElementById('registration-window-seconds').value) || 3600
            };
            
            try {
                const response = await fetch('/api/admin/settings/registration-protection', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Password Reset Protection Form
        document.getElementById('password-reset-protection-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                enabled: document.getElementById('password-reset-protection-enabled').checked,
                max_requests: parseInt(document.getElementById('max-reset-requests').value) || 2,
                window_seconds: parseInt(document.getElementById('reset-window-seconds').value) || 300
            };
            
            try {
                const response = await fetch('/api/admin/settings/password-reset-protection', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Appearance Settings Form (Dark Mode, Home Redirect)
        document.getElementById('appearance-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                dark_mode: document.getElementById('dark-mode').value,
                redirect_home_to_profile: document.getElementById('redirect-home-to-profile').checked
            };
            
            try {
                const response = await fetch('/api/admin/settings/site', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });

        // Custom Settings Form
        document.getElementById('custom-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                global_css: document.getElementById('global-css').value,
                global_html: document.getElementById('global-html').value,
                footer_text: document.getElementById('footer-text').value
            };
            
            try {
                const response = await fetch('/api/admin/settings/custom', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                showModal(result.success ? 'success' : 'danger', result.message);
            } catch (error) {
                showModal('danger', '网络错误，请稍后重试');
            }
        });
    </script>
</body>
</html>
