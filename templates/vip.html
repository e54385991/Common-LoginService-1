<!DOCTYPE html>
<html lang="{{.lang}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{if .siteTitle}}{{.siteTitle}}{{else}}{{t .lang "app.name"}}{{end}} - {{t .lang "vip.page_title"}}</title>
    {{template "darkmode" .}}
    {{template "head_assets" .}}
    <style>
        /* Hero Section - Enhanced Modern Design */
        .vip-hero-enhanced {
            background: linear-gradient(135deg, #6366F1 0%, #EC4899 100%);
            color: white;
            padding: 100px 0;
            position: relative;
            overflow: hidden;
        }
        .vip-hero-enhanced::before {
            content: '';
            position: absolute;
            top: -40px;
            right: -40px;
            width: 320px;
            height: 320px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            filter: blur(60px);
        }
        .vip-hero-enhanced::after {
            content: '';
            position: absolute;
            bottom: -40px;
            left: -40px;
            width: 320px;
            height: 320px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            filter: blur(60px);
        }
        .vip-hero-enhanced .container {
            position: relative;
            z-index: 1;
        }
        .vip-hero-enhanced h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 800;
            background: linear-gradient(to right, #ffffff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
        }
        .balance-card {
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .balance-amount {
            font-size: 2.5rem;
            font-weight: 800;
        }
        .vip-badge {
            display: inline-flex;
            align-items: center;
            background: rgba(255,255,255,0.25);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 600;
        }
        .vip-section {
            padding: 80px 0;
            background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
        }
        /* Dark mode - VIP Section */
        [data-theme="dark"] .vip-section {
            background: linear-gradient(180deg, #1a1a1a 0%, #121212 100%);
        }
        .vip-card {
            border-radius: 16px;
            background: white;
            overflow: hidden;
            transition: all 0.3s ease;
            height: 100%;
            border: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-top: 4px solid transparent;
        }
        /* Dark mode - VIP Card */
        [data-theme="dark"] .vip-card {
            background: #1e1e1e;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .vip-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        [data-theme="dark"] .vip-card:hover {
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        .vip-card.popular {
            transform: scale(1.03);
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
            z-index: 10;
        }
        .vip-card.popular:hover {
            transform: scale(1.03) translateY(-8px);
            box-shadow: 0 25px 60px rgba(0,0,0,0.2);
        }
        .vip-card.selected {
            box-shadow: 0 0 0 4px #6366F1, 0 25px 60px rgba(0,0,0,0.2);
        }
        .vip-popular-badge {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            padding: 12px;
            text-align: center;
            color: #F59E0B;
            font-weight: 600;
            font-size: 0.9rem;
        }
        [data-theme="dark"] .vip-popular-badge {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.08) 100%);
        }
        .vip-header {
            padding: 32px 24px;
            text-align: center;
            position: relative;
        }
        .vip-icon-wrapper {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 28px;
        }
        .vip-popular {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.3);
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 700;
            backdrop-filter: blur(5px);
        }
        .vip-icon {
            font-size: 64px;
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }
        .vip-name {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 16px;
            letter-spacing: 0.5px;
        }
        .vip-price {
            font-size: 2.5rem;
            font-weight: 900;
        }
        .vip-price small {
            font-size: 1rem;
            font-weight: 500;
            opacity: 0.7;
        }
        .vip-body {
            padding: 24px;
            background: white;
        }
        /* Dark mode - VIP Body */
        [data-theme="dark"] .vip-body {
            background: #1e1e1e;
        }
        .vip-features {
            list-style: none;
            padding: 0;
            margin: 0 0 24px 0;
        }
        .vip-features li {
            display: flex;
            align-items: center;
            padding: 8px 0;
            font-size: 0.95rem;
        }
        .vip-features li i {
            margin-right: 12px;
            font-size: 1rem;
        }
        .vip-features li.enabled i {
            color: #22C55E;
        }
        .vip-features li.disabled {
            color: #9CA3AF;
        }
        .vip-features li.disabled i {
            color: #EF4444;
        }
        [data-theme="dark"] .vip-features li.disabled {
            color: #6B7280;
        }
        .vip-description {
            color: #666;
            margin-bottom: 24px;
            min-height: 50px;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        /* Dark mode - VIP Description */
        [data-theme="dark"] .vip-description {
            color: #a0a0a0;
        }
        .vip-description > *:first-child {
            margin-top: 0 !important;
        }
        .vip-duration {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 24px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 10px;
            display: inline-block;
        }
        /* Dark mode - VIP Duration */
        [data-theme="dark"] .vip-duration {
            background: #2a2a2a;
            color: #a0a0a0;
        }
        .vip-select-btn {
            width: 100%;
            padding: 14px;
            font-weight: 700;
            border-radius: 12px;
            transition: all 0.3s;
        }
        .vip-select-btn:hover:not(:disabled) {
            transform: scale(1.02);
        }
        .payment-modal .modal-content {
            border-radius: 20px;
            overflow: hidden;
            border: none;
        }
        /* Dark mode - Payment Modal */
        [data-theme="dark"] .payment-modal .modal-content {
            background: #1e1e1e;
        }
        .payment-modal .modal-header {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: white;
            border: none;
            padding: 24px 28px;
        }
        .payment-modal .modal-body {
            padding: 32px;
        }
        .payment-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }
        /* Dark mode - Payment Info */
        [data-theme="dark"] .payment-info {
            background: linear-gradient(135deg, #2a2a2a 0%, #252525 100%);
        }
        .payment-methods {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }
        .payment-method {
            flex: 1;
            border: 2px solid #dee2e6;
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        /* Dark mode - Payment Method */
        [data-theme="dark"] .payment-method {
            border-color: #444;
            background: #2a2a2a;
        }
        .payment-method:hover, .payment-method.selected {
            border-color: #ffd700;
        }
        .payment-method.selected {
            background: linear-gradient(135deg, #fffacd 0%, #fff8dc 100%);
        }
        /* Dark mode - Payment Method Selected */
        [data-theme="dark"] .payment-method.selected {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%);
        }
        .payment-method i {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        .not-logged-in-section {
            padding: 120px 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .upgrade-badge {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
        /* Core Benefits Section */
        .benefits-section {
            padding: 80px 0;
            background: #f8f9fa;
        }
        /* Dark mode - Benefits Section */
        [data-theme="dark"] .benefits-section {
            background: #1a1a1a;
        }
        .benefit-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            height: 100%;
        }
        /* Dark mode - Benefit Card */
        [data-theme="dark"] .benefit-card {
            background: #1e1e1e;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .benefit-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
        }
        [data-theme="dark"] .benefit-card:hover {
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        .benefit-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        .benefit-icon.primary { background: rgba(99, 102, 241, 0.1); color: #6366F1; }
        .benefit-icon.secondary { background: rgba(236, 72, 153, 0.1); color: #EC4899; }
        .benefit-icon.gold { background: rgba(245, 158, 11, 0.1); color: #F59E0B; }
        .benefit-icon.success { background: rgba(34, 197, 94, 0.1); color: #22C55E; }
        /* Comparison Table Section */
        .comparison-section {
            padding: 80px 0;
        }
        /* Dark mode - Comparison Section */
        [data-theme="dark"] .comparison-section {
            background: #121212;
        }
        .comparison-table {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        /* Dark mode - Comparison Table */
        [data-theme="dark"] .comparison-table {
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        [data-theme="dark"] .comparison-table, 
        [data-theme="dark"] .comparison-table th,
        [data-theme="dark"] .comparison-table td {
            background: #1e1e1e;
            border-color: #333;
        }
        .comparison-table thead th {
            background: #f8f9fa;
            font-weight: 600;
            padding: 16px;
            border: none;
        }
        /* Dark mode - Comparison Table Header */
        [data-theme="dark"] .comparison-table thead th {
            background: #252525;
            color: #e0e0e0;
        }
        .comparison-table tbody td {
            padding: 16px;
            vertical-align: middle;
        }
        /* Dark mode - Comparison Table Body */
        [data-theme="dark"] .comparison-table tbody td {
            color: #e0e0e0;
            border-color: #333;
        }
        .scroll-hint {
            display: none;
        }
        @media (max-width: 768px) {
            .scroll-hint {
                display: block;
            }
        }
        /* CTA Section */
        .cta-section {
            padding: 80px 0;
            background: linear-gradient(135deg, #6366F1 0%, #EC4899 100%);
            color: white;
        }
        .cta-section h2 {
            font-size: clamp(1.5rem, 3vw, 2.5rem);
            font-weight: 700;
        }
        .cta-btn {
            padding: 16px 40px;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 50px;
            background: white;
            color: #6366F1;
            border: none;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .cta-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            background: #f8f9fa;
            color: #6366F1;
        }
        /* Specification Card Styles */
        .spec-card {
            background: white;
            transition: all 0.2s;
        }
        .spec-card.selected {
            border-color: #28a745 !important;
            background: rgba(40, 167, 69, 0.1) !important;
        }
        /* Dark mode - Specification Card */
        [data-theme="dark"] .spec-card {
            background: #2a2a2a;
            border-color: #444 !important;
        }
        [data-theme="dark"] .spec-card.selected {
            background: rgba(40, 167, 69, 0.2) !important;
        }
        /* Dark mode - Modal Content */
        [data-theme="dark"] #specificationModal .modal-content {
            background: #1e1e1e;
        }
        [data-theme="dark"] #specificationModal .modal-body {
            color: #e0e0e0;
        }
        /* VIP Modal Tab Styles */
        .vip-tab-btn {
            border: none;
            background: transparent;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .vip-tab-btn:hover:not(.active) {
            background: rgba(0, 0, 0, 0.05);
        }
        [data-theme="dark"] .vip-tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }
        /* Duration Item Styles */
        .duration-item {
            border: 2px solid #e0e0e0 !important;
        }
        .duration-item:hover {
            border-color: var(--primary-color, #6366F1) !important;
        }
        .duration-item.selected {
            border-color: var(--primary-color, #6366F1) !important;
        }
        [data-theme="dark"] .duration-item {
            border-color: #444 !important;
            background: #2a2a2a;
        }
        [data-theme="dark"] .duration-item:hover {
            border-color: var(--primary-color, #6366F1) !important;
        }
        /* Mobile Bottom Toolbar */
        .mobile-toolbar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg, #ffffff);
            border-top: 1px solid var(--border-color, #e0e0e0);
            padding: 8px 0;
            z-index: 1030;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        @media (max-width: 768px) {
            .mobile-toolbar.enabled {
                display: block;
            }
            body.has-mobile-toolbar {
                padding-bottom: 70px;
            }
        }
        .mobile-toolbar-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .mobile-toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-muted, #666);
            font-size: 0.75rem;
            padding: 4px 12px;
            transition: color 0.2s;
        }
        .mobile-toolbar-item i {
            font-size: 1.3rem;
            margin-bottom: 2px;
        }
        .mobile-toolbar-item:hover,
        .mobile-toolbar-item.active {
            color: var(--primary-color, #667eea);
        }
        [data-theme="dark"] .mobile-toolbar {
            background: var(--card-bg, #1e1e2f);
            border-color: var(--border-color, rgba(255,255,255,0.1));
        }
        [data-theme="dark"] .mobile-toolbar-item {
            color: var(--text-muted, #a0a0a0);
        }
        [data-theme="dark"] .mobile-toolbar-item:hover,
        [data-theme="dark"] .mobile-toolbar-item.active {
            color: var(--primary-color, #667eea);
        }
    </style>
    {{if .custom.GlobalCSS}}<style>{{.custom.GlobalCSS}}</style>{{end}}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-shield-lock-fill me-2"></i><span id="site-name">{{t .lang "app.name"}}</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    {{/* Server-side render top navigation items */}}
                    {{template "top_nav_items" .}}
                    {{if .logged}}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            {{if .user.Avatar}}
                            <img src="{{.user.Avatar}}" alt="Avatar" class="rounded-circle me-1" width="24" height="24">
                            {{else}}
                            <i class="bi bi-person-circle me-1"></i>
                            {{end}}
                            {{.user.DisplayName}}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>{{t .lang "nav.profile_center"}}</a></li>
                            <li><a class="dropdown-item" href="/recharge"><i class="bi bi-wallet2 me-2"></i>{{t .lang "nav.recharge_center"}}</a></li>
                            <li><a class="dropdown-item" href="/vip"><i class="bi bi-gem me-2"></i>{{t .lang "nav.vip_member"}}</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>{{t .lang "nav.logout"}}</a></li>
                        </ul>
                    </li>
                    {{else}}
                    <li class="nav-item">
                        <a class="nav-link" href="/auth/login"><i class="bi bi-box-arrow-in-right me-1"></i>{{t .lang "nav.login"}}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/auth/register"><i class="bi bi-person-plus me-1"></i>{{t .lang "nav.register"}}</a>
                    </li>
                    {{end}}
                    <!-- Dark Mode Toggle -->
                    <li class="nav-item">
                        <a class="nav-link dark-mode-toggle" href="javascript:void(0)" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                            <i class="bi bi-moon-fill"></i>
                        </a>
                    </li>
                    <!-- Language Switcher -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="langDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-globe me-1"></i>{{if eq .lang "zh"}}中文{{else}}English{{end}}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item {{if eq .lang "en"}}active{{end}}" href="#" onclick="setLanguage('en')"><i class="bi bi-check2 me-2 {{if ne .lang "en"}}invisible{{end}}"></i>English</a></li>
                            <li><a class="dropdown-item {{if eq .lang "zh"}}active{{end}}" href="#" onclick="setLanguage('zh')"><i class="bi bi-check2 me-2 {{if ne .lang "zh"}}invisible{{end}}"></i>中文</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    {{if .logged}}
    <!-- Enhanced Hero Section -->
    <section class="vip-hero-enhanced">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-7">
                    <h1 class="mb-4">{{t .lang "vip.hero_main_title"}}</h1>
                    <p class="lead mb-4 opacity-90" style="-webkit-text-fill-color: inherit;">{{t .lang "vip.hero_main_subtitle"}}</p>
                    <a href="#vip" class="btn btn-light btn-lg px-5 py-3 fw-bold rounded-pill">
                        {{t .lang "vip.subscribe_now"}} <i class="bi bi-arrow-right ms-2"></i>
                    </a>
                </div>
                <div class="col-lg-5 mt-4 mt-lg-0">
                    <div class="balance-card">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <small class="d-block opacity-75 mb-1">{{t .lang "recharge.account_balance"}}</small>
                                <div class="balance-amount">¥<span id="user-balance">{{printf "%.2f" .user.Balance}}</span></div>
                            </div>
                            <div class="vip-badge">
                                {{if gt .user.VIPLevel 0}}
                                <i class="bi bi-gem me-2"></i>VIP {{.user.VIPLevel}}
                                {{else}}
                                <i class="bi bi-person me-2"></i>{{t .lang "recharge.vip_badge_normal"}}
                                {{end}}
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="/recharge" class="btn btn-light flex-grow-1">
                                <i class="bi bi-plus-circle me-2"></i>{{t .lang "recharge.recharge_now"}}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- VIP Cards Section -->
    <section class="vip-section" id="vip">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="display-6 fw-bold mb-3">{{t .lang "vip.section_title"}}</h2>
                <p class="text-muted fs-5">{{t .lang "vip.section_subtitle"}}</p>
            </div>
            <div class="row g-4" id="vip-cards-container">
                <!-- VIP cards will be rendered by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Core Benefits Section -->
    <section class="benefits-section">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="display-6 fw-bold mb-3">{{t .lang "vip.core_benefits_title"}}</h2>
                <p class="text-muted fs-5">{{t .lang "vip.core_benefits_subtitle"}}</p>
            </div>
            <div class="row g-4">
                <div class="col-sm-6 col-lg-3">
                    <div class="benefit-card">
                        <div class="benefit-icon primary">
                            <i class="bi bi-unlock"></i>
                        </div>
                        <h5 class="fw-bold mb-2">{{t .lang "vip.benefit_content_unlock"}}</h5>
                        <p class="text-muted mb-0 small">{{t .lang "vip.benefit_content_unlock_desc"}}</p>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="benefit-card">
                        <div class="benefit-icon secondary">
                            <i class="bi bi-headset"></i>
                        </div>
                        <h5 class="fw-bold mb-2">{{t .lang "vip.benefit_support"}}</h5>
                        <p class="text-muted mb-0 small">{{t .lang "vip.benefit_support_desc"}}</p>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="benefit-card">
                        <div class="benefit-icon gold">
                            <i class="bi bi-trophy"></i>
                        </div>
                        <h5 class="fw-bold mb-2">{{t .lang "vip.benefit_points"}}</h5>
                        <p class="text-muted mb-0 small">{{t .lang "vip.benefit_points_desc"}}</p>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="benefit-card">
                        <div class="benefit-icon success">
                            <i class="bi bi-gift"></i>
                        </div>
                        <h5 class="fw-bold mb-2">{{t .lang "vip.benefit_birthday"}}</h5>
                        <p class="text-muted mb-0 small">{{t .lang "vip.benefit_birthday_desc"}}</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Comparison Table Section -->
    <section class="comparison-section">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="display-6 fw-bold mb-3">{{t .lang "vip.comparison_title"}}</h2>
                <p class="text-muted fs-5">{{t .lang "vip.comparison_subtitle"}}</p>
            </div>
            <div class="table-responsive">
                <table class="table comparison-table" id="comparison-table">
                    <thead>
                        <tr>
                            <th>{{t .lang "vip.comparison_benefit"}}</th>
                            <th class="text-center">{{t .lang "vip.comparison_regular"}}</th>
                            <!-- VIP level columns will be added by JavaScript -->
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{{t .lang "vip.comparison_basic_content"}}</td>
                            <td class="text-center"><i class="bi bi-check-circle-fill text-success"></i></td>
                            <!-- VIP level data will be added by JavaScript -->
                        </tr>
                        <tr>
                            <td>{{t .lang "vip.comparison_premium_content"}}</td>
                            <td class="text-center"><i class="bi bi-x-circle-fill text-danger"></i></td>
                        </tr>
                        <tr>
                            <td>{{t .lang "vip.comparison_support"}}</td>
                            <td class="text-center"><i class="bi bi-x-circle-fill text-danger"></i></td>
                        </tr>
                        <tr>
                            <td>{{t .lang "vip.comparison_points_rate"}}</td>
                            <td class="text-center">1x</td>
                        </tr>
                        <tr>
                            <td>{{t .lang "vip.comparison_discount"}}</td>
                            <td class="text-center">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p class="text-center text-muted small mt-3 scroll-hint">
                <i class="bi bi-hand-index-thumb me-2"></i>{{t .lang "vip.scroll_hint"}}
            </p>
        </div>
    </section>

    <!-- CTA Section -->
    <section class="cta-section">
        <div class="container">
            <div class="text-center">
                <h2 class="mb-4">{{t .lang "vip.cta_title"}}</h2>
                <p class="lead opacity-75 mb-4">{{t .lang "vip.cta_subtitle"}}</p>
                <a href="#vip" class="cta-btn btn">
                    {{t .lang "vip.subscribe_now"}} <i class="bi bi-rocket-takeoff ms-2"></i>
                </a>
            </div>
        </div>
    </section>

    <!-- Payment Modal -->
    <div class="modal fade payment-modal" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>{{t .lang "payment.title"}}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="payment-info">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">{{t .lang "payment.product_name"}}</span>
                            <span id="payment-product-name">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">{{t .lang "payment.amount"}}</span>
                            <span class="fw-bold text-primary fs-4" id="payment-amount">¥0.00</span>
                        </div>
                    </div>
                    <p class="text-muted small mb-3">{{t .lang "payment.select_method"}}</p>
                    <div class="payment-methods">
                        <div class="payment-method selected" data-method="alipay">
                            <i class="bi bi-alipay text-primary d-block"></i>
                            <small>{{t .lang "payment.alipay"}}</small>
                        </div>
                        <div class="payment-method" data-method="wechat">
                            <i class="bi bi-wechat text-success d-block"></i>
                            <small>{{t .lang "payment.wechat"}}</small>
                        </div>
                    </div>
                    <button class="btn btn-warning w-100 py-3 fw-bold" onclick="submitPayment()">
                        <i class="bi bi-shield-check me-2"></i>{{t .lang "payment.confirm_btn"}}
                    </button>
                    <p class="text-center text-muted small mt-3 mb-0">
                        <i class="bi bi-lock me-1"></i>{{t .lang "payment.secure_note"}}
                    </p>
                </div>
            </div>
        </div>
    </div>

    {{else}}
    <!-- Enhanced Not Logged In Hero -->
    <section class="vip-hero-enhanced">
        <div class="container">
            <div class="text-center py-5">
                <i class="bi bi-gem display-1 mb-4" style="-webkit-text-fill-color: inherit;"></i>
                <h1 class="mb-4">{{t .lang "vip.hero_main_title"}}</h1>
                <p class="lead mb-4 opacity-90" style="-webkit-text-fill-color: inherit;">{{t .lang "vip.hero_main_subtitle"}}</p>
                <a href="/auth/login?redirect=/vip" class="btn btn-light btn-lg px-5 py-3 fw-bold rounded-pill">
                    <i class="bi bi-box-arrow-in-right me-2"></i>{{t .lang "vip.login_now"}}
                </a>
            </div>
        </div>
    </section>

    <!-- Core Benefits Section for Non-logged Users -->
    <section class="benefits-section">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="display-6 fw-bold mb-3">{{t .lang "vip.core_benefits_title"}}</h2>
                <p class="text-muted fs-5">{{t .lang "vip.core_benefits_subtitle"}}</p>
            </div>
            <div class="row g-4">
                <div class="col-sm-6 col-lg-3">
                    <div class="benefit-card">
                        <div class="benefit-icon primary">
                            <i class="bi bi-unlock"></i>
                        </div>
                        <h5 class="fw-bold mb-2">{{t .lang "vip.benefit_content_unlock"}}</h5>
                        <p class="text-muted mb-0 small">{{t .lang "vip.benefit_content_unlock_desc"}}</p>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="benefit-card">
                        <div class="benefit-icon secondary">
                            <i class="bi bi-headset"></i>
                        </div>
                        <h5 class="fw-bold mb-2">{{t .lang "vip.benefit_support"}}</h5>
                        <p class="text-muted mb-0 small">{{t .lang "vip.benefit_support_desc"}}</p>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="benefit-card">
                        <div class="benefit-icon gold">
                            <i class="bi bi-trophy"></i>
                        </div>
                        <h5 class="fw-bold mb-2">{{t .lang "vip.benefit_points"}}</h5>
                        <p class="text-muted mb-0 small">{{t .lang "vip.benefit_points_desc"}}</p>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="benefit-card">
                        <div class="benefit-icon success">
                            <i class="bi bi-gift"></i>
                        </div>
                        <h5 class="fw-bold mb-2">{{t .lang "vip.benefit_birthday"}}</h5>
                        <p class="text-muted mb-0 small">{{t .lang "vip.benefit_birthday_desc"}}</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- CTA Section for Non-logged Users -->
    <section class="cta-section">
        <div class="container">
            <div class="text-center">
                <h2 class="mb-4">{{t .lang "vip.cta_title"}}</h2>
                <p class="lead opacity-75 mb-4">{{t .lang "vip.cta_subtitle"}}</p>
                <a href="/auth/login?redirect=/vip" class="cta-btn btn">
                    {{t .lang "vip.login_now"}} <i class="bi bi-box-arrow-in-right ms-2"></i>
                </a>
            </div>
        </div>
    </section>
    {{end}}

    <!-- Mobile Bottom Toolbar -->
    <nav class="mobile-toolbar" id="mobile-toolbar">
        <div class="mobile-toolbar-items" id="mobile-toolbar-items">
            <!-- Items will be loaded dynamically -->
        </div>
    </nav>

    {{template "footer" .}}

    {{template "common_scripts" .}}
    <script>
        const currentLang = "{{.lang}}";
        let vipLevels = [];
        let selectedVIPLevel = null;
        let selectedDuration = null;
        let paymentMethod = 'alipay';
        // Get current user's VIP level from the page
        let currentUserVIPLevel = {{if .user}}{{.user.VIPLevel}}{{else}}0{{end}};
        // Track user's VIP expiration and remaining days for prorated upgrade pricing
        let currentUserVIPExpireAt = null;
        let currentUserRemainingDays = 0;
        // Track old VIP level's daily price for prorated upgrade calculation
        let currentUserVIPDailyPrice = 0;

        // I18n strings
        const i18n = {
            pageTitle: "{{t .lang "vip.page_title"}}",
            popular: "{{t .lang "vip.popular"}}",
            owned: "{{t .lang "vip.owned"}}",
            validity: "{{t .lang "vip.validity"}}",
            days: "{{t .lang "vip.days"}}",
            permanent: "{{t .lang "vip.permanent"}}",
            upgradeDiscount: "{{t .lang "vip.upgrade_discount"}}",
            balancePurchase: "{{t .lang "vip.balance_purchase"}}",
            balanceUpgrade: "{{t .lang "vip.balance_upgrade"}}",
            insufficientBalance: "{{t .lang "vip.insufficient_balance"}}",
            onlinePayment: "{{t .lang "vip.online_payment"}}",
            onlineUpgrade: "{{t .lang "vip.online_upgrade"}}",
            cannotPurchase: "{{t .lang "vip.cannot_purchase"}}",
            purchaseConfirm: "{{t .lang "vip.purchase_confirm"}}",
            upgradeConfirm: "{{t .lang "vip.upgrade_confirm"}}",
            priceLabel: "{{t .lang "vip.price_label"}}",
            upgradePriceLabel: "{{t .lang "vip.upgrade_price_label"}}",
            originalPrice: "{{t .lang "vip.original_price"}}",
            purchaseSuccessTitle: "{{t .lang "vip.purchase_success_title"}}",
            upgradeSuccessTitle: "{{t .lang "vip.upgrade_success_title"}}",
            purchaseSuccessMsg: "{{t .lang "vip.purchase_success_msg"}}",
            upgradeSuccessMsg: "{{t .lang "vip.upgrade_success_msg"}}",
            currentBalance: "{{t .lang "vip.current_balance"}}",
            confirmBtn: "{{t .lang "vip.confirm_btn"}}",
            selectDuration: "{{t .lang "vip.select_duration"}}",
            selectDurationDesc: "{{t .lang "vip.select_duration_desc"}}",
            purchaseBtn: "{{t .lang "vip.purchase_btn"}}",
            startingFrom: "{{t .lang "vip.starting_from"}}",
            month: "{{t .lang "vip.month"}}",
            multipleOptions: "{{t .lang "vip.multiple_options"}}",
            pleaseSelectDuration: "{{t .lang "vip.please_select_duration"}}",
            modalSelectPlan: "{{t .lang "vip.modal_select_plan"}}",
            modalUnitPrice: "{{t .lang "vip.modal_unit_price"}}",
            modalDiscount: "{{t .lang "vip.modal_discount"}}",
            modalTotal: "{{t .lang "vip.modal_total"}}",
            modalPayNow: "{{t .lang "vip.modal_pay_now"}}",
            modalAgreeTerms: "{{t .lang "vip.modal_agree_terms"}}",
            modalServiceAgreement: "{{t .lang "vip.modal_service_agreement"}}",
            modalSave: "{{t .lang "vip.modal_save"}}",
            balanceRenew: "{{t .lang "vip.balance_renew"}}",
            renewConfirm: "{{t .lang "vip.renew_confirm"}}",
            renewSuccessTitle: "{{t .lang "vip.renew_success_title"}}",
            renewSuccessMsg: "{{t .lang "vip.renew_success_msg"}}",
            paymentTitle: "{{t .lang "payment.title"}}",
            paymentProductName: "{{t .lang "payment.product_name"}}",
            paymentAmount: "{{t .lang "payment.amount"}}",
            paymentAlipay: "{{t .lang "payment.alipay"}}",
            paymentWechat: "{{t .lang "payment.wechat"}}",
            paymentConfirmBtn: "{{t .lang "payment.confirm_btn"}}",
            paymentSecureNote: "{{t .lang "payment.secure_note"}}",
            paymentProcessing: "{{t .lang "payment.processing"}}",
            paymentNotConfiguredTitle: "{{t .lang "payment.not_configured_title"}}",
            paymentNotConfiguredMsg: "{{t .lang "payment.not_configured_msg"}}",
            paymentOrderInfo: "{{t .lang "payment.order_info"}}",
            paymentClose: "{{t .lang "payment.close"}}",
            paymentRedirectTitle: "{{t .lang "payment.redirect_title"}}",
            paymentRedirectPreparing: "{{t .lang "payment.redirect_preparing"}}",
            paymentRedirectMsg: "{{t .lang "payment.redirect_msg"}}",
            paymentProduct: "{{t .lang "payment.product"}}",
            paymentPayAmount: "{{t .lang "payment.pay_amount"}}",
            paymentMethod: "{{t .lang "payment.method"}}",
            paymentDemoTitle: "{{t .lang "payment.demo_title"}}",
            paymentDemoMsg: "{{t .lang "payment.demo_msg"}}",
            paymentOrderDetails: "{{t .lang "payment.order_details"}}",
            paymentDemoNote: "{{t .lang "payment.demo_note"}}",
            paymentGoConfigure: "{{t .lang "payment.go_configure"}}",
            paymentErrorTitle: "{{t .lang "payment.error_title"}}",
            paymentErrorMsg: "{{t .lang "payment.error_msg"}}",
            alertOk: "{{t .lang "common.ok"}}",
            confirmCancel: "{{t .lang "common.cancel"}}",
            confirmOk: "{{t .lang "common.confirm"}}"
        };

        // Utility function to escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Utility function to show alert modal (replaces native alert)
        function showAlertModal(message, title = '') {
            return new Promise(resolve => {
                const escapedTitle = title ? escapeHtml(title) : '';
                const escapedMessage = escapeHtml(message).replace(/\n/g, '<br>');
                
                const modalHtml = `
                    <div class="modal fade" id="alertModal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                ${escapedTitle ? `
                                <div class="modal-header">
                                    <h5 class="modal-title">${escapedTitle}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                ` : ''}
                                <div class="modal-body py-4">
                                    <p class="mb-0">${escapedMessage}</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">${escapeHtml(i18n.alertOk || 'OK')}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const existing = document.getElementById('alertModal');
                if (existing) existing.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modalEl = document.getElementById('alertModal');
                const modal = new bootstrap.Modal(modalEl);
                
                modalEl.addEventListener('hidden.bs.modal', () => {
                    modalEl.remove();
                    resolve();
                }, { once: true });
                
                modal.show();
            });
        }

        // Utility function to show confirm modal (replaces native confirm)
        function showConfirmModal(message, title = '', options = {}) {
            return new Promise(resolve => {
                const confirmBtnClass = options.confirmBtnClass || 'btn-primary';
                const confirmBtnText = escapeHtml(options.confirmBtnText || i18n.confirmOk || 'OK');
                const cancelBtnText = escapeHtml(options.cancelBtnText || i18n.confirmCancel || 'Cancel');
                const escapedTitle = title ? escapeHtml(title) : '';
                const escapedMessage = escapeHtml(message).replace(/\n/g, '<br>');
                
                const modalHtml = `
                    <div class="modal fade" id="confirmModal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                ${escapedTitle ? `
                                <div class="modal-header">
                                    <h5 class="modal-title">${escapedTitle}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                ` : ''}
                                <div class="modal-body py-4">
                                    <p class="mb-0">${escapedMessage}</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="confirmCancelBtn">${cancelBtnText}</button>
                                    <button type="button" class="btn ${escapeHtml(confirmBtnClass)}" id="confirmOkBtn">${confirmBtnText}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const existing = document.getElementById('confirmModal');
                if (existing) existing.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modalEl = document.getElementById('confirmModal');
                const modal = new bootstrap.Modal(modalEl);
                
                let resolved = false;
                
                document.getElementById('confirmOkBtn').addEventListener('click', () => {
                    resolved = true;
                    modal.hide();
                });
                
                modalEl.addEventListener('hidden.bs.modal', () => {
                    modalEl.remove();
                    resolve(resolved);
                }, { once: true });
                
                modal.show();
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadSiteSettings();
            loadVIPLevels();
            loadMobileToolbar();
            setupPaymentMethods();
        });

        // Load user's VIP expiration info for prorated upgrade pricing
        async function loadUserVIPInfo() {
            if (currentUserVIPLevel <= 0) return;
            
            try {
                const response = await fetch('/api/auth/balance');
                if (!response.ok) {
                    console.error('Failed to load user VIP info: HTTP', response.status);
                    return;
                }
                const result = await response.json();
                if (result.success && result.data) {
                    if (result.data.vip_expire_at) {
                        currentUserVIPExpireAt = new Date(result.data.vip_expire_at);
                        const now = new Date();
                        if (currentUserVIPExpireAt > now) {
                            // Calculate remaining days (rounded up for partial days)
                            const diffMs = currentUserVIPExpireAt - now;
                            currentUserRemainingDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                        }
                    }
                    
                    // Calculate daily price of current VIP level
                    const currentVIP = vipLevels.find(v => v.level === currentUserVIPLevel);
                    if (currentVIP) {
                        const duration = currentVIP.duration || 30;
                        currentUserVIPDailyPrice = duration > 0 ? currentVIP.price / duration : 0;
                    }
                }
            } catch (error) {
                console.error('Failed to load user VIP info:', error);
            }
        }

        async function loadMobileToolbar() {
            try {
                const response = await fetch('/api/mobile-toolbar');
                const result = await response.json();
                if (result.success && result.enabled) {
                    renderMobileToolbar(result.data);
                }
            } catch (error) {
                console.error('Failed to load mobile toolbar:', error);
            }
        }

        function renderMobileToolbar(items) {
            const toolbar = document.getElementById('mobile-toolbar');
            const container = document.getElementById('mobile-toolbar-items');
            if (!toolbar || !container || !items || items.length === 0) return;

            toolbar.classList.add('enabled');
            document.body.classList.add('has-mobile-toolbar');

            const sortedItems = [...items].sort((a, b) => a.order - b.order);
            const currentPath = window.location.pathname;

            container.innerHTML = sortedItems.map(item => {
                const title = (item.title_i18n && item.title_i18n[currentLang]) || item.title;
                const isActive = currentPath === item.url || (item.url !== '/' && currentPath.startsWith(item.url));
                const activeClass = isActive ? 'active' : '';
                const safeIcon = item.icon || 'bi-link';
                const safeUrl = item.url || '#';
                
                return `<a href="${safeUrl}" class="mobile-toolbar-item ${activeClass}">
                    <i class="${safeIcon}"></i>
                    <span>${title}</span>
                </a>`;
            }).join('');
        }

        async function loadSiteSettings() {
            try {
                const response = await fetch('/api/site-settings');
                const result = await response.json();
                if (result.success && result.data) {
                    if (result.data.title) {
                        document.getElementById('site-name').textContent = result.data.title;
                        document.getElementById('footer-site-name').textContent = result.data.title;
                        document.title = result.data.title + ' - ' + i18n.pageTitle;
                    }
                }
            } catch (error) {
                console.error('Failed to load site settings:', error);
            }
        }

        async function loadVIPLevels() {
            try {
                const response = await fetch('/api/vip-levels');
                const result = await response.json();
                if (result.success) {
                    vipLevels = result.data || [];
                    renderVIPCards();
                    renderComparisonTable();
                    // Load user VIP info after VIP levels are loaded (needed for daily price calculation)
                    loadUserVIPInfo();
                }
            } catch (error) {
                console.error('Failed to load VIP levels:', error);
            }
        }

        function renderComparisonTable() {
            const table = document.getElementById('comparison-table');
            if (!table || vipLevels.length === 0) return;
            
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');
            
            // Add VIP level headers
            vipLevels.forEach(level => {
                const th = document.createElement('th');
                th.className = 'text-center';
                th.style.background = level.color ? `${level.color}15` : '#f8f9fa';
                th.innerHTML = `<span style="color: ${level.color || '#6366F1'}">${level.name}</span>`;
                thead.appendChild(th);
            });
            
            // Update tbody rows with VIP level data
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, rowIndex) => {
                vipLevels.forEach((level, levelIndex) => {
                    const td = document.createElement('td');
                    td.className = 'text-center';
                    
                    // Determine content based on row
                    switch(rowIndex) {
                        case 0: // Basic content - all have it
                            td.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
                            break;
                        case 1: // Premium content - all VIP have it
                            td.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
                            break;
                        case 2: // Dedicated support - higher levels
                            td.innerHTML = level.level >= 2 
                                ? '<i class="bi bi-check-circle-fill text-success"></i>' 
                                : '<i class="bi bi-x-circle-fill text-danger"></i>';
                            break;
                        case 3: // Points rate
                            const rate = level.level === 1 ? '1.5x' : level.level === 2 ? '2x' : '3x';
                            td.textContent = rate;
                            break;
                        case 4: // Discount
                            const discount = level.level === 1 ? '9.5折' : level.level === 2 ? '9折' : '8折';
                            const discountEn = level.level === 1 ? '5%' : level.level === 2 ? '10%' : '20%';
                            td.textContent = document.documentElement.lang === 'zh' ? discount : discountEn;
                            break;
                    }
                    row.appendChild(td);
                });
            });
        }

        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            const num = parseInt(hex, 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
        }

        function renderVIPCards() {
            const container = document.getElementById('vip-cards-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            const userBalance = parseFloat(document.getElementById('user-balance')?.textContent || '0');
            
            vipLevels.forEach((level, index) => {
                const isPopular = index === Math.floor(vipLevels.length / 2);
                
                // Check if this level is lower than or equal to current user's VIP level
                const isDowngrade = level.level <= currentUserVIPLevel;
                const isUpgrade = currentUserVIPLevel > 0 && level.level > currentUserVIPLevel;
                
                // Check if this level has multiple specifications
                const hasSpecs = level.specifications && level.specifications.length > 0;
                
                // Calculate display price (use lowest price for display if has specs)
                let displayPrice = level.price;
                let displayDuration = level.duration;
                let priceDisplay = `¥${level.price}`;
                let upgradeLabel = '';
                
                if (hasSpecs) {
                    // Find the lowest price specification
                    const lowestSpec = level.specifications.reduce((a, b) => a.price < b.price ? a : b);
                    displayPrice = lowestSpec.price;
                    displayDuration = lowestSpec.duration;
                    priceDisplay = `¥${displayPrice}${i18n.startingFrom}`;
                }
                
                // Use string key for upgrade_prices lookup (JSON uses string keys)
                const currentLevelKey = String(currentUserVIPLevel);
                if (isUpgrade && !hasSpecs && level.upgrade_prices && level.upgrade_prices[currentLevelKey]) {
                    const upgradePrice = level.upgrade_prices[currentLevelKey];
                    priceDisplay = `<s class="text-light opacity-50 small">¥${level.price}</s> ¥${upgradePrice}`;
                    displayPrice = upgradePrice;
                    upgradeLabel = `<span class="upgrade-badge">${i18n.upgradeDiscount}</span>`;
                }
                
                const canAfford = userBalance >= displayPrice;
                
                // Duration text
                const durationText = displayDuration > 0 ? `${displayDuration} ${i18n.days}` : i18n.permanent;
                
                // Check if this is the same level as current user's VIP and renewal is allowed
                const isSameLevel = level.level === currentUserVIPLevel;
                const allowRenewal = level.allow_renewal === true;
                
                // Determine button states
                let balanceButtonHtml, paymentButtonHtml;
                
                if (isSameLevel && allowRenewal) {
                    // Same level and renewal is allowed - show renewal button
                    balanceButtonHtml = `
                        <button class="btn ${canAfford ? 'btn-info' : 'btn-outline-secondary'} vip-select-btn" 
                                onclick="event.stopPropagation(); ${hasSpecs ? `showSpecificationModal(${level.level}, 'renew')` : `renewVIPWithBalance(${level.level}, ${level.duration})`}"
                                ${!canAfford ? 'disabled' : ''}>
                            <i class="bi bi-arrow-repeat me-2"></i>${canAfford ? i18n.balanceRenew : i18n.insufficientBalance}
                        </button>
                    `;
                    // When balance is insufficient, show online payment button for renewal instead of "Owned"
                    paymentButtonHtml = canAfford ? `
                        <button class="btn btn-outline-secondary vip-select-btn" disabled>
                            <i class="bi bi-check-circle me-2"></i>${i18n.owned}
                        </button>
                    ` : `
                        <button class="btn btn-outline-warning vip-select-btn" onclick="event.stopPropagation(); ${hasSpecs ? `showSpecificationModal(${level.level}, 'online')` : `openVIPPayment(${level.level}, ${level.duration})`}">
                            <i class="bi bi-credit-card me-2"></i>${i18n.onlinePayment}
                        </button>
                    `;
                } else if (isDowngrade) {
                    // Already have this level or higher - disable buttons
                    balanceButtonHtml = `
                        <button class="btn btn-outline-secondary vip-select-btn" disabled>
                            <i class="bi bi-check-circle me-2"></i>${i18n.owned}
                        </button>
                    `;
                    paymentButtonHtml = `
                        <button class="btn btn-outline-secondary vip-select-btn" disabled>
                            <i class="bi bi-ban me-2"></i>${i18n.cannotPurchase}
                        </button>
                    `;
                } else if (hasSpecs) {
                    // Has multiple specifications - show selection modal
                    balanceButtonHtml = `
                        <button class="btn btn-success vip-select-btn" 
                                onclick="event.stopPropagation(); showSpecificationModal(${level.level}, 'balance')">
                            <i class="bi bi-wallet2 me-2"></i>${isUpgrade ? i18n.balanceUpgrade : i18n.balancePurchase}
                        </button>
                    `;
                    paymentButtonHtml = `
                        <button class="btn btn-outline-warning vip-select-btn" onclick="event.stopPropagation(); showSpecificationModal(${level.level}, 'online')">
                            <i class="bi bi-credit-card me-2"></i>${isUpgrade ? i18n.onlineUpgrade : i18n.onlinePayment}
                        </button>
                    `;
                } else {
                    // Can purchase or upgrade (no specs)
                    balanceButtonHtml = `
                        <button class="btn ${canAfford ? 'btn-success' : 'btn-outline-secondary'} vip-select-btn" 
                                onclick="event.stopPropagation(); purchaseVIPWithBalance(${level.level}, ${level.duration})"
                                ${!canAfford ? 'disabled' : ''}>
                            <i class="bi bi-wallet2 me-2"></i>${canAfford ? (isUpgrade ? i18n.balanceUpgrade : i18n.balancePurchase) : i18n.insufficientBalance}
                        </button>
                    `;
                    paymentButtonHtml = `
                        <button class="btn btn-outline-warning vip-select-btn" onclick="event.stopPropagation(); openVIPPayment(${level.level}, ${level.duration})">
                            <i class="bi bi-credit-card me-2"></i>${isUpgrade ? i18n.onlineUpgrade : i18n.onlinePayment}
                        </button>
                    `;
                }
                
                // Multi-options badge
                const multiOptionsBadge = hasSpecs ? `<span class="badge bg-info ms-2" style="font-size: 0.7rem;">${i18n.multipleOptions}</span>` : '';
                
                // Calculate lighten color for icon background
                const lightenColor = (color, percent) => {
                    const num = parseInt(color.replace('#',''), 16);
                    const amt = Math.round(2.55 * percent);
                    const R = Math.min(255, (num >> 16) + amt);
                    const G = Math.min(255, ((num >> 8) & 0x00FF) + amt);
                    const B = Math.min(255, (num & 0x0000FF) + amt);
                    return '#' + (0x1000000 + R*0x10000 + G*0x100 + B).toString(16).slice(1);
                };
                
                const cardColor = level.color || '#ffd700';
                // Create semi-transparent background for icon wrapper
                // Using rgba for better compatibility
                const hexToRgba = (hex, alpha) => {
                    const cleanHex = hex.replace('#', '');
                    const r = parseInt(cleanHex.substring(0, 2), 16);
                    const g = parseInt(cleanHex.substring(2, 4), 16);
                    const b = parseInt(cleanHex.substring(4, 6), 16);
                    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                };
                const iconBgColor = hexToRgba(cardColor, 0.1);
                
                // Generate features list HTML if features exist
                let featuresHtml = '';
                if (level.features && level.features.length > 0) {
                    featuresHtml = '<ul class="vip-features">';
                    level.features.forEach(feature => {
                        const enabledClass = feature.enabled ? 'enabled' : 'disabled';
                        const icon = feature.enabled ? 'bi-check-lg' : 'bi-x-lg';
                        featuresHtml += `
                            <li class="${enabledClass}">
                                <i class="bi ${icon}"></i>
                                <span>${feature.text}</span>
                            </li>
                        `;
                    });
                    featuresHtml += '</ul>';
                }
                
                container.innerHTML += `
                    <div class="col-md-4 mb-4">
                        <div class="vip-card ${isPopular && !isDowngrade ? 'popular' : ''} ${isDowngrade ? 'opacity-75' : ''}" 
                             data-level="${level.level}" 
                             style="border-top-color: ${cardColor};"
                             ${!isDowngrade ? `onclick="selectVIPLevel(${level.level})"` : ''}>
                            ${isPopular && !isDowngrade ? `<div class="vip-popular-badge"><i class="bi bi-star-fill me-1"></i>${i18n.popular}</div>` : ''}
                            <div class="vip-header">
                                ${isDowngrade ? `<span class="vip-popular"><i class="bi bi-check-lg"></i> ${i18n.owned}</span>` : ''}
                                <div class="vip-icon-wrapper" style="background: ${iconBgColor};">
                                    <i class="${level.icon || 'bi-star'}" style="color: ${cardColor};"></i>
                                </div>
                                <div class="vip-name" style="color: ${cardColor};">${level.name}${upgradeLabel}</div>
                                <div class="vip-price">
                                    ${priceDisplay}
                                    <small>${displayDuration > 0 ? '/' + i18n.month + i18n.startingFrom : '/' + i18n.permanent}</small>
                                </div>
                            </div>
                            <div class="vip-body">
                                ${featuresHtml || (level.description ? `<div class="vip-description mb-4">${level.description}</div>` : '')}
                                <div class="vip-duration text-center mb-3">
                                    <i class="bi bi-clock me-1"></i>
                                    ${i18n.validity}：${hasSpecs ? i18n.multipleOptions : durationText}
                                    ${multiOptionsBadge}
                                </div>
                                <div class="d-grid gap-2">
                                    ${balanceButtonHtml}
                                    ${paymentButtonHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // Constants
        const DAYS_PER_MONTH = 30;
        
        // Helper function to generate gradient style
        function getGradientStyle(color, darkenAmount = -20) {
            const baseColor = color || '#6366F1';
            return `linear-gradient(135deg, ${baseColor}, ${adjustColor(baseColor, darkenAmount)})`;
        }

        // Show specification selection modal with member type tabs (like demovip.html)
        let modalCurrentMember = null;
        let modalCurrentPeriod = 1;
        let modalPurchaseType = 'online';

        function showSpecificationModal(level, purchaseType) {
            const vip = vipLevels.find(v => v.level === level);
            if (!vip) return;
            
            // If no specifications, fallback to direct purchase
            if (!vip.specifications || vip.specifications.length === 0) {
                if (purchaseType === 'balance') {
                    purchaseVIPWithBalance(level, vip.duration);
                } else {
                    openVIPPayment(level, vip.duration);
                }
                return;
            }
            
            modalCurrentMember = level;
            modalPurchaseType = purchaseType;
            modalCurrentPeriod = vip.specifications[0]?.duration || 1;
            
            // Build member type tabs HTML
            let memberTabsHtml = '';
            const availableVips = vipLevels.filter(v => v.level > currentUserVIPLevel && v.specifications && v.specifications.length > 0);
            
            availableVips.forEach((v) => {
                const isActive = v.level === level;
                memberTabsHtml += `
                    <button class="vip-tab-btn flex-fill py-2 rounded-lg text-center ${isActive ? 'active' : ''}" 
                            data-level="${v.level}"
                            onclick="switchModalMemberType(${v.level})"
                            style="${isActive ? `background: ${getGradientStyle(v.color)}; color: white;` : ''}">
                        ${v.name}
                    </button>
                `;
            });
            
            // Build duration options HTML
            const durationsHtml = buildDurationOptionsHtml(vip);
            
            // Build price details
            const priceDetailsHtml = buildPriceDetailsHtml(vip);
            
            const modalHtml = `
                <div class="modal fade" id="specificationModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content" style="border-radius: 16px; overflow: hidden;">
                            <!-- Modal Header -->
                            <div class="p-4 border-bottom">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 id="vip-modal-title" class="modal-title fw-bold" style="color: ${vip.color || '#6366F1'}">
                                        <i class="${vip.icon || 'bi-star'} me-2"></i>${i18n.modalSelectPlan} - ${vip.name}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                            </div>

                            <div class="modal-body p-4">
                                <!-- Member Type Tabs -->
                                ${availableVips.length > 1 ? `
                                <div class="d-flex justify-content-between mb-4 p-1 rounded-3" style="background: var(--feature-card-bg, #f8f9fa); gap: 4px;" id="member-type-tabs">
                                    ${memberTabsHtml}
                                </div>
                                ` : ''}

                                <!-- Duration Selection -->
                                <h6 class="fw-medium mb-3">${i18n.selectDuration}</h6>
                                <div class="row g-3 mb-4" id="duration-options">
                                    ${durationsHtml}
                                </div>

                                <!-- Price Details -->
                                <div class="rounded-3 p-3 mb-4" style="background: var(--feature-card-bg, #f8f9fa);" id="price-details">
                                    ${priceDetailsHtml}
                                </div>

                                <!-- Purchase Button -->
                                <button class="btn w-100 py-3 fw-bold rounded-3" id="modal-purchase-btn"
                                        style="background: ${getGradientStyle(vip.color)}; color: white;"
                                        onclick="confirmSpecificationPurchase(modalCurrentMember, modalPurchaseType)">
                                    ${i18n.modalPayNow} <i class="bi bi-arrow-right ms-2"></i>
                                </button>
                                
                                <p class="text-center text-muted small mt-3 mb-0">
                                    ${i18n.modalAgreeTerms}<a href="#" class="text-primary">${i18n.modalServiceAgreement}</a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('specificationModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('specificationModal')).show();
            
            // Select first duration option after modal is shown
            setTimeout(() => {
                const firstOption = document.querySelector('#duration-options .duration-item');
                if (firstOption) selectDurationOption(firstOption);
            }, 100);
        }

        function buildDurationOptionsHtml(vip) {
            const userBalance = parseFloat(document.getElementById('user-balance')?.textContent || '0');
            const isUpgrade = currentUserVIPLevel > 0 && vip.level > currentUserVIPLevel;
            const currentLevelKey = String(currentUserVIPLevel);
            
            // Get upgrade coefficient for prorated pricing (validate it's a valid number between 0 and 1)
            const upgradeCoefficient = typeof vip.upgrade_coefficient === 'number' && 
                                       !isNaN(vip.upgrade_coefficient) && 
                                       vip.upgrade_coefficient > 0 && 
                                       vip.upgrade_coefficient <= 1 
                                       ? vip.upgrade_coefficient : 0;
            
            let html = '';
            vip.specifications.forEach((spec, index) => {
                // Ensure spec.price is a valid number
                let specPrice = typeof spec.price === 'number' && !isNaN(spec.price) ? spec.price : 0;
                let originalPrice = specPrice;
                
                // Calculate upgrade price based on remaining days if coefficient is set
                if (isUpgrade && upgradeCoefficient > 0 && currentUserRemainingDays > 0 && currentUserVIPDailyPrice > 0) {
                    // Prorated upgrade price = new price - (remaining days * old daily price * coefficient)
                    const credit = currentUserRemainingDays * currentUserVIPDailyPrice * upgradeCoefficient;
                    specPrice = Math.max(0, specPrice - credit);
                    // Round to 2 decimal places
                    specPrice = Math.round(specPrice * 100) / 100;
                } else if (isUpgrade && spec.upgrade_prices && spec.upgrade_prices[currentLevelKey]) {
                    // Fall back to fixed upgrade price if set
                    const fixedUpgradePrice = spec.upgrade_prices[currentLevelKey];
                    if (typeof fixedUpgradePrice === 'number' && !isNaN(fixedUpgradePrice)) {
                        specPrice = fixedUpgradePrice;
                    }
                }
                
                const durationText = spec.duration > 0 ? `${spec.duration} ${i18n.days}` : i18n.permanent;
                const canAfford = modalPurchaseType === 'balance' ? userBalance >= specPrice : true;
                const isSelected = index === 0;
                
                html += `
                    <div class="col-4">
                        <div class="duration-item p-3 border rounded-3 text-center ${isSelected ? 'selected' : ''} ${!canAfford && modalPurchaseType === 'balance' ? 'opacity-50' : ''}"
                             data-duration="${spec.duration}" 
                             data-price="${specPrice}" 
                             data-original-price="${originalPrice}"
                             onclick="${canAfford || modalPurchaseType !== 'balance' ? 'selectDurationOption(this)' : ''}"
                             style="cursor: ${canAfford || modalPurchaseType !== 'balance' ? 'pointer' : 'not-allowed'}; transition: all 0.2s;">
                            <span class="d-block fw-medium">${durationText}</span>
                            <span class="d-block fw-bold" style="color: ${vip.color || '#6366F1'}">¥${specPrice.toFixed(2)}</span>
                            ${!canAfford && modalPurchaseType === 'balance' ? `<small class="text-danger d-block">${i18n.insufficientBalance}</small>` : ''}
                        </div>
                    </div>
                `;
            });
            return html;
        }

        function buildPriceDetailsHtml(vip) {
            const firstSpec = vip.specifications[0];
            const price = firstSpec?.price || vip.price;
            const duration = firstSpec?.duration || DAYS_PER_MONTH;
            const unitPrice = (price / Math.max(1, Math.round(duration / DAYS_PER_MONTH))).toFixed(2);
            
            return `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">${i18n.modalUnitPrice}</span>
                    <span class="fw-medium" id="unit-price-display">¥${unitPrice}/${i18n.month}</span>
                </div>
                <div class="border-top pt-3 mt-3 d-flex justify-content-between align-items-center">
                    <span class="fw-bold">${i18n.modalTotal}</span>
                    <span class="fw-bold fs-5" id="total-price-display" style="color: ${vip.color || '#6366F1'}">¥${price.toFixed(2)}</span>
                </div>
            `;
        }

        function switchModalMemberType(level) {
            const vip = vipLevels.find(v => v.level === level);
            if (!vip) return;
            
            modalCurrentMember = level;
            
            // Update tabs
            document.querySelectorAll('#member-type-tabs .vip-tab-btn').forEach(btn => {
                const btnLevel = parseInt(btn.dataset.level);
                if (btnLevel === level) {
                    btn.classList.add('active');
                    btn.style.background = getGradientStyle(vip.color);
                    btn.style.color = 'white';
                } else {
                    btn.classList.remove('active');
                    btn.style.background = '';
                    btn.style.color = '';
                }
            });
            
            // Update modal title
            const titleEl = document.getElementById('vip-modal-title');
            if (titleEl) {
                titleEl.innerHTML = `<i class="${vip.icon || 'bi-star'} me-2"></i>${i18n.modalSelectPlan} - ${vip.name}`;
                titleEl.style.color = vip.color || '#6366F1';
            }
            
            // Update duration options
            const durationContainer = document.getElementById('duration-options');
            if (durationContainer) {
                durationContainer.innerHTML = buildDurationOptionsHtml(vip);
            }
            
            // Update price details
            const priceDetails = document.getElementById('price-details');
            if (priceDetails) {
                priceDetails.innerHTML = buildPriceDetailsHtml(vip);
            }
            
            // Update purchase button color
            const purchaseBtn = document.getElementById('modal-purchase-btn');
            if (purchaseBtn) {
                purchaseBtn.style.background = getGradientStyle(vip.color);
            }
            
            // Select first duration option
            setTimeout(() => {
                const firstOption = document.querySelector('#duration-options .duration-item');
                if (firstOption) selectDurationOption(firstOption);
            }, 50);
        }

        function selectDurationOption(element) {
            const vip = vipLevels.find(v => v.level === modalCurrentMember);
            if (!vip) return;
            
            // Update selection state
            document.querySelectorAll('#duration-options .duration-item').forEach(item => {
                item.classList.remove('selected');
                item.style.borderColor = '';
                item.style.background = '';
            });
            element.classList.add('selected');
            element.style.borderColor = vip.color || '#6366F1';
            element.style.background = `${vip.color || '#6366F1'}10`;
            
            // Get selected values
            const duration = parseInt(element.dataset.duration);
            const price = parseFloat(element.dataset.price);
            
            modalCurrentPeriod = duration;
            
            // Update price display
            const months = Math.max(1, Math.round(duration / DAYS_PER_MONTH));
            const unitPrice = (price / months).toFixed(2);
            
            const unitPriceEl = document.getElementById('unit-price-display');
            const totalEl = document.getElementById('total-price-display');
            
            if (unitPriceEl) unitPriceEl.textContent = `¥${unitPrice}/${i18n.month}`;
            if (totalEl) {
                totalEl.textContent = `¥${price.toFixed(2)}`;
                totalEl.style.color = vip.color || '#6366F1';
            }
        }

        function selectSpecification(element) {
            document.querySelectorAll('#spec-options .spec-card').forEach(c => {
                c.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        function confirmSpecificationPurchase(level, purchaseType) {
            const selectedSpec = document.querySelector('#duration-options .duration-item.selected');
            if (!selectedSpec) {
                showAlertModal(i18n.pleaseSelectDuration);
                return;
            }
            
            const duration = parseInt(selectedSpec.dataset.duration);
            
            // Close the specification modal
            const specModal = bootstrap.Modal.getInstance(document.getElementById('specificationModal'));
            if (specModal) specModal.hide();
            
            // Process purchase or renewal
            setTimeout(() => {
                if (purchaseType === 'balance') {
                    purchaseVIPWithBalance(level, duration);
                } else if (purchaseType === 'renew') {
                    renewVIPWithBalance(level, duration);
                } else {
                    openVIPPayment(level, duration);
                }
            }, 300);
        }

        function selectVIPLevel(level) {
            selectedVIPLevel = level;
            document.querySelectorAll('.vip-card').forEach(card => {
                card.classList.remove('selected');
                if (parseInt(card.dataset.level) === level) {
                    card.classList.add('selected');
                }
            });
        }

        function setupPaymentMethods() {
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                    this.classList.add('selected');
                    paymentMethod = this.dataset.method;
                });
            });
        }

        function openVIPPayment(level, duration = 0) {
            const vip = vipLevels.find(v => v.level === level);
            if (!vip) return;
            
            selectedVIPLevel = level;
            selectedDuration = duration;
            
            // Calculate actual price for display (check for upgrade price)
            const isUpgrade = currentUserVIPLevel > 0 && level > currentUserVIPLevel;
            let displayPrice = vip.price;
            let displayDuration = vip.duration;
            let productName = vip.name;
            
            // If duration is specified and specifications exist, find matching spec
            if (duration > 0 && vip.specifications && vip.specifications.length > 0) {
                const spec = vip.specifications.find(s => s.duration === duration);
                if (spec) {
                    displayPrice = spec.price;
                    displayDuration = spec.duration;
                    
                    // Check for upgrade price in specification
                    const currentLevelKey = String(currentUserVIPLevel);
                    if (isUpgrade && spec.upgrade_prices && spec.upgrade_prices[currentLevelKey]) {
                        displayPrice = spec.upgrade_prices[currentLevelKey];
                    }
                }
            } else if (isUpgrade) {
                // Use string key for upgrade_prices lookup (JSON uses string keys)
                const currentLevelKey = String(currentUserVIPLevel);
                if (vip.upgrade_prices && vip.upgrade_prices[currentLevelKey]) {
                    displayPrice = vip.upgrade_prices[currentLevelKey];
                }
            }
            
            if (isUpgrade) {
                productName = vip.name + ' (' + i18n.upgradeDiscount + ')';
            }
            
            const durationText = displayDuration > 0 ? `${displayDuration}${i18n.days}` : i18n.permanent;
            productName += ` - ${durationText}`;
            
            document.getElementById('payment-product-name').textContent = productName;
            document.getElementById('payment-amount').textContent = '¥' + displayPrice.toFixed(2);
            
            new bootstrap.Modal(document.getElementById('paymentModal')).show();
        }

        async function submitPayment() {
            const vip = vipLevels.find(v => v.level === selectedVIPLevel);
            if (!vip) return;
            
            let amount = vip.price;
            let productName = vip.name;
            let duration = selectedDuration || vip.duration;
            
            // Get price for selected duration
            if (selectedDuration > 0 && vip.specifications && vip.specifications.length > 0) {
                const spec = vip.specifications.find(s => s.duration === selectedDuration);
                if (spec) {
                    amount = spec.price;
                    
                    // Check for upgrade price
                    const isUpgrade = currentUserVIPLevel > 0 && selectedVIPLevel > currentUserVIPLevel;
                    const currentLevelKey = String(currentUserVIPLevel);
                    if (isUpgrade && spec.upgrade_prices && spec.upgrade_prices[currentLevelKey]) {
                        amount = spec.upgrade_prices[currentLevelKey];
                    }
                }
            }

            // Show loading state
            const submitBtn = document.querySelector('#paymentModal .btn-warning');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${i18n.paymentProcessing}`;

            try {
                // Check if payment is configured
                const settingsRes = await fetch('/api/site-settings');
                const settings = await settingsRes.json();
                
                if (!settings.success || !settings.data.payment_enabled) {
                    // Show configuration required modal
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentNotConfiguredModal(productName, amount);
                    return;
                }

                // Call backend payment API
                const paymentRes = await fetch('/api/payment/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_type: 'vip',
                        product_id: selectedVIPLevel,
                        amount: amount,
                        payment_method: paymentMethod
                    })
                });

                const paymentResult = await paymentRes.json();
                
                if (!paymentResult.success) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentErrorModal(paymentResult.message || i18n.paymentErrorMsg);
                    return;
                }

                // Check if in demo mode
                if (paymentResult.demo_mode) {
                    // Show demo mode modal
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentDemoMessage(productName, amount);
                    return;
                }

                // In production mode, redirect to PyPay
                if (paymentResult.data && paymentResult.data.payment_url) {
                    // Show redirect modal then redirect
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentRedirectModal(productName, amount, paymentResult.data.payment_url);
                } else {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    showPaymentErrorModal(i18n.paymentErrorMsg);
                }
                
            } catch (error) {
                console.error('Payment error:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                showPaymentErrorModal(i18n.paymentErrorMsg);
            }
        }

        function showPaymentNotConfiguredModal(productName, amount) {
            const modalHtml = `
                <div class="modal fade" id="paymentNotConfiguredModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>${i18n.paymentNotConfiguredTitle}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-gear display-1 text-muted mb-3"></i>
                                <h5>${i18n.paymentNotConfiguredTitle}</h5>
                                <p class="text-muted mb-4">${i18n.paymentNotConfiguredMsg}</p>
                                <div class="bg-light rounded p-3 mb-3">
                                    <small class="text-muted d-block">${i18n.paymentOrderInfo}</small>
                                    <strong>${productName}</strong>
                                    <span class="text-primary ms-2">¥${amount.toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${i18n.paymentClose}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('paymentNotConfiguredModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentNotConfiguredModal')).show();
        }

        function showPaymentRedirectModal(productName, amount, paymentUrl = '') {
            const methodText = paymentMethod === 'alipay' ? i18n.paymentAlipay : i18n.paymentWechat;
            const modalHtml = `
                <div class="modal fade" id="paymentRedirectModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%); color: white;">
                                <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>${i18n.paymentRedirectTitle}</h5>
                            </div>
                            <div class="modal-body text-center py-5">
                                <div class="spinner-border text-warning mb-4" style="width: 3rem; height: 3rem;" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h5>${i18n.paymentRedirectPreparing}</h5>
                                <p class="text-muted mb-4">${i18n.paymentRedirectMsg}</p>
                                <div class="bg-light rounded p-3 mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">${i18n.paymentProduct}</span>
                                        <strong>${productName}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span class="text-muted">${i18n.paymentPayAmount}</span>
                                        <strong class="text-primary">¥${amount.toFixed(2)}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span class="text-muted">${i18n.paymentMethod}</span>
                                        <strong>${methodText}</strong>
                                    </div>
                                </div>
                                <p class="text-muted small">
                                    <i class="bi bi-shield-check me-1"></i>${i18n.paymentSecureNote}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('paymentRedirectModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentRedirectModal')).show();

            // Redirect to payment URL after showing the modal
            if (paymentUrl) {
                try {
                    const urlObj = new URL(paymentUrl);
                    if (urlObj.protocol === 'https:' || urlObj.protocol === 'http:') {
                        setTimeout(() => {
                            window.location.href = paymentUrl;
                        }, 2000);
                    } else {
                        console.error('Invalid payment URL protocol:', urlObj.protocol);
                        showPaymentErrorModal(i18n.paymentErrorMsg);
                    }
                } catch (e) {
                    console.error('Invalid payment URL:', e);
                    showPaymentErrorModal(i18n.paymentErrorMsg);
                }
            }
        }

        function showPaymentDemoMessage(productName, amount) {
            const methodText = paymentMethod === 'alipay' ? i18n.paymentAlipay : i18n.paymentWechat;
            const modalHtml = `
                <div class="modal fade" id="paymentDemoModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>${i18n.paymentDemoTitle}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-lightbulb me-2"></i>
                                    <strong>${i18n.paymentDemoTitle}</strong>
                                </div>
                                <p>${i18n.paymentDemoMsg}</p>
                                <div class="bg-light rounded p-3 mb-3">
                                    <h6 class="mb-2">${i18n.paymentOrderDetails}</h6>
                                    <div class="d-flex justify-content-between">
                                        <span>${i18n.paymentProduct}</span><strong>${productName}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>${i18n.paymentPayAmount}</span><strong class="text-primary">¥${amount.toFixed(2)}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>${i18n.paymentMethod}</span><strong>${methodText}</strong>
                                    </div>
                                </div>
                                <p class="mb-0 text-muted small">
                                    <i class="bi bi-gear me-1"></i>
                                    ${i18n.paymentDemoNote}
                                </p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${i18n.paymentClose}</button>
                                <a href="/admin/vip" class="btn btn-primary" target="_blank">
                                    <i class="bi bi-gear me-2"></i>${i18n.paymentGoConfigure}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('paymentDemoModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentDemoModal')).show();
        }

        function showPaymentErrorModal(message) {
            const modalHtml = `
                <div class="modal fade" id="paymentErrorModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title"><i class="bi bi-exclamation-circle me-2"></i>${i18n.paymentErrorTitle}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-x-circle display-1 text-danger mb-3"></i>
                                <h5>${i18n.paymentErrorTitle}</h5>
                                <p class="text-muted">${message}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${i18n.paymentClose}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('paymentErrorModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentErrorModal')).show();
        }

        // Purchase VIP with balance
        async function purchaseVIPWithBalance(level, duration = 0) {
            const vip = vipLevels.find(v => v.level === level);
            if (!vip) return;

            // Check if this is an upgrade and calculate actual price
            const isUpgrade = currentUserVIPLevel > 0 && level > currentUserVIPLevel;
            let actualPrice = vip.price;
            let actualDuration = vip.duration;
            let originalPrice = vip.price;
            
            // If duration is specified and specifications exist, find matching spec
            if (duration > 0 && vip.specifications && vip.specifications.length > 0) {
                const spec = vip.specifications.find(s => s.duration === duration);
                if (spec) {
                    actualPrice = spec.price;
                    originalPrice = spec.price;
                    actualDuration = spec.duration;
                }
            }
            
            // Calculate prorated upgrade price based on remaining days and coefficient
            if (isUpgrade && vip.upgrade_coefficient > 0 && currentUserRemainingDays > 0 && currentUserVIPDailyPrice > 0) {
                // Prorated upgrade price = new price - (remaining days * old daily price * coefficient)
                const credit = currentUserRemainingDays * currentUserVIPDailyPrice * vip.upgrade_coefficient;
                actualPrice = Math.max(0, actualPrice - credit);
                // Round to 2 decimal places
                actualPrice = Math.round(actualPrice * 100) / 100;
            }

            const durationText = actualDuration > 0 ? `${actualDuration}${i18n.days}` : i18n.permanent;
            const confirmMsg = isUpgrade 
                ? i18n.upgradeConfirm.replace('%s', `${vip.name} (${durationText})`) 
                : i18n.purchaseConfirm.replace('%s', `${vip.name} (${durationText})`);
            const priceText = isUpgrade && actualPrice !== originalPrice 
                ? `${i18n.upgradePriceLabel}：¥${actualPrice.toFixed(2)}（${i18n.originalPrice}：¥${originalPrice.toFixed(2)}）`
                : `${i18n.priceLabel}：¥${actualPrice.toFixed(2)}`;

            const confirmed = await showConfirmModal(`${confirmMsg}\n\n${priceText}`, '', {
                confirmBtnClass: 'btn-success',
                confirmBtnText: i18n.confirmBtn
            });
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch('/api/auth/purchase-vip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level: level, duration: actualDuration })
                });

                const result = await response.json();
                if (result.success) {
                    // Update balance display
                    const balanceEl = document.getElementById('user-balance');
                    if (balanceEl && result.data) {
                        balanceEl.textContent = result.data.balance.toFixed(2);
                    }
                    
                    // Update current user VIP level
                    if (result.data && result.data.vip_level) {
                        currentUserVIPLevel = result.data.vip_level;
                    }
                    
                    showPurchaseSuccessModal(vip.name, result.data?.balance || 0, result.data?.is_upgrade || false);
                    renderVIPCards(); // Re-render to update button states
                } else {
                    showAlertModal(result.message || i18n.paymentErrorMsg, i18n.paymentErrorTitle);
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showAlertModal(i18n.paymentErrorMsg, i18n.paymentErrorTitle);
            }
        }

        function showPurchaseSuccessModal(vipName, newBalance, isUpgrade = false) {
            const title = isUpgrade ? i18n.upgradeSuccessTitle : i18n.purchaseSuccessTitle;
            const msg = isUpgrade ? i18n.upgradeSuccessMsg : i18n.purchaseSuccessMsg;
            const modalHtml = `
                <div class="modal fade" id="purchaseSuccessModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>${title}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-gem display-1 text-success mb-3"></i>
                                <h4>🎉</h4>
                                <p class="mb-3">${msg} <strong>${vipName}</strong></p>
                                <p class="text-muted">${i18n.currentBalance}：¥${newBalance.toFixed(2)}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="location.reload()">
                                    <i class="bi bi-check-lg me-2"></i>${i18n.confirmBtn}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('purchaseSuccessModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('purchaseSuccessModal')).show();
        }

        async function renewVIPWithBalance(level, duration = 0) {
            const vip = vipLevels.find(v => v.level === level);
            if (!vip) return;

            // Calculate actual price and duration
            let actualPrice = vip.price;
            let actualDuration = vip.duration;
            
            // If duration is specified and specifications exist, find matching spec
            if (duration > 0 && vip.specifications && vip.specifications.length > 0) {
                const spec = vip.specifications.find(s => s.duration === duration);
                if (spec) {
                    actualPrice = spec.price;
                    actualDuration = spec.duration;
                }
            }

            const durationText = actualDuration > 0 ? `${actualDuration}${i18n.days}` : i18n.permanent;
            const confirmMsg = i18n.renewConfirm.replace('%s', `${vip.name} (${durationText})`);
            const priceText = `${i18n.priceLabel}：¥${actualPrice.toFixed(2)}`;

            const confirmed = await showConfirmModal(`${confirmMsg}\n\n${priceText}`, '', {
                confirmBtnClass: 'btn-info',
                confirmBtnText: i18n.confirmBtn
            });
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch('/api/auth/renew-vip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level: level, duration: actualDuration })
                });

                const result = await response.json();
                if (result.success) {
                    // Update balance display
                    const balanceEl = document.getElementById('user-balance');
                    if (balanceEl && result.data) {
                        balanceEl.textContent = result.data.balance.toFixed(2);
                    }
                    
                    showRenewalSuccessModal(vip.name, result.data?.balance || 0, result.data?.vip_expire_at);
                    renderVIPCards(); // Re-render to update button states
                } else {
                    showAlertModal(result.message || i18n.paymentErrorMsg, i18n.paymentErrorTitle);
                }
            } catch (error) {
                console.error('Renewal error:', error);
                showAlertModal(i18n.paymentErrorMsg, i18n.paymentErrorTitle);
            }
        }

        function showRenewalSuccessModal(vipName, newBalance, newExpireAt) {
            let expireText = '';
            if (newExpireAt) {
                const expireDate = new Date(newExpireAt);
                expireText = `<p class="text-muted">${i18n.validity}：${expireDate.toLocaleDateString()}</p>`;
            } else {
                expireText = `<p class="text-muted">${i18n.validity}：${i18n.permanent}</p>`;
            }
            
            const modalHtml = `
                <div class="modal fade" id="renewalSuccessModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>${i18n.renewSuccessTitle}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-arrow-repeat display-1 text-info mb-3"></i>
                                <h4>🎉</h4>
                                <p class="mb-3">${i18n.renewSuccessMsg} <strong>${vipName}</strong></p>
                                ${expireText}
                                <p class="text-muted">${i18n.currentBalance}：¥${newBalance.toFixed(2)}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-info" data-bs-dismiss="modal" onclick="location.reload()">
                                    <i class="bi bi-check-lg me-2"></i>${i18n.confirmBtn}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('renewalSuccessModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('renewalSuccessModal')).show();
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/auth/login';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Language switcher function
        async function setLanguage(lang) {
            try {
                const response = await fetch('/api/i18n/set-language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lang: lang })
                });
                const data = await response.json();
                if (data.success) {
                    window.location.reload();
                }
            } catch (error) {
                console.error('Failed to set language:', error);
            }
        }
    </script>
    {{if .custom.GlobalHTML}}{{.custom.GlobalHTML}}{{end}}
</body>
</html>
