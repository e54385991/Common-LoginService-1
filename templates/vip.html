<!DOCTYPE html>
<html lang="{{.lang}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{if .siteTitle}}{{.siteTitle}}{{else}}{{t .lang "app.name"}}{{end}} - {{t .lang "vip.page_title"}}</title>
    <link href="/static/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/static/vendor/bootstrap-icons/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        .vip-hero {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 50%, #ff6347 100%);
            color: white;
            padding: 80px 0;
            position: relative;
            overflow: hidden;
        }
        .vip-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }
        .vip-hero .container {
            position: relative;
            z-index: 1;
        }
        .vip-hero h1 {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .balance-card {
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .balance-amount {
            font-size: 2.5rem;
            font-weight: 800;
        }
        .vip-badge {
            display: inline-flex;
            align-items: center;
            background: rgba(255,255,255,0.25);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 600;
        }
        .vip-section {
            padding: 80px 0;
            background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
        }
        .vip-card {
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            height: 100%;
            border: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .vip-card:hover {
            transform: translateY(-12px);
            box-shadow: 0 25px 60px rgba(0,0,0,0.2);
        }
        .vip-card.selected {
            box-shadow: 0 0 0 4px #ffd700, 0 25px 60px rgba(0,0,0,0.2);
        }
        .vip-header {
            padding: 40px 28px;
            text-align: center;
            color: white;
            position: relative;
        }
        .vip-popular {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.3);
            padding: 6px 14px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 700;
            backdrop-filter: blur(5px);
        }
        .vip-icon {
            font-size: 64px;
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }
        .vip-name {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }
        .vip-price {
            font-size: 3rem;
            font-weight: 900;
        }
        .vip-price small {
            font-size: 1rem;
            font-weight: 500;
            opacity: 0.9;
        }
        .vip-body {
            padding: 32px 28px;
            background: white;
        }
        .vip-description {
            color: #666;
            margin-bottom: 24px;
            min-height: 50px;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .vip-description > *:first-child {
            margin-top: 0 !important;
        }
        .vip-duration {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 24px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 10px;
            display: inline-block;
        }
        .vip-select-btn {
            width: 100%;
            padding: 14px;
            font-weight: 700;
            border-radius: 12px;
            transition: all 0.3s;
        }
        .vip-select-btn:hover:not(:disabled) {
            transform: scale(1.02);
        }
        .payment-modal .modal-content {
            border-radius: 20px;
            overflow: hidden;
            border: none;
        }
        .payment-modal .modal-header {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: white;
            border: none;
            padding: 24px 28px;
        }
        .payment-modal .modal-body {
            padding: 32px;
        }
        .payment-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .payment-methods {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }
        .payment-method {
            flex: 1;
            border: 2px solid #dee2e6;
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .payment-method:hover, .payment-method.selected {
            border-color: #ffd700;
        }
        .payment-method.selected {
            background: linear-gradient(135deg, #fffacd 0%, #fff8dc 100%);
        }
        .payment-method i {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        .not-logged-in-section {
            padding: 120px 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .upgrade-badge {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }
    </style>
    {{if .custom.GlobalCSS}}<style>{{.custom.GlobalCSS}}</style>{{end}}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-shield-lock-fill me-2"></i><span id="site-name">{{t .lang "app.name"}}</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-house me-1"></i>{{t .lang "nav.home"}}</a>
                    </li>
                    {{if .logged}}
                    <li class="nav-item">
                        <a class="nav-link" href="/profile"><i class="bi bi-person me-1"></i>{{t .lang "nav.profile_center"}}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/recharge"><i class="bi bi-wallet2 me-1"></i>{{t .lang "nav.recharge"}}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/vip"><i class="bi bi-gem me-1"></i>{{t .lang "nav.vip"}}</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            {{if .user.Avatar}}
                            <img src="{{.user.Avatar}}" alt="Avatar" class="rounded-circle me-1" width="24" height="24">
                            {{else}}
                            <i class="bi bi-person-circle me-1"></i>
                            {{end}}
                            {{.user.DisplayName}}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>{{t .lang "nav.profile_center"}}</a></li>
                            <li><a class="dropdown-item" href="/recharge"><i class="bi bi-wallet2 me-2"></i>{{t .lang "nav.recharge_center"}}</a></li>
                            <li><a class="dropdown-item" href="/vip"><i class="bi bi-gem me-2"></i>{{t .lang "nav.vip_member"}}</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>{{t .lang "nav.logout"}}</a></li>
                        </ul>
                    </li>
                    {{else}}
                    <li class="nav-item">
                        <a class="nav-link" href="/auth/login"><i class="bi bi-box-arrow-in-right me-1"></i>{{t .lang "nav.login"}}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/auth/register"><i class="bi bi-person-plus me-1"></i>{{t .lang "nav.register"}}</a>
                    </li>
                    {{end}}
                    <!-- Language Switcher -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="langDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-globe me-1"></i>{{if eq .lang "zh"}}ä¸­æ–‡{{else}}English{{end}}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item {{if eq .lang "en"}}active{{end}}" href="#" onclick="setLanguage('en')"><i class="bi bi-check2 me-2 {{if ne .lang "en"}}invisible{{end}}"></i>English</a></li>
                            <li><a class="dropdown-item {{if eq .lang "zh"}}active{{end}}" href="#" onclick="setLanguage('zh')"><i class="bi bi-check2 me-2 {{if ne .lang "zh"}}invisible{{end}}"></i>ä¸­æ–‡</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    {{if .logged}}
    <!-- Hero Section with Balance -->
    <section class="vip-hero">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="display-4 fw-bold mb-3"><i class="bi bi-gem me-3"></i>{{t .lang "vip.hero_title"}}</h1>
                    <p class="lead mb-4 opacity-90">{{t .lang "vip.hero_subtitle"}}</p>
                </div>
                <div class="col-lg-6">
                    <div class="balance-card">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <small class="d-block opacity-75 mb-1">{{t .lang "recharge.account_balance"}}</small>
                                <div class="balance-amount">Â¥<span id="user-balance">{{printf "%.2f" .user.Balance}}</span></div>
                            </div>
                            <div class="vip-badge">
                                {{if gt .user.VIPLevel 0}}
                                <i class="bi bi-gem me-2"></i>VIP {{.user.VIPLevel}}
                                {{else}}
                                <i class="bi bi-person me-2"></i>{{t .lang "recharge.vip_badge_normal"}}
                                {{end}}
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="/recharge" class="btn btn-light flex-grow-1">
                                <i class="bi bi-plus-circle me-2"></i>{{t .lang "recharge.recharge_now"}}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- VIP Cards Section -->
    <section class="vip-section" id="vip">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="display-6 fw-bold mb-3">{{t .lang "vip.section_title"}}</h2>
                <p class="text-muted fs-5">{{t .lang "vip.section_subtitle"}}</p>
            </div>
            <div class="row g-4" id="vip-cards-container">
                <!-- VIP cards will be rendered by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Payment Modal -->
    <div class="modal fade payment-modal" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>{{t .lang "payment.title"}}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="payment-info">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">{{t .lang "payment.product_name"}}</span>
                            <span id="payment-product-name">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">{{t .lang "payment.amount"}}</span>
                            <span class="fw-bold text-primary fs-4" id="payment-amount">Â¥0.00</span>
                        </div>
                    </div>
                    <p class="text-muted small mb-3">{{t .lang "payment.select_method"}}</p>
                    <div class="payment-methods">
                        <div class="payment-method selected" data-method="alipay">
                            <i class="bi bi-alipay text-primary d-block"></i>
                            <small>{{t .lang "payment.alipay"}}</small>
                        </div>
                        <div class="payment-method" data-method="wechat">
                            <i class="bi bi-wechat text-success d-block"></i>
                            <small>{{t .lang "payment.wechat"}}</small>
                        </div>
                    </div>
                    <button class="btn btn-warning w-100 py-3 fw-bold" onclick="submitPayment()">
                        <i class="bi bi-shield-check me-2"></i>{{t .lang "payment.confirm_btn"}}
                    </button>
                    <p class="text-center text-muted small mt-3 mb-0">
                        <i class="bi bi-lock me-1"></i>{{t .lang "payment.secure_note"}}
                    </p>
                </div>
            </div>
        </div>
    </div>

    {{else}}
    <!-- Not Logged In -->
    <section class="not-logged-in-section">
        <div class="container text-center">
            <i class="bi bi-gem display-1 text-warning mb-4"></i>
            <h2 class="fw-bold mb-3">{{t .lang "vip.login_required"}}</h2>
            <p class="text-muted mb-4 fs-5">{{t .lang "vip.login_required_desc"}}</p>
            <a href="/auth/login?redirect=/vip" class="btn btn-warning btn-lg px-5 py-3 fw-bold">
                <i class="bi bi-box-arrow-in-right me-2"></i>{{t .lang "vip.login_now"}}
            </a>
        </div>
    </section>
    {{end}}

    <!-- Footer -->
    <footer class="footer py-4 bg-dark text-white">
        <div class="container text-center">
            {{if .custom.FooterText}}<p class="mb-0">{{.custom.FooterText}}</p>{{else}}<p class="mb-0">&copy; 2024 <span id="footer-site-name">{{t .lang "app.name"}}</span>. {{t .lang "home.footer"}}</p>{{end}}
        </div>
    </footer>

    <script src="/static/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script>
        let vipLevels = [];
        let selectedVIPLevel = null;
        let paymentMethod = 'alipay';
        // Get current user's VIP level from the page
        let currentUserVIPLevel = {{if .user}}{{.user.VIPLevel}}{{else}}0{{end}};

        // I18n strings
        const i18n = {
            pageTitle: "{{t .lang "vip.page_title"}}",
            popular: "{{t .lang "vip.popular"}}",
            owned: "{{t .lang "vip.owned"}}",
            validity: "{{t .lang "vip.validity"}}",
            days: "{{t .lang "vip.days"}}",
            permanent: "{{t .lang "vip.permanent"}}",
            upgradeDiscount: "{{t .lang "vip.upgrade_discount"}}",
            balancePurchase: "{{t .lang "vip.balance_purchase"}}",
            balanceUpgrade: "{{t .lang "vip.balance_upgrade"}}",
            insufficientBalance: "{{t .lang "vip.insufficient_balance"}}",
            onlinePayment: "{{t .lang "vip.online_payment"}}",
            onlineUpgrade: "{{t .lang "vip.online_upgrade"}}",
            cannotPurchase: "{{t .lang "vip.cannot_purchase"}}",
            purchaseConfirm: "{{t .lang "vip.purchase_confirm"}}",
            upgradeConfirm: "{{t .lang "vip.upgrade_confirm"}}",
            priceLabel: "{{t .lang "vip.price_label"}}",
            upgradePriceLabel: "{{t .lang "vip.upgrade_price_label"}}",
            originalPrice: "{{t .lang "vip.original_price"}}",
            purchaseSuccessTitle: "{{t .lang "vip.purchase_success_title"}}",
            upgradeSuccessTitle: "{{t .lang "vip.upgrade_success_title"}}",
            purchaseSuccessMsg: "{{t .lang "vip.purchase_success_msg"}}",
            upgradeSuccessMsg: "{{t .lang "vip.upgrade_success_msg"}}",
            currentBalance: "{{t .lang "vip.current_balance"}}",
            confirmBtn: "{{t .lang "vip.confirm_btn"}}",
            paymentTitle: "{{t .lang "payment.title"}}",
            paymentProductName: "{{t .lang "payment.product_name"}}",
            paymentAmount: "{{t .lang "payment.amount"}}",
            paymentAlipay: "{{t .lang "payment.alipay"}}",
            paymentWechat: "{{t .lang "payment.wechat"}}",
            paymentConfirmBtn: "{{t .lang "payment.confirm_btn"}}",
            paymentSecureNote: "{{t .lang "payment.secure_note"}}",
            paymentProcessing: "{{t .lang "payment.processing"}}",
            paymentNotConfiguredTitle: "{{t .lang "payment.not_configured_title"}}",
            paymentNotConfiguredMsg: "{{t .lang "payment.not_configured_msg"}}",
            paymentOrderInfo: "{{t .lang "payment.order_info"}}",
            paymentClose: "{{t .lang "payment.close"}}",
            paymentRedirectTitle: "{{t .lang "payment.redirect_title"}}",
            paymentRedirectPreparing: "{{t .lang "payment.redirect_preparing"}}",
            paymentRedirectMsg: "{{t .lang "payment.redirect_msg"}}",
            paymentProduct: "{{t .lang "payment.product"}}",
            paymentPayAmount: "{{t .lang "payment.pay_amount"}}",
            paymentMethod: "{{t .lang "payment.method"}}",
            paymentDemoTitle: "{{t .lang "payment.demo_title"}}",
            paymentDemoMsg: "{{t .lang "payment.demo_msg"}}",
            paymentOrderDetails: "{{t .lang "payment.order_details"}}",
            paymentDemoNote: "{{t .lang "payment.demo_note"}}",
            paymentGoConfigure: "{{t .lang "payment.go_configure"}}",
            paymentErrorTitle: "{{t .lang "payment.error_title"}}",
            paymentErrorMsg: "{{t .lang "payment.error_msg"}}"
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadSiteSettings();
            loadVIPLevels();
            setupPaymentMethods();
        });

        async function loadSiteSettings() {
            try {
                const response = await fetch('/api/site-settings');
                const result = await response.json();
                if (result.success && result.data) {
                    if (result.data.title) {
                        document.getElementById('site-name').textContent = result.data.title;
                        document.getElementById('footer-site-name').textContent = result.data.title;
                        document.title = result.data.title + ' - ' + i18n.pageTitle;
                    }
                }
            } catch (error) {
                console.error('Failed to load site settings:', error);
            }
        }

        async function loadVIPLevels() {
            try {
                const response = await fetch('/api/vip-levels');
                const result = await response.json();
                if (result.success) {
                    vipLevels = result.data || [];
                    renderVIPCards();
                }
            } catch (error) {
                console.error('Failed to load VIP levels:', error);
            }
        }

        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            const num = parseInt(hex, 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
        }

        function renderVIPCards() {
            const container = document.getElementById('vip-cards-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            const userBalance = parseFloat(document.getElementById('user-balance')?.textContent || '0');
            
            vipLevels.forEach((level, index) => {
                const isPopular = index === Math.floor(vipLevels.length / 2);
                
                // Check if this level is lower than or equal to current user's VIP level
                const isDowngrade = level.level <= currentUserVIPLevel;
                const isUpgrade = currentUserVIPLevel > 0 && level.level > currentUserVIPLevel;
                
                // Calculate actual price (check for upgrade price)
                let actualPrice = level.price;
                let priceDisplay = `Â¥${level.price}`;
                let upgradeLabel = '';
                
                // Use string key for upgrade_prices lookup (JSON uses string keys)
                const currentLevelKey = String(currentUserVIPLevel);
                if (isUpgrade && level.upgrade_prices && level.upgrade_prices[currentLevelKey]) {
                    actualPrice = level.upgrade_prices[currentLevelKey];
                    priceDisplay = `<s class="text-light opacity-50 small">Â¥${level.price}</s> Â¥${actualPrice}`;
                    upgradeLabel = `<span class="upgrade-badge">${i18n.upgradeDiscount}</span>`;
                }
                
                const canAfford = userBalance >= actualPrice;
                
                // Duration text
                const durationText = level.duration > 0 ? `${level.duration} ${i18n.days}` : i18n.permanent;
                
                // Determine button states
                let balanceButtonHtml, paymentButtonHtml;
                
                if (isDowngrade) {
                    // Already have this level or higher - disable buttons
                    balanceButtonHtml = `
                        <button class="btn btn-outline-secondary vip-select-btn" disabled>
                            <i class="bi bi-check-circle me-2"></i>${i18n.owned}
                        </button>
                    `;
                    paymentButtonHtml = `
                        <button class="btn btn-outline-secondary vip-select-btn" disabled>
                            <i class="bi bi-ban me-2"></i>${i18n.cannotPurchase}
                        </button>
                    `;
                } else {
                    // Can purchase or upgrade
                    balanceButtonHtml = `
                        <button class="btn ${canAfford ? 'btn-success' : 'btn-outline-secondary'} vip-select-btn" 
                                onclick="event.stopPropagation(); purchaseVIPWithBalance(${level.level})"
                                ${!canAfford ? 'disabled' : ''}>
                            <i class="bi bi-wallet2 me-2"></i>${canAfford ? (isUpgrade ? i18n.balanceUpgrade : i18n.balancePurchase) : i18n.insufficientBalance}
                        </button>
                    `;
                    paymentButtonHtml = `
                        <button class="btn btn-outline-warning vip-select-btn" onclick="event.stopPropagation(); openVIPPayment(${level.level})">
                            <i class="bi bi-credit-card me-2"></i>${isUpgrade ? i18n.onlineUpgrade : i18n.onlinePayment}
                        </button>
                    `;
                }
                
                container.innerHTML += `
                    <div class="col-md-4">
                        <div class="vip-card shadow ${isDowngrade ? 'opacity-75' : ''}" data-level="${level.level}" ${!isDowngrade ? `onclick="selectVIPLevel(${level.level})"` : ''}>
                            <div class="vip-header" style="background: linear-gradient(135deg, ${level.color || '#ffd700'} 0%, ${adjustColor(level.color || '#ffd700', -30)} 100%)">
                                ${isPopular && !isDowngrade ? `<span class="vip-popular">${i18n.popular}</span>` : ''}
                                ${isDowngrade ? `<span class="vip-popular"><i class="bi bi-check-lg"></i> ${i18n.owned}</span>` : ''}
                                <div class="vip-icon"><i class="${level.icon || 'bi-star'}"></i></div>
                                <div class="vip-name">${level.name}${upgradeLabel}</div>
                                <div class="vip-price">${priceDisplay}<small>/${level.duration > 0 ? level.duration + i18n.days : i18n.permanent}</small></div>
                            </div>
                            <div class="vip-body text-center">
                                ${level.description ? `<p class="vip-description">${level.description}</p>` : ''}
                                <p class="vip-duration">
                                    <i class="bi bi-clock me-1"></i>
                                    ${i18n.validity}ï¼š${durationText}
                                </p>
                                <div class="d-grid gap-2">
                                    ${balanceButtonHtml}
                                    ${paymentButtonHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function selectVIPLevel(level) {
            selectedVIPLevel = level;
            document.querySelectorAll('.vip-card').forEach(card => {
                card.classList.remove('selected');
                if (parseInt(card.dataset.level) === level) {
                    card.classList.add('selected');
                }
            });
        }

        function setupPaymentMethods() {
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                    this.classList.add('selected');
                    paymentMethod = this.dataset.method;
                });
            });
        }

        function openVIPPayment(level) {
            const vip = vipLevels.find(v => v.level === level);
            if (!vip) return;
            
            selectedVIPLevel = level;
            
            // Calculate actual price for display (check for upgrade price)
            const isUpgrade = currentUserVIPLevel > 0 && level > currentUserVIPLevel;
            let displayPrice = vip.price;
            let productName = vip.name;
            
            if (isUpgrade) {
                productName = vip.name + ' (' + i18n.upgradeDiscount + ')';
                // Use string key for upgrade_prices lookup (JSON uses string keys)
                const currentLevelKey = String(currentUserVIPLevel);
                if (vip.upgrade_prices && vip.upgrade_prices[currentLevelKey]) {
                    displayPrice = vip.upgrade_prices[currentLevelKey];
                }
            }
            
            document.getElementById('payment-product-name').textContent = productName;
            document.getElementById('payment-amount').textContent = 'Â¥' + displayPrice.toFixed(2);
            
            new bootstrap.Modal(document.getElementById('paymentModal')).show();
        }

        async function submitPayment() {
            const vip = vipLevels.find(v => v.level === selectedVIPLevel);
            if (!vip) return;
            
            let amount = vip.price;
            let productName = vip.name;

            // Show loading state
            const submitBtn = document.querySelector('#paymentModal .btn-warning');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${i18n.paymentProcessing}`;

            try {
                // Check if payment is configured
                const settingsRes = await fetch('/api/site-settings');
                const settings = await settingsRes.json();
                
                if (!settings.success || !settings.data.payment_enabled) {
                    // Show configuration required modal
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentNotConfiguredModal(productName, amount);
                    return;
                }

                // Call backend payment API
                const paymentRes = await fetch('/api/payment/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_type: 'vip',
                        product_id: selectedVIPLevel,
                        amount: amount,
                        payment_method: paymentMethod
                    })
                });

                const paymentResult = await paymentRes.json();
                
                if (!paymentResult.success) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentErrorModal(paymentResult.message || i18n.paymentErrorMsg);
                    return;
                }

                // Check if in demo mode
                if (paymentResult.demo_mode) {
                    // Show demo mode modal
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentDemoMessage(productName, amount);
                    return;
                }

                // In production mode, redirect to PyPay
                if (paymentResult.data && paymentResult.data.payment_url) {
                    // Show redirect modal then redirect
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentRedirectModal(productName, amount, paymentResult.data.payment_url);
                } else {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    showPaymentErrorModal(i18n.paymentErrorMsg);
                }
                
            } catch (error) {
                console.error('Payment error:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                showPaymentErrorModal(i18n.paymentErrorMsg);
            }
        }

        function showPaymentNotConfiguredModal(productName, amount) {
            const modalHtml = `
                <div class="modal fade" id="paymentNotConfiguredModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>${i18n.paymentNotConfiguredTitle}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-gear display-1 text-muted mb-3"></i>
                                <h5>${i18n.paymentNotConfiguredTitle}</h5>
                                <p class="text-muted mb-4">${i18n.paymentNotConfiguredMsg}</p>
                                <div class="bg-light rounded p-3 mb-3">
                                    <small class="text-muted d-block">${i18n.paymentOrderInfo}</small>
                                    <strong>${productName}</strong>
                                    <span class="text-primary ms-2">Â¥${amount.toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${i18n.paymentClose}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('paymentNotConfiguredModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentNotConfiguredModal')).show();
        }

        function showPaymentRedirectModal(productName, amount, paymentUrl = '') {
            const methodText = paymentMethod === 'alipay' ? i18n.paymentAlipay : i18n.paymentWechat;
            const modalHtml = `
                <div class="modal fade" id="paymentRedirectModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%); color: white;">
                                <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>${i18n.paymentRedirectTitle}</h5>
                            </div>
                            <div class="modal-body text-center py-5">
                                <div class="spinner-border text-warning mb-4" style="width: 3rem; height: 3rem;" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h5>${i18n.paymentRedirectPreparing}</h5>
                                <p class="text-muted mb-4">${i18n.paymentRedirectMsg}</p>
                                <div class="bg-light rounded p-3 mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">${i18n.paymentProduct}</span>
                                        <strong>${productName}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span class="text-muted">${i18n.paymentPayAmount}</span>
                                        <strong class="text-primary">Â¥${amount.toFixed(2)}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span class="text-muted">${i18n.paymentMethod}</span>
                                        <strong>${methodText}</strong>
                                    </div>
                                </div>
                                <p class="text-muted small">
                                    <i class="bi bi-shield-check me-1"></i>${i18n.paymentSecureNote}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('paymentRedirectModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentRedirectModal')).show();

            // Redirect to payment URL after showing the modal
            if (paymentUrl) {
                try {
                    const urlObj = new URL(paymentUrl);
                    if (urlObj.protocol === 'https:' || urlObj.protocol === 'http:') {
                        setTimeout(() => {
                            window.location.href = paymentUrl;
                        }, 2000);
                    } else {
                        console.error('Invalid payment URL protocol:', urlObj.protocol);
                        showPaymentErrorModal(i18n.paymentErrorMsg);
                    }
                } catch (e) {
                    console.error('Invalid payment URL:', e);
                    showPaymentErrorModal(i18n.paymentErrorMsg);
                }
            }
        }

        function showPaymentDemoMessage(productName, amount) {
            const methodText = paymentMethod === 'alipay' ? i18n.paymentAlipay : i18n.paymentWechat;
            const modalHtml = `
                <div class="modal fade" id="paymentDemoModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>${i18n.paymentDemoTitle}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-lightbulb me-2"></i>
                                    <strong>${i18n.paymentDemoTitle}</strong>
                                </div>
                                <p>${i18n.paymentDemoMsg}</p>
                                <div class="bg-light rounded p-3 mb-3">
                                    <h6 class="mb-2">${i18n.paymentOrderDetails}</h6>
                                    <div class="d-flex justify-content-between">
                                        <span>${i18n.paymentProduct}</span><strong>${productName}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>${i18n.paymentPayAmount}</span><strong class="text-primary">Â¥${amount.toFixed(2)}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>${i18n.paymentMethod}</span><strong>${methodText}</strong>
                                    </div>
                                </div>
                                <p class="mb-0 text-muted small">
                                    <i class="bi bi-gear me-1"></i>
                                    ${i18n.paymentDemoNote}
                                </p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${i18n.paymentClose}</button>
                                <a href="/admin/vip" class="btn btn-primary" target="_blank">
                                    <i class="bi bi-gear me-2"></i>${i18n.paymentGoConfigure}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('paymentDemoModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentDemoModal')).show();
        }

        function showPaymentErrorModal(message) {
            const modalHtml = `
                <div class="modal fade" id="paymentErrorModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title"><i class="bi bi-exclamation-circle me-2"></i>${i18n.paymentErrorTitle}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-x-circle display-1 text-danger mb-3"></i>
                                <h5>${i18n.paymentErrorTitle}</h5>
                                <p class="text-muted">${message}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${i18n.paymentClose}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('paymentErrorModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentErrorModal')).show();
        }

        // Purchase VIP with balance
        async function purchaseVIPWithBalance(level) {
            const vip = vipLevels.find(v => v.level === level);
            if (!vip) return;

            // Check if this is an upgrade and calculate actual price
            const isUpgrade = currentUserVIPLevel > 0 && level > currentUserVIPLevel;
            let actualPrice = vip.price;
            
            // Use string key for upgrade_prices lookup (JSON uses string keys)
            const currentLevelKey = String(currentUserVIPLevel);
            if (isUpgrade && vip.upgrade_prices && vip.upgrade_prices[currentLevelKey]) {
                actualPrice = vip.upgrade_prices[currentLevelKey];
            }

            const confirmMsg = isUpgrade 
                ? i18n.upgradeConfirm.replace('%s', vip.name) 
                : i18n.purchaseConfirm.replace('%s', vip.name);
            const priceText = isUpgrade && actualPrice !== vip.price 
                ? `${i18n.upgradePriceLabel}ï¼šÂ¥${actualPrice.toFixed(2)}ï¼ˆ${i18n.originalPrice}ï¼šÂ¥${vip.price.toFixed(2)}ï¼‰`
                : `${i18n.priceLabel}ï¼šÂ¥${actualPrice.toFixed(2)}`;

            if (!confirm(`${confirmMsg}\n\n${priceText}`)) {
                return;
            }

            try {
                const response = await fetch('/api/auth/purchase-vip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level: level })
                });

                const result = await response.json();
                if (result.success) {
                    // Update balance display
                    const balanceEl = document.getElementById('user-balance');
                    if (balanceEl && result.data) {
                        balanceEl.textContent = result.data.balance.toFixed(2);
                    }
                    
                    // Update current user VIP level
                    if (result.data && result.data.vip_level) {
                        currentUserVIPLevel = result.data.vip_level;
                    }
                    
                    showPurchaseSuccessModal(vip.name, result.data?.balance || 0, result.data?.is_upgrade || false);
                    renderVIPCards(); // Re-render to update button states
                } else {
                    alert(result.message || i18n.paymentErrorMsg);
                }
            } catch (error) {
                console.error('Purchase error:', error);
                alert(i18n.paymentErrorMsg);
            }
        }

        function showPurchaseSuccessModal(vipName, newBalance, isUpgrade = false) {
            const title = isUpgrade ? i18n.upgradeSuccessTitle : i18n.purchaseSuccessTitle;
            const msg = isUpgrade ? i18n.upgradeSuccessMsg : i18n.purchaseSuccessMsg;
            const modalHtml = `
                <div class="modal fade" id="purchaseSuccessModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>${title}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-gem display-1 text-success mb-3"></i>
                                <h4>ðŸŽ‰</h4>
                                <p class="mb-3">${msg} <strong>${vipName}</strong></p>
                                <p class="text-muted">${i18n.currentBalance}ï¼šÂ¥${newBalance.toFixed(2)}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="location.reload()">
                                    <i class="bi bi-check-lg me-2"></i>${i18n.confirmBtn}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('purchaseSuccessModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('purchaseSuccessModal')).show();
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/auth/login';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Language switcher function
        async function setLanguage(lang) {
            try {
                const response = await fetch('/api/i18n/set-language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lang: lang })
                });
                const data = await response.json();
                if (data.success) {
                    window.location.reload();
                }
            } catch (error) {
                console.error('Failed to set language:', error);
            }
        }
    </script>
    {{if .custom.GlobalHTML}}{{.custom.GlobalHTML}}{{end}}
</body>
</html>
