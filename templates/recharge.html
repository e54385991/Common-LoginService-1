<!DOCTYPE html>
<html lang="{{.lang}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{if .siteTitle}}{{.siteTitle}}{{else}}{{t .lang "app.name"}}{{end}} - 充值中心</title>
    <link href="/static/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/static/vendor/bootstrap-icons/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        .recharge-hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 0;
        }
        .balance-card {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        .balance-amount {
            font-size: 3rem;
            font-weight: 800;
        }
        .vip-badge {
            display: inline-flex;
            align-items: center;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        .vip-card {
            border-radius: 16px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
            border: none;
        }
        .vip-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        .vip-card.selected {
            box-shadow: 0 0 0 3px #667eea, 0 15px 40px rgba(0,0,0,0.15);
        }
        .vip-header {
            padding: 30px 24px;
            text-align: center;
            color: white;
            position: relative;
        }
        .vip-popular {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255,255,255,0.3);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .vip-icon {
            font-size: 56px;
            margin-bottom: 16px;
        }
        .vip-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .vip-price {
            font-size: 2.8rem;
            font-weight: 800;
        }
        .vip-price small {
            font-size: 1rem;
            font-weight: 400;
            opacity: 0.9;
        }
        .vip-body {
            padding: 28px 24px;
            background: white;
        }
        .vip-description {
            color: #666;
            margin-bottom: 20px;
            min-height: 48px;
            font-size: 0.95rem;
        }
        .vip-description > *:first-child {
            margin-top: 0 !important;
        }
        .vip-duration {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        .vip-select-btn {
            width: 100%;
            padding: 12px;
            font-weight: 600;
            border-radius: 10px;
        }
        .recharge-section {
            padding: 60px 0;
            background: #f8f9fa;
        }
        .recharge-amount-card {
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        .recharge-amount-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
        }
        .recharge-amount-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .recharge-amount-card .amount {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .recharge-amount-card .bonus {
            font-size: 0.85rem;
            color: #28a745;
            margin-top: 4px;
        }
        .recharge-amount-card.selected .bonus {
            color: rgba(255,255,255,0.9);
        }
        .payment-modal .modal-content {
            border-radius: 16px;
            overflow: hidden;
        }
        .payment-modal .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 24px;
        }
        .payment-modal .modal-body {
            padding: 30px;
        }
        .payment-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .payment-methods {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .payment-method {
            flex: 1;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .payment-method:hover, .payment-method.selected {
            border-color: #667eea;
        }
        .payment-method.selected {
            background: #f0f0ff;
        }
        .payment-method i {
            font-size: 2rem;
            margin-bottom: 8px;
        }
    </style>
    {{if .custom.GlobalCSS}}<style>{{.custom.GlobalCSS}}</style>{{end}}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-shield-lock-fill me-2"></i><span id="site-name">{{t .lang "app.name"}}</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="bi bi-house me-1"></i>{{t .lang "nav.home"}}</a>
                    </li>
                    {{if .logged}}
                    <li class="nav-item">
                        <a class="nav-link" href="/profile"><i class="bi bi-person me-1"></i>{{t .lang "nav.profile_center"}}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/recharge"><i class="bi bi-wallet2 me-1"></i>{{t .lang "nav.recharge"}}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#vip"><i class="bi bi-gem me-1"></i>{{t .lang "nav.vip"}}</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            {{if .user.Avatar}}
                            <img src="{{.user.Avatar}}" alt="Avatar" class="rounded-circle me-1" width="24" height="24">
                            {{else}}
                            <i class="bi bi-person-circle me-1"></i>
                            {{end}}
                            {{.user.DisplayName}}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>{{t .lang "nav.profile_center"}}</a></li>
                            <li><a class="dropdown-item" href="/recharge"><i class="bi bi-wallet2 me-2"></i>{{t .lang "nav.recharge_center"}}</a></li>
                            <li><a class="dropdown-item" href="#vip"><i class="bi bi-gem me-2"></i>{{t .lang "nav.vip_member"}}</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>{{t .lang "nav.logout"}}</a></li>
                        </ul>
                    </li>
                    {{else}}
                    <li class="nav-item">
                        <a class="nav-link" href="/auth/login"><i class="bi bi-box-arrow-in-right me-1"></i>{{t .lang "nav.login"}}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/auth/register"><i class="bi bi-person-plus me-1"></i>{{t .lang "nav.register"}}</a>
                    </li>
                    {{end}}
                    <!-- Language Switcher -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="langDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-globe me-1"></i>{{if eq .lang "zh"}}中文{{else}}English{{end}}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item {{if eq .lang "en"}}active{{end}}" href="#" onclick="setLanguage('en')"><i class="bi bi-check2 me-2 {{if ne .lang "en"}}invisible{{end}}"></i>English</a></li>
                            <li><a class="dropdown-item {{if eq .lang "zh"}}active{{end}}" href="#" onclick="setLanguage('zh')"><i class="bi bi-check2 me-2 {{if ne .lang "zh"}}invisible{{end}}"></i>中文</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    {{if .logged}}
    <!-- Hero Section with Balance -->
    <section class="recharge-hero">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="display-5 fw-bold mb-3">充值中心</h1>
                    <p class="lead mb-4">购买VIP会员享受更多专属特权</p>
                </div>
                <div class="col-lg-6">
                    <div class="balance-card">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <small class="d-block opacity-75 mb-1">账户余额</small>
                                <div class="balance-amount">¥<span id="user-balance">{{printf "%.2f" .user.Balance}}</span></div>
                            </div>
                            <div class="vip-badge">
                                {{if gt .user.VIPLevel 0}}
                                <i class="bi bi-gem me-2"></i>VIP {{.user.VIPLevel}}
                                {{else}}
                                <i class="bi bi-person me-2"></i>普通用户
                                {{end}}
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="#recharge" class="btn btn-light flex-grow-1">
                                <i class="bi bi-plus-circle me-2"></i>立即充值
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- VIP Cards Section -->
    <section class="py-5" id="vip">
        <div class="container">
            <h2 class="text-center mb-2">开通VIP会员</h2>
            <p class="text-center text-muted mb-5">选择适合您的会员套餐，可用余额购买或在线支付</p>
            <div class="row g-4" id="vip-cards-container">
                <!-- VIP cards will be rendered by JavaScript -->
            </div>
        </div>
    </section>

    <!-- Gift Card Section -->
    <section class="py-5 bg-light">
        <div class="container">
            <h2 class="text-center mb-2">礼品卡兑换</h2>
            <p class="text-center text-muted mb-4">输入礼品卡码，余额或VIP会员将自动添加到您的账户</p>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card shadow-sm">
                        <div class="card-body p-4">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text"><i class="bi bi-gift"></i></span>
                                <input type="text" class="form-control font-monospace" id="gift-card-code" placeholder="XXXX-XXXX-XXXX-XXXX" maxlength="19">
                                <button class="btn btn-success" onclick="redeemGiftCard()">
                                    <i class="bi bi-check-lg me-1"></i>兑换
                                </button>
                            </div>
                            <small class="text-muted mt-2 d-block text-center">请输入16位礼品卡码（格式：XXXX-XXXX-XXXX-XXXX）</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Recharge Section -->
    <section class="recharge-section" id="recharge">
        <div class="container">
            <h2 class="text-center mb-2">账户充值</h2>
            <p class="text-center text-muted mb-5">选择充值金额，余额可用于购买VIP和其他服务</p>
            <div class="row g-3 justify-content-center" id="recharge-amounts-container">
                <!-- Recharge amounts will be rendered by JavaScript -->
            </div>
            <div class="text-center mt-4">
                <div class="row justify-content-center">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control" id="custom-amount" placeholder="自定义金额" min="1" step="0.01">
                            <button class="btn btn-primary" onclick="selectCustomAmount()">
                                <i class="bi bi-check-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <button class="btn btn-primary btn-lg px-5" onclick="openPaymentModal('recharge')" id="recharge-btn" disabled>
                    <i class="bi bi-credit-card me-2"></i>立即充值
                </button>
            </div>
        </div>
    </section>

    <!-- Payment Modal -->
    <div class="modal fade payment-modal" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>确认支付</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="payment-info">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">商品名称</span>
                            <span id="payment-product-name">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">支付金额</span>
                            <span class="fw-bold text-primary fs-4" id="payment-amount">¥0.00</span>
                        </div>
                    </div>
                    <p class="text-muted small mb-3">选择支付方式</p>
                    <div class="payment-methods">
                        <div class="payment-method selected" data-method="alipay">
                            <i class="bi bi-alipay text-primary d-block"></i>
                            <small>支付宝</small>
                        </div>
                        <div class="payment-method" data-method="wechat">
                            <i class="bi bi-wechat text-success d-block"></i>
                            <small>微信支付</small>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 py-3" onclick="submitPayment()">
                        <i class="bi bi-shield-check me-2"></i>确认支付
                    </button>
                    <p class="text-center text-muted small mt-3 mb-0">
                        <i class="bi bi-lock me-1"></i>安全支付由 PyPay 提供
                    </p>
                </div>
            </div>
        </div>
    </div>

    {{else}}
    <!-- Not Logged In -->
    <section class="py-5">
        <div class="container text-center">
            <i class="bi bi-person-lock display-1 text-muted mb-4"></i>
            <h2>请先登录</h2>
            <p class="text-muted mb-4">您需要登录后才能进行充值和购买VIP</p>
            <a href="/auth/login?redirect=/recharge" class="btn btn-primary btn-lg">
                <i class="bi bi-box-arrow-in-right me-2"></i>立即登录
            </a>
        </div>
    </section>
    {{end}}

    <!-- Footer -->
    <footer class="footer py-4 bg-dark text-white">
        <div class="container text-center">
            {{if .custom.FooterText}}<p class="mb-0">{{.custom.FooterText}}</p>{{else}}<p class="mb-0">&copy; 2024 <span id="footer-site-name">{{t .lang "app.name"}}</span>. {{t .lang "home.footer"}}</p>{{end}}
        </div>
    </footer>

    <script src="/static/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script>
        let vipLevels = [];
        let selectedVIPLevel = null;
        let selectedRechargeAmount = 0;
        let paymentType = 'recharge'; // 'recharge' or 'vip'
        let paymentMethod = 'alipay';
        // Get current user's VIP level from the page
        let currentUserVIPLevel = {{if .user}}{{.user.VIPLevel}}{{else}}0{{end}};

        // I18n strings for gift card VIP warning
        const i18nStrings = {
            vipWarningTitle: "{{t .lang "gift_card.vip_warning_title"}}",
            vipWarningMessage: "{{t .lang "gift_card.vip_warning_message"}}",
            vipWarningCurrent: "{{t .lang "gift_card.vip_warning_current"}}",
            vipWarningCardVip: "{{t .lang "gift_card.vip_warning_card_vip"}}",
            vipWarningExpires: "{{t .lang "gift_card.vip_warning_expires"}}",
            vipWarningPermanent: "{{t .lang "gift_card.vip_warning_permanent"}}",
            vipWarningDays: "{{t .lang "gift_card.vip_warning_days"}}",
            vipWarningConfirm: "{{t .lang "gift_card.vip_warning_confirm"}}",
            vipWarningCancel: "{{t .lang "gift_card.vip_warning_cancel"}}",
            vipWarningBalanceNote: "{{t .lang "gift_card.vip_warning_balance_note"}}",
            vipSkipped: "{{t .lang "gift_card.vip_skipped"}}",
            balance: "{{t .lang "gift_card.balance"}}",
            balanceAdded: "{{t .lang "gift_card.balance_added"}}",
            vipGranted: "{{t .lang "gift_card.vip_granted"}}",
            redeemSuccess: "{{t .lang "gift_card.redeem_success"}}",
            redeemSuccessTitle: "{{t .lang "gift_card.redeem_success_title"}}",
            currentBalance: "{{t .lang "gift_card.current_balance"}}",
            confirmBtn: "{{t .lang "gift_card.confirm_btn"}}"
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadSiteSettings();
            loadVIPLevels();
            setupPaymentMethods();
        });

        async function loadSiteSettings() {
            try {
                const response = await fetch('/api/site-settings');
                const result = await response.json();
                if (result.success && result.data) {
                    if (result.data.title) {
                        document.getElementById('site-name').textContent = result.data.title;
                        document.getElementById('footer-site-name').textContent = result.data.title;
                        document.title = result.data.title + ' - 充值中心';
                    }
                }
            } catch (error) {
                console.error('Failed to load site settings:', error);
            }
        }

        async function loadVIPLevels() {
            try {
                const response = await fetch('/api/vip-levels');
                const result = await response.json();
                if (result.success) {
                    vipLevels = result.data || [];
                    renderVIPCards();
                    renderRechargeAmounts();
                }
            } catch (error) {
                console.error('Failed to load VIP levels:', error);
            }
        }

        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            const num = parseInt(hex, 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
        }

        function renderVIPCards() {
            const container = document.getElementById('vip-cards-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            const userBalance = parseFloat(document.getElementById('user-balance')?.textContent || '0');
            
            vipLevels.forEach((level, index) => {
                const isPopular = index === Math.floor(vipLevels.length / 2);
                
                // Check if this level is lower than or equal to current user's VIP level
                const isDowngrade = level.level <= currentUserVIPLevel;
                const isUpgrade = currentUserVIPLevel > 0 && level.level > currentUserVIPLevel;
                
                // Calculate actual price (check for upgrade price)
                let actualPrice = level.price;
                let priceDisplay = `¥${level.price}`;
                let upgradeLabel = '';
                
                // Use string key for upgrade_prices lookup (JSON uses string keys)
                const currentLevelKey = String(currentUserVIPLevel);
                if (isUpgrade && level.upgrade_prices && level.upgrade_prices[currentLevelKey]) {
                    actualPrice = level.upgrade_prices[currentLevelKey];
                    priceDisplay = `<s class="text-muted small">¥${level.price}</s> ¥${actualPrice}`;
                    upgradeLabel = '<span class="badge bg-success ms-2">升级优惠</span>';
                }
                
                const canAfford = userBalance >= actualPrice;
                
                // Determine button states
                let balanceButtonHtml, paymentButtonHtml;
                
                if (isDowngrade) {
                    // Already have this level or higher - disable buttons
                    balanceButtonHtml = `
                        <button class="btn btn-outline-secondary vip-select-btn" disabled>
                            <i class="bi bi-check-circle me-2"></i>已拥有
                        </button>
                    `;
                    paymentButtonHtml = `
                        <button class="btn btn-outline-secondary vip-select-btn" disabled>
                            <i class="bi bi-ban me-2"></i>无法购买
                        </button>
                    `;
                } else {
                    // Can purchase or upgrade
                    balanceButtonHtml = `
                        <button class="btn ${canAfford ? 'btn-success' : 'btn-outline-secondary'} vip-select-btn" 
                                onclick="event.stopPropagation(); purchaseVIPWithBalance(${level.level})"
                                ${!canAfford ? 'disabled' : ''}>
                            <i class="bi bi-wallet2 me-2"></i>${canAfford ? (isUpgrade ? '余额升级' : '余额购买') : '余额不足'}
                        </button>
                    `;
                    paymentButtonHtml = `
                        <button class="btn btn-outline-primary vip-select-btn" onclick="event.stopPropagation(); openVIPPayment(${level.level})">
                            <i class="bi bi-credit-card me-2"></i>${isUpgrade ? '在线升级' : '在线支付'}
                        </button>
                    `;
                }
                
                container.innerHTML += `
                    <div class="col-md-4">
                        <div class="vip-card shadow ${isDowngrade ? 'opacity-75' : ''}" data-level="${level.level}" ${!isDowngrade ? `onclick="selectVIPLevel(${level.level})"` : ''}>
                            <div class="vip-header" style="background: linear-gradient(135deg, ${level.color || '#ffd700'} 0%, ${adjustColor(level.color || '#ffd700', -30)} 100%)">
                                ${isPopular && !isDowngrade ? '<span class="vip-popular">热门</span>' : ''}
                                ${isDowngrade ? '<span class="vip-popular"><i class="bi bi-check-lg"></i> 已拥有</span>' : ''}
                                <div class="vip-icon"><i class="${level.icon || 'bi-star'}"></i></div>
                                <div class="vip-name">${level.name}${upgradeLabel}</div>
                                <div class="vip-price">${priceDisplay}<small>/${level.duration > 0 ? level.duration + '天' : '永久'}</small></div>
                            </div>
                            <div class="vip-body text-center">
                                ${level.description ? `<p class="vip-description">${level.description}</p>` : ''}
                                <p class="vip-duration">
                                    <i class="bi bi-clock me-1"></i>
                                    有效期：${level.duration > 0 ? level.duration + ' 天' : '永久'}
                                </p>
                                <div class="d-grid gap-2">
                                    ${balanceButtonHtml}
                                    ${paymentButtonHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function renderRechargeAmounts() {
            const container = document.getElementById('recharge-amounts-container');
            if (!container) return;
            
            const amounts = [
                { value: 10, bonus: '' },
                { value: 30, bonus: '' },
                { value: 50, bonus: '送 ¥2' },
                { value: 100, bonus: '送 ¥5' },
                { value: 200, bonus: '送 ¥15' },
                { value: 500, bonus: '送 ¥50' }
            ];
            
            container.innerHTML = '';
            amounts.forEach(item => {
                container.innerHTML += `
                    <div class="col-6 col-md-2">
                        <div class="recharge-amount-card" data-amount="${item.value}" onclick="selectRechargeAmount(${item.value})">
                            <div class="amount">¥${item.value}</div>
                            ${item.bonus ? `<div class="bonus">${item.bonus}</div>` : '<div class="bonus">&nbsp;</div>'}
                        </div>
                    </div>
                `;
            });
        }

        function selectVIPLevel(level) {
            selectedVIPLevel = level;
            document.querySelectorAll('.vip-card').forEach(card => {
                card.classList.remove('selected');
                if (parseInt(card.dataset.level) === level) {
                    card.classList.add('selected');
                }
            });
        }

        function selectRechargeAmount(amount) {
            selectedRechargeAmount = amount;
            document.querySelectorAll('.recharge-amount-card').forEach(card => {
                card.classList.remove('selected');
                if (parseFloat(card.dataset.amount) === amount) {
                    card.classList.add('selected');
                }
            });
            document.getElementById('custom-amount').value = '';
            document.getElementById('recharge-btn').disabled = false;
        }

        function selectCustomAmount() {
            const input = document.getElementById('custom-amount');
            const amount = parseFloat(input.value);
            if (amount > 0) {
                selectedRechargeAmount = amount;
                document.querySelectorAll('.recharge-amount-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.getElementById('recharge-btn').disabled = false;
            }
        }

        function setupPaymentMethods() {
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                    this.classList.add('selected');
                    paymentMethod = this.dataset.method;
                });
            });
        }

        function openVIPPayment(level) {
            const vip = vipLevels.find(v => v.level === level);
            if (!vip) return;
            
            paymentType = 'vip';
            selectedVIPLevel = level;
            
            // Calculate actual price for display (check for upgrade price)
            const isUpgrade = currentUserVIPLevel > 0 && level > currentUserVIPLevel;
            let displayPrice = vip.price;
            let productName = vip.name;
            
            if (isUpgrade) {
                productName = vip.name + ' (升级)';
                // Use string key for upgrade_prices lookup (JSON uses string keys)
                const currentLevelKey = String(currentUserVIPLevel);
                if (vip.upgrade_prices && vip.upgrade_prices[currentLevelKey]) {
                    displayPrice = vip.upgrade_prices[currentLevelKey];
                }
            }
            
            document.getElementById('payment-product-name').textContent = productName;
            document.getElementById('payment-amount').textContent = '¥' + displayPrice.toFixed(2);
            
            new bootstrap.Modal(document.getElementById('paymentModal')).show();
        }

        function openPaymentModal(type) {
            paymentType = type;
            
            if (type === 'recharge') {
                if (selectedRechargeAmount <= 0) {
                    alert('请选择充值金额');
                    return;
                }
                document.getElementById('payment-product-name').textContent = '账户充值';
                document.getElementById('payment-amount').textContent = '¥' + selectedRechargeAmount.toFixed(2);
            }
            
            new bootstrap.Modal(document.getElementById('paymentModal')).show();
        }

        async function submitPayment() {
            let amount, productName, productType, productId;
            
            if (paymentType === 'vip') {
                const vip = vipLevels.find(v => v.level === selectedVIPLevel);
                if (!vip) return;
                amount = vip.price;
                productName = vip.name;
                productType = 'vip';
                productId = vip.level;
            } else {
                amount = selectedRechargeAmount;
                productName = '账户充值';
                productType = 'recharge';
                productId = 0;
            }

            // Show loading state
            const submitBtn = document.querySelector('#paymentModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>处理中...';

            try {
                // Check if payment is configured
                const settingsRes = await fetch('/api/site-settings');
                const settings = await settingsRes.json();
                
                if (!settings.success || !settings.data.payment_enabled) {
                    // Show configuration required modal
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentNotConfiguredModal(productName, amount);
                    return;
                }

                // Call backend payment API
                const paymentRes = await fetch('/api/payment/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_type: productType,
                        product_id: productId,
                        amount: amount,
                        payment_method: paymentMethod
                    })
                });

                const paymentResult = await paymentRes.json();
                
                if (!paymentResult.success) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentErrorModal(paymentResult.message || '支付请求失败');
                    return;
                }

                // Check if in demo mode
                if (paymentResult.demo_mode) {
                    // Show demo mode modal
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentDemoMessage(productName, amount);
                    return;
                }

                // In production mode, redirect to PyPay
                if (paymentResult.data && paymentResult.data.payment_url) {
                    // Show redirect modal then redirect
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentRedirectModal(productName, amount, paymentResult.data.payment_url);
                } else {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    showPaymentErrorModal('支付链接获取失败，请稍后重试');
                }
                
            } catch (error) {
                console.error('Payment error:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                showPaymentErrorModal('支付请求失败，请稍后重试');
            }
        }

        function showPaymentNotConfiguredModal(productName, amount) {
            const modalHtml = `
                <div class="modal fade" id="paymentNotConfiguredModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>支付未配置</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-gear display-1 text-muted mb-3"></i>
                                <h5>支付功能暂未启用</h5>
                                <p class="text-muted mb-4">管理员尚未配置支付网关，请联系管理员或稍后再试。</p>
                                <div class="bg-light rounded p-3 mb-3">
                                    <small class="text-muted d-block">订单信息</small>
                                    <strong>${productName}</strong>
                                    <span class="text-primary ms-2">¥${amount.toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existing = document.getElementById('paymentNotConfiguredModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentNotConfiguredModal')).show();
        }

        function showPaymentRedirectModal(productName, amount, paymentUrl = '') {
            const modalHtml = `
                <div class="modal fade" id="paymentRedirectModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>正在跳转支付</h5>
                            </div>
                            <div class="modal-body text-center py-5">
                                <div class="spinner-border text-primary mb-4" style="width: 3rem; height: 3rem;" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h5>正在准备支付页面...</h5>
                                <p class="text-muted mb-4">请稍候，即将跳转到安全支付页面</p>
                                <div class="bg-light rounded p-3 mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">商品</span>
                                        <strong>${productName}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span class="text-muted">金额</span>
                                        <strong class="text-primary">¥${amount.toFixed(2)}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span class="text-muted">支付方式</span>
                                        <strong>${paymentMethod === 'alipay' ? '支付宝' : '微信支付'}</strong>
                                    </div>
                                </div>
                                <p class="text-muted small">
                                    <i class="bi bi-shield-check me-1"></i>安全支付由 PyPay 提供
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Hide payment modal
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
            
            // Remove existing modal if any
            const existing = document.getElementById('paymentRedirectModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentRedirectModal')).show();

            // Redirect to payment URL after showing the modal
            // Validate that the URL is well-formed before redirecting
            if (paymentUrl) {
                try {
                    const urlObj = new URL(paymentUrl);
                    // Allow HTTP or HTTPS URLs (PyPay may return HTTP URLs)
                    // Note: HTTP is less secure but may be required by some payment gateways
                    if (urlObj.protocol === 'https:' || urlObj.protocol === 'http:') {
                        if (urlObj.protocol === 'http:') {
                            console.warn('Payment URL uses HTTP instead of HTTPS - this is less secure');
                        }
                        setTimeout(() => {
                            window.location.href = paymentUrl;
                        }, 2000);
                    } else {
                        console.error('Invalid payment URL protocol:', urlObj.protocol);
                        showPaymentErrorModal('支付链接无效，请联系管理员');
                    }
                } catch (e) {
                    console.error('Invalid payment URL:', e);
                    showPaymentErrorModal('支付链接格式错误');
                }
            }
        }

        function showPaymentDemoMessage(productName, amount) {
            const modalHtml = `
                <div class="modal fade" id="paymentDemoModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>演示模式</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-lightbulb me-2"></i>
                                    <strong>这是演示模式</strong>
                                </div>
                                <p>在生产环境中，系统会跳转到 PyPay 支付页面完成支付。</p>
                                <div class="bg-light rounded p-3 mb-3">
                                    <h6 class="mb-2">订单详情</h6>
                                    <div class="d-flex justify-content-between">
                                        <span>商品</span><strong>${productName}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>金额</span><strong class="text-primary">¥${amount.toFixed(2)}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>支付方式</span><strong>${paymentMethod === 'alipay' ? '支付宝' : '微信支付'}</strong>
                                    </div>
                                </div>
                                <p class="mb-0 text-muted small">
                                    <i class="bi bi-gear me-1"></i>
                                    请在后台 <strong>VIP配置</strong> 页面配置 PyPay 支付参数以启用真实支付功能。
                                </p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                <a href="/admin/vip" class="btn btn-primary" target="_blank">
                                    <i class="bi bi-gear me-2"></i>前往配置
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existing = document.getElementById('paymentDemoModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentDemoModal')).show();
        }

        function showPaymentErrorModal(message) {
            const modalHtml = `
                <div class="modal fade" id="paymentErrorModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title"><i class="bi bi-exclamation-circle me-2"></i>支付失败</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-x-circle display-1 text-danger mb-3"></i>
                                <h5>支付请求失败</h5>
                                <p class="text-muted">${message}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existing = document.getElementById('paymentErrorModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentErrorModal')).show();
        }

        // Purchase VIP with balance
        async function purchaseVIPWithBalance(level) {
            const vip = vipLevels.find(v => v.level === level);
            if (!vip) return;

            // Check if this is an upgrade and calculate actual price
            const isUpgrade = currentUserVIPLevel > 0 && level > currentUserVIPLevel;
            let actualPrice = vip.price;
            
            // Use string key for upgrade_prices lookup (JSON uses string keys)
            const currentLevelKey = String(currentUserVIPLevel);
            if (isUpgrade && vip.upgrade_prices && vip.upgrade_prices[currentLevelKey]) {
                actualPrice = vip.upgrade_prices[currentLevelKey];
            }

            const actionText = isUpgrade ? '升级' : '购买';
            const priceText = isUpgrade && actualPrice !== vip.price 
                ? `升级价：¥${actualPrice.toFixed(2)}（原价：¥${vip.price.toFixed(2)}）`
                : `价格：¥${actualPrice.toFixed(2)}`;

            if (!confirm(`确定使用余额${actionText} ${vip.name}？\n\n${priceText}`)) {
                return;
            }

            try {
                const response = await fetch('/api/auth/purchase-vip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level: level })
                });

                const result = await response.json();
                if (result.success) {
                    // Update balance display
                    const balanceEl = document.getElementById('user-balance');
                    if (balanceEl && result.data) {
                        balanceEl.textContent = result.data.balance.toFixed(2);
                    }
                    
                    // Update current user VIP level
                    if (result.data && result.data.vip_level) {
                        currentUserVIPLevel = result.data.vip_level;
                    }
                    
                    showPurchaseSuccessModal(vip.name, result.data?.balance || 0, result.data?.is_upgrade || false);
                    renderVIPCards(); // Re-render to update button states
                } else {
                    alert(result.message || '购买失败');
                }
            } catch (error) {
                console.error('Purchase error:', error);
                alert('购买失败，请稍后重试');
            }
        }

        function showPurchaseSuccessModal(vipName, newBalance, isUpgrade = false) {
            const title = isUpgrade ? '升级成功' : '购买成功';
            const action = isUpgrade ? '升级到' : '开通';
            const modalHtml = `
                <div class="modal fade" id="purchaseSuccessModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title"><i class="bi bi-check-circle me-2"></i>${title}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-gem display-1 text-success mb-3"></i>
                                <h4>恭喜您！</h4>
                                <p class="mb-3">您已成功${action} <strong>${vipName}</strong></p>
                                <p class="text-muted">当前余额：¥${newBalance.toFixed(2)}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="location.reload()">
                                    <i class="bi bi-check-lg me-2"></i>确定
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('purchaseSuccessModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('purchaseSuccessModal')).show();
        }

        // Redeem gift card
        async function redeemGiftCard(confirmVipConflict = false) {
            const codeInput = document.getElementById('gift-card-code');
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                alert('请输入礼品卡码');
                return;
            }

            if (code.replace(/-/g, '').length !== 16) {
                alert('请输入有效的16位礼品卡码');
                return;
            }

            try {
                const response = await fetch('/api/auth/redeem-gift-card', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, confirm: confirmVipConflict })
                });

                const result = await response.json();
                
                // Handle VIP conflict - show warning modal
                if (response.status === 409 && result.requires_confirm) {
                    showVipConflictWarningModal(code, result.data);
                    return;
                }
                
                if (result.success) {
                    // Update balance display
                    const balanceEl = document.getElementById('user-balance');
                    if (balanceEl && result.data) {
                        balanceEl.textContent = result.data.balance.toFixed(2);
                    }
                    
                    codeInput.value = '';
                    showRedeemSuccessModal(result.data);
                    renderVIPCards(); // Re-render to update button states
                } else {
                    alert(result.message || '兑换失败');
                }
            } catch (error) {
                console.error('Redeem error:', error);
                alert('兑换失败，请稍后重试');
            }
        }

        function showVipConflictWarningModal(code, data) {
            // Format VIP expiration date
            let currentVipExpireText = i18nStrings.vipWarningPermanent;
            if (data.current_vip_expire_at) {
                const expireDate = new Date(data.current_vip_expire_at);
                const localeMap = {'zh': 'zh-CN', 'en': 'en-US'};
                const currentLang = '{{.lang}}';
                const locale = localeMap[currentLang] || 'en-US';
                currentVipExpireText = expireDate.toLocaleDateString(locale, {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            
            // Format card VIP duration
            let cardVipDurationText = i18nStrings.vipWarningPermanent;
            if (data.card_vip_days > 0) {
                cardVipDurationText = `${data.card_vip_days} ${i18nStrings.vipWarningDays}`;
            }
            
            const modalHtml = `
                <div class="modal fade" id="vipConflictModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>${i18nStrings.vipWarningTitle}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body py-4">
                                <div class="alert alert-warning mb-3">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    ${i18nStrings.vipWarningMessage}
                                </div>
                                <div class="bg-light rounded p-3 mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">${i18nStrings.vipWarningCurrent}</span>
                                        <strong>VIP ${data.current_vip_level}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">${i18nStrings.vipWarningExpires}</span>
                                        <strong>${currentVipExpireText}</strong>
                                    </div>
                                    <hr class="my-2">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">${i18nStrings.vipWarningCardVip}</span>
                                        <strong class="text-muted text-decoration-line-through">VIP ${data.card_vip_level} (${cardVipDurationText})</strong>
                                    </div>
                                    ${data.card_amount > 0 ? `
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">${i18nStrings.balance}</span>
                                        <strong class="text-success">¥${data.card_amount.toFixed(2)}</strong>
                                    </div>
                                    ` : ''}
                                </div>
                                ${data.card_amount > 0 ? `
                                <p class="text-info small mb-0">
                                    <i class="bi bi-info-circle me-1"></i>${i18nStrings.vipWarningBalanceNote}
                                </p>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${i18nStrings.vipWarningCancel}</button>
                                <button type="button" class="btn btn-warning" onclick="confirmRedeemWithVipConflict('${code}')">
                                    <i class="bi bi-check-lg me-1"></i>${i18nStrings.vipWarningConfirm}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('vipConflictModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('vipConflictModal')).show();
        }

        async function confirmRedeemWithVipConflict(code) {
            // Close the warning modal
            const warningModal = bootstrap.Modal.getInstance(document.getElementById('vipConflictModal'));
            if (warningModal) warningModal.hide();
            
            // Re-enter the code and trigger redeem with confirmation
            const codeInput = document.getElementById('gift-card-code');
            codeInput.value = code;
            
            // Call redeem with confirmation flag
            await redeemGiftCard(true);
        }

        function showRedeemSuccessModal(data) {
            const amount = data?.amount || 0;
            const newBalance = data?.balance || 0;
            const grantedVipLevel = data?.granted_vip_level || 0;
            const grantedVipDays = data?.granted_vip_days || 0;
            const vipSkipped = data?.vip_skipped || false;
            
            let rewardContent = '';
            if (amount > 0) {
                rewardContent += `<p class="mb-2">${i18nStrings.balanceAdded}<strong class="text-success fs-4">¥${amount.toFixed(2)}</strong></p>`;
            }
            if (grantedVipLevel > 0 && !vipSkipped) {
                rewardContent += `<p class="mb-2">${i18nStrings.vipGranted}<strong class="text-warning fs-4"><i class="bi bi-gem me-1"></i>VIP${grantedVipLevel}</strong>`;
                if (grantedVipDays > 0) {
                    rewardContent += ` <span class="text-muted">(${grantedVipDays}${i18nStrings.vipWarningDays})</span>`;
                } else {
                    rewardContent += ` <span class="text-muted">(${i18nStrings.vipWarningPermanent})</span>`;
                }
                rewardContent += `</p>`;
            }
            if (vipSkipped) {
                rewardContent += `<p class="text-warning small mb-2"><i class="bi bi-info-circle me-1"></i>${i18nStrings.vipSkipped}</p>`;
            }
            
            const modalHtml = `
                <div class="modal fade" id="redeemSuccessModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title"><i class="bi bi-gift me-2"></i>${i18nStrings.redeemSuccess}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-gift display-1 text-success mb-3"></i>
                                <h4>${i18nStrings.redeemSuccessTitle}</h4>
                                ${rewardContent}
                                <p class="text-muted">${i18nStrings.currentBalance}¥${newBalance.toFixed(2)}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" data-bs-dismiss="modal" id="redeemSuccessOkBtn">
                                    <i class="bi bi-check-lg me-2"></i>${i18nStrings.confirmBtn}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('redeemSuccessModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('redeemSuccessModal'));
            modal.show();
            
            // Handle reload after modal is hidden
            document.getElementById('redeemSuccessOkBtn').addEventListener('click', function() {
                setTimeout(() => location.reload(), 300);
            });
        }

        // Format gift card code input
        document.addEventListener('DOMContentLoaded', function() {
            const codeInput = document.getElementById('gift-card-code');
            if (codeInput) {
                codeInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
                    if (value.length > 16) value = value.substring(0, 16);
                    
                    // Add dashes every 4 characters
                    let formatted = '';
                    for (let i = 0; i < value.length; i++) {
                        if (i > 0 && i % 4 === 0) formatted += '-';
                        formatted += value[i];
                    }
                    e.target.value = formatted;
                });
            }
        });

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/auth/login';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Language switcher function
        async function setLanguage(lang) {
            try {
                const response = await fetch('/api/i18n/set-language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lang: lang })
                });
                const data = await response.json();
                if (data.success) {
                    window.location.reload();
                }
            } catch (error) {
                console.error('Failed to set language:', error);
            }
        }
    </script>
    {{if .custom.GlobalHTML}}{{.custom.GlobalHTML}}{{end}}
</body>
</html>
