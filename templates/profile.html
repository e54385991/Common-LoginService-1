<!DOCTYPE html>
<html lang="{{.lang}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{if .siteTitle}}{{.siteTitle}}{{else}}{{t .lang "app.name"}}{{end}} - {{t .lang "profile.page_title"}}</title>
    {{template "darkmode" .}}
    {{template "head_assets" .}}
    <style>
        .quick-actions-bar .quick-action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            color: white;
            cursor: pointer;
            min-width: 140px;
        }
        .quick-actions-bar .quick-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            color: white;
        }
        .quick-actions-bar .quick-action-btn i {
            margin-right: 8px;
            font-size: 1.1rem;
        }
        @media (max-width: 768px) {
            .quick-actions-bar .quick-action-btn {
                min-width: 120px;
                padding: 10px 16px;
                font-size: 0.9rem;
            }
        }
        .info-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 24px;
            margin-bottom: 24px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .info-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }
        .info-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .info-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 15px;
        }
        .info-card-icon.balance {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        .info-card-icon.vip {
            background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
            color: #333;
        }
        .info-card-icon.account {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .info-card-icon.security {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        .info-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }
        .info-card-subtitle {
            font-size: 0.85rem;
            color: #888;
        }
        .info-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .info-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        .info-list li:last-child {
            border-bottom: none;
        }
        .info-label {
            color: #666;
            font-size: 0.95rem;
        }
        .info-value {
            font-weight: 500;
            color: #333;
        }
        .action-btn {
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .action-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .action-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }
        .action-btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            color: white;
        }
        .action-btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
            color: white;
        }
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .quick-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            color: white;
            cursor: pointer;
        }
        .quick-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            color: white;
        }
        .quick-action-btn i {
            margin-right: 8px;
            font-size: 1.2rem;
        }
        /* Button Effects */
        .effect-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        .effect-glow {
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(40, 167, 69, 0.5); }
            to { box-shadow: 0 0 20px rgba(40, 167, 69, 0.8), 0 0 30px rgba(40, 167, 69, 0.6); }
        }
        .effect-bounce {
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }
        .vip-status-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }
        .vip-status-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .vip-status-title {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .vip-status-level {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        .vip-status-expire {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        .vip-upgrade-btn {
            margin-top: 15px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }
        .vip-upgrade-btn:hover {
            background: rgba(255,255,255,0.3);
            color: white;
        }
        /* Recharge Modal Styles */
        .recharge-amount-card {
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        .recharge-amount-card:hover {
            border-color: #28a745;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .recharge-amount-card.selected {
            border-color: #28a745;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        .recharge-amount-card .amount {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .recharge-amount-card .bonus {
            font-size: 0.85rem;
            color: #28a745;
            margin-top: 4px;
        }
        .recharge-amount-card.selected .bonus {
            color: rgba(255,255,255,0.9);
        }
        .payment-method-option {
            cursor: pointer;
            transition: all 0.3s;
        }
        .payment-method-option:hover {
            border-color: #667eea !important;
        }
        .payment-method-option.selected {
            border-color: #667eea !important;
            background: linear-gradient(135deg, #f0f0ff 0%, #e8e8ff 100%);
        }
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: repeat(1, 1fr);
            }
            .quick-actions {
                grid-template-columns: 1fr;
            }
        }
        /* Mobile Bottom Toolbar */
        .mobile-toolbar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg, #ffffff);
            border-top: 1px solid var(--border-color, #e0e0e0);
            padding: 8px 0;
            z-index: 1030;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        @media (max-width: 768px) {
            .mobile-toolbar.enabled {
                display: block;
            }
            body.has-mobile-toolbar {
                padding-bottom: 70px;
            }
        }
        .mobile-toolbar-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .mobile-toolbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-muted, #666);
            font-size: 0.75rem;
            padding: 4px 12px;
            transition: color 0.2s;
        }
        .mobile-toolbar-item i {
            font-size: 1.3rem;
            margin-bottom: 2px;
        }
        .mobile-toolbar-item:hover,
        .mobile-toolbar-item.active {
            color: var(--primary-color, #667eea);
        }
        [data-theme="dark"] .mobile-toolbar {
            background: var(--card-bg, #1e1e2f);
            border-color: var(--border-color, rgba(255,255,255,0.1));
        }
        [data-theme="dark"] .mobile-toolbar-item {
            color: var(--text-muted, #a0a0a0);
        }
        [data-theme="dark"] .mobile-toolbar-item:hover,
        [data-theme="dark"] .mobile-toolbar-item.active {
            color: var(--primary-color, #667eea);
        }
        /* Message Box Styles */
        .message-item {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .message-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.03) 100%);
            transform: translateX(4px);
        }
        .message-item.unread {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
            border-left: 4px solid #667eea;
        }
        .message-item.unread::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            animation: pulse-border 2s infinite;
        }
        @keyframes pulse-border {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .message-item .message-title {
            font-weight: 600;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .message-item.unread .message-title {
            color: #333;
        }
        .message-item .message-preview {
            color: #666;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 4px;
        }
        .message-item .message-time {
            color: #999;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        /* Message checkbox for batch select */
        .message-item .message-checkbox {
            display: none;
            margin-right: 12px;
        }
        .message-item.batch-select-mode .message-checkbox {
            display: block;
        }
        .message-item.selected {
            background: rgba(102, 126, 234, 0.15) !important;
        }
        .message-type-badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        .message-new-badge {
            font-size: 0.6rem;
            padding: 2px 6px;
            animation: pulse-new 1.5s infinite;
        }
        @keyframes pulse-new {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        [data-theme="dark"] .message-item:hover {
            background: rgba(102, 126, 234, 0.08);
        }
        [data-theme="dark"] .message-item.unread {
            background: rgba(102, 126, 234, 0.15);
        }
        [data-theme="dark"] .message-item .message-preview {
            color: #aaa;
        }
        [data-theme="dark"] .message-item .message-title {
            color: #e0e0e0;
        }
        /* Notification Badge Animation */
        #unread-badge {
            transform: translate(-25%, -25%) !important;
            min-width: 18px;
            height: 18px;
            align-items: center;
            justify-content: center;
        }
        /* Badge pulse animation - applied via JavaScript when badge is visible */
        #unread-badge.badge-visible {
            animation: badge-pulse 2s infinite;
        }
        /* Badge bounce animation for new notifications */
        #unread-badge.badge-bounce {
            animation: badge-pulse 2s infinite, badge-bounce 0.5s ease;
        }
        @keyframes badge-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(220, 53, 69, 0); }
        }
        @keyframes badge-bounce {
            0% { transform: translate(-25%, -25%) scale(0); }
            50% { transform: translate(-25%, -25%) scale(1.2); }
            100% { transform: translate(-25%, -25%) scale(1); }
        }
        /* Message Pagination */
        .messages-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }
        .messages-pagination .btn {
            min-width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        .messages-pagination .page-info {
            font-size: 0.85rem;
            color: #666;
            margin: 0 12px;
        }
        [data-theme="dark"] .messages-pagination {
            background: rgba(255,255,255,0.03);
            border-color: rgba(255,255,255,0.1);
        }
        [data-theme="dark"] .messages-pagination .page-info {
            color: #aaa;
        }
        /* Message Detail Modal Styling */
        .message-detail-content {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 12px;
            line-height: 1.7;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        [data-theme="dark"] .message-detail-content {
            background: rgba(255,255,255,0.05);
            color: #e0e0e0;
        }
        /* Bell icon shake animation for new messages */
        .bell-shake {
            animation: bell-shake 0.5s ease-in-out;
        }
        @keyframes bell-shake {
            0%, 100% { transform: rotate(0); }
            20% { transform: rotate(15deg); }
            40% { transform: rotate(-15deg); }
            60% { transform: rotate(10deg); }
            80% { transform: rotate(-10deg); }
        }
    </style>
    {{if .custom.GlobalCSS}}<style>{{.custom.GlobalCSS}}</style>{{end}}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-shield-lock-fill me-2"></i>{{if .siteTitle}}{{.siteTitle}}{{else}}{{t .lang "app.name"}}{{end}}
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto" id="top-nav-items">
                    {{/* Server-side render top navigation items */}}
                    {{template "top_nav_items" .}}
                    {{if .logged}}
                    <!-- Message Box -->
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="#" data-bs-toggle="modal" data-bs-target="#messagesModal" onclick="loadMessages()">
                            <i class="bi bi-bell"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="unread-badge" style="display: none; font-size: 0.65rem;">
                                0
                            </span>
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            {{if .user.Avatar}}
                            <img src="{{.user.Avatar}}" alt="Avatar" class="rounded-circle me-1" width="24" height="24">
                            {{else}}
                            <i class="bi bi-person-circle me-1"></i>
                            {{end}}
                            {{.user.DisplayName}}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>{{t .lang "nav.profile_center"}}</a></li>
                            <li><a class="dropdown-item" href="/recharge"><i class="bi bi-wallet2 me-2"></i>{{t .lang "nav.recharge_center"}}</a></li>
                            <li><a class="dropdown-item" href="/vip"><i class="bi bi-gem me-2"></i>{{t .lang "nav.vip_member"}}</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>{{t .lang "nav.logout"}}</a></li>
                        </ul>
                    </li>
                    {{else}}
                    <li class="nav-item">
                        <a class="nav-link" href="/auth/login"><i class="bi bi-box-arrow-in-right me-1"></i>{{t .lang "nav.login"}}</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/auth/register"><i class="bi bi-person-plus me-1"></i>{{t .lang "nav.register"}}</a>
                    </li>
                    {{end}}
                    <!-- Dark Mode Toggle -->
                    <li class="nav-item">
                        <a class="nav-link dark-mode-toggle" href="javascript:void(0)" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                            <i class="bi bi-moon-fill"></i>
                        </a>
                    </li>
                    <!-- Language Switcher -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="langDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-globe me-1"></i>{{if eq .lang "zh"}}中文{{else}}English{{end}}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item {{if eq .lang "en"}}active{{end}}" href="#" onclick="setLanguage('en')"><i class="bi bi-check2 me-2 {{if ne .lang "en"}}invisible{{end}}"></i>English</a></li>
                            <li><a class="dropdown-item {{if eq .lang "zh"}}active{{end}}" href="#" onclick="setLanguage('zh')"><i class="bi bi-check2 me-2 {{if ne .lang "zh"}}invisible{{end}}"></i>中文</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    {{if .logged}}
    <!-- Quick Actions Bar (Replacing Profile Hero) -->
    <section class="quick-actions-bar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px 0;">
        <div class="container">
            <div class="d-flex flex-wrap justify-content-center gap-3" id="quick-actions-bar-container">
                {{/* Server-side render profile quick actions */}}
                {{template "profile_quick_actions" .}}
            </div>
        </div>
    </section>

    <!-- Profile Content -->
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="row">
                    <!-- Left Column -->
                    <div class="col-lg-8">
                        <!-- VIP Status Card -->
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon vip">
                                    <i class="bi bi-gem"></i>
                                </div>
                                <div>
                                    <div class="info-card-title">{{t .lang "profile.vip_member"}}</div>
                                    <div class="info-card-subtitle">{{t .lang "profile.vip_member_subtitle"}}</div>
                                </div>
                            </div>
                            <div id="vip-info-content">
                                {{if gt .user.VIPLevel 0}}
                                <div class="vip-status-card mb-3">
                                    <div class="vip-status-title">{{t .lang "profile.current_level"}}</div>
                                    <div class="vip-status-level" id="vip-level-name">VIP {{.user.VIPLevel}}</div>
                                    <div class="vip-status-expire" id="vip-expire-info">{{t .lang "profile.vip_expire_calculating"}}</div>
                                    <a href="/vip" class="vip-upgrade-btn">
                                        <i class="bi bi-arrow-up-circle me-1"></i>{{t .lang "profile.vip_renew_upgrade"}}
                                    </a>
                                </div>
                                {{else}}
                                <div class="text-center py-4">
                                    <i class="bi bi-gem display-4 text-muted mb-3"></i>
                                    <p class="text-muted mb-3">{{t .lang "profile.not_vip"}}</p>
                                    <a href="/vip" class="btn action-btn action-btn-primary">
                                        <i class="bi bi-gem me-2"></i>{{t .lang "profile.activate_vip"}}
                                    </a>
                                </div>
                                {{end}}
                            </div>
                        </div>

                        <!-- Balance Card -->
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon balance">
                                    <i class="bi bi-wallet2"></i>
                                </div>
                                <div>
                                    <div class="info-card-title">{{t .lang "profile.account_balance"}}</div>
                                    <div class="info-card-subtitle">{{t .lang "profile.account_balance_subtitle"}}</div>
                                </div>
                            </div>
                            <ul class="info-list">
                                <li>
                                    <span class="info-label">{{t .lang "profile.available_balance"}}</span>
                                    <span class="info-value text-success fs-4">¥<span id="available-balance">{{printf "%.2f" .user.Balance}}</span></span>
                                </li>
                            </ul>
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn action-btn action-btn-success flex-grow-1" data-bs-toggle="modal" data-bs-target="#rechargeModal">
                                    <i class="bi bi-plus-circle me-2"></i>{{t .lang "profile.recharge"}}
                                </button>
                                <button class="btn action-btn action-btn-primary flex-grow-1" data-bs-toggle="modal" data-bs-target="#giftCardModal">
                                    <i class="bi bi-gift me-2"></i>{{t .lang "profile.redeem_gift_card"}}
                                </button>
                            </div>
                        </div>

                        <!-- Account Info Card -->
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon account">
                                    <i class="bi bi-person-badge"></i>
                                </div>
                                <div>
                                    <div class="info-card-title">{{t .lang "profile.account_info"}}</div>
                                    <div class="info-card-subtitle">{{t .lang "profile.account_info_subtitle"}}</div>
                                </div>
                            </div>
                            <ul class="info-list">
                                <li>
                                    <span class="info-label">{{t .lang "profile.username"}}</span>
                                    <span class="info-value">{{.user.Username}}</span>
                                </li>
                                <li>
                                    <span class="info-label">{{t .lang "profile.email"}}</span>
                                    <span class="info-value">{{.user.Email}}</span>
                                </li>
                                <li>
                                    <span class="info-label">{{t .lang "profile.display_name"}}</span>
                                    <span class="info-value">{{.user.DisplayName}}</span>
                                </li>
                                <li>
                                    <span class="info-label">{{t .lang "profile.registration_time"}}</span>
                                    <span class="info-value" id="created-at">{{.user.CreatedAt}}</span>
                                </li>
                                <li>
                                    <span class="info-label">{{t .lang "profile.account_status"}}</span>
                                    <span class="info-value">
                                        {{if .user.IsActive}}
                                        <span class="badge bg-success">{{t .lang "profile.status_active"}}</span>
                                        {{else}}
                                        <span class="badge bg-danger">{{t .lang "profile.status_disabled"}}</span>
                                        {{end}}
                                    </span>
                                </li>
                            </ul>
                            <button class="btn action-btn action-btn-primary w-100 mt-3" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                <i class="bi bi-pencil me-2"></i>{{t .lang "profile.edit_profile"}}
                            </button>
                            <button class="btn btn-outline-danger w-100 mt-2" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                <i class="bi bi-key me-2"></i>{{t .lang "profile.change_password"}}
                            </button>
                        </div>

                        <!-- Third-party Account Binding Card -->
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white;">
                                    <i class="bi bi-link-45deg"></i>
                                </div>
                                <div>
                                    <div class="info-card-title">{{t .lang "binding.title"}}</div>
                                    <div class="info-card-subtitle">{{t .lang "binding.subtitle"}}</div>
                                </div>
                            </div>
                            <ul class="info-list" id="binding-list">
                                <!-- Google Account -->
                                <li id="binding-google-row" style="display: none;">
                                    <span class="info-label">
                                        <i class="bi bi-google me-2" style="color: #4285F4;"></i>{{t .lang "binding.google"}}
                                    </span>
                                    <span class="info-value" id="binding-google-status">
                                        <span class="badge bg-secondary">{{t .lang "binding.not_bound"}}</span>
                                    </span>
                                </li>
                                <!-- Steam Account -->
                                <li id="binding-steam-row" style="display: none;">
                                    <span class="info-label">
                                        <i class="bi bi-steam me-2" style="color: #171a21;"></i>{{t .lang "binding.steam"}}
                                    </span>
                                    <span class="info-value" id="binding-steam-status">
                                        <span class="badge bg-secondary">{{t .lang "binding.not_bound"}}</span>
                                    </span>
                                </li>
                                <!-- Discord Account -->
                                <li id="binding-discord-row" style="display: none;">
                                    <span class="info-label">
                                        <i class="bi bi-discord me-2" style="color: #5865F2;"></i>{{t .lang "binding.discord"}}
                                    </span>
                                    <span class="info-value" id="binding-discord-status">
                                        <span class="badge bg-secondary">{{t .lang "binding.not_bound"}}</span>
                                    </span>
                                </li>
                            </ul>
                            <div id="binding-empty-state" class="text-center text-muted py-3">
                                <i class="bi bi-link-45deg"></i> {{t .lang "binding.empty_state"}}
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="col-lg-4">
                        <!-- VIP Benefits Preview -->
                        <div class="info-card">
                            <div class="info-card-header">
                                <div class="info-card-icon vip">
                                    <i class="bi bi-star"></i>
                                </div>
                                <div>
                                    <div class="info-card-title">{{t .lang "profile.vip_benefits"}}</div>
                                    <div class="info-card-subtitle">{{t .lang "profile.vip_benefits_subtitle"}}</div>
                                </div>
                            </div>
                            <ul class="info-list" id="vip-benefits-list">
                                <li>
                                    <span class="info-label"><i class="bi bi-check-circle text-success me-2"></i>{{t .lang "profile.benefit_support"}}</span>
                                </li>
                                <li>
                                    <span class="info-label"><i class="bi bi-check-circle text-success me-2"></i>{{t .lang "profile.benefit_exclusive"}}</span>
                                </li>
                                <li>
                                    <span class="info-label"><i class="bi bi-check-circle text-success me-2"></i>{{t .lang "profile.benefit_more"}}</span>
                                </li>
                            </ul>
                            <a href="/vip" class="btn btn-outline-primary w-100 mt-3">
                                <i class="bi bi-arrow-right me-2"></i>{{t .lang "profile.view_all_benefits"}}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>{{t .lang "profile.edit_profile_title"}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-profile-form">
                        <div class="mb-3">
                            <label for="display-name" class="form-label">{{t .lang "profile.display_name_label"}}</label>
                            <input type="text" class="form-control" id="display-name" value="{{.user.DisplayName}}">
                        </div>
                        <div class="mb-3">
                            <label for="avatar-url" class="form-label">{{t .lang "profile.avatar_url"}}</label>
                            <input type="url" class="form-control" id="avatar-url" value="{{.user.Avatar}}" placeholder="https://example.com/avatar.jpg">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{t .lang "profile.cancel"}}</button>
                    <button type="button" class="btn btn-primary" onclick="saveProfile()">
                        <i class="bi bi-check-lg me-1"></i>{{t .lang "profile.save"}}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gift Card Modal -->
    <div class="modal fade" id="giftCardModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gift me-2"></i>{{t .lang "profile.gift_card_title"}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">{{t .lang "profile.gift_card_hint"}}</p>
                    <div class="input-group input-group-lg">
                        <span class="input-group-text"><i class="bi bi-gift"></i></span>
                        <input type="text" class="form-control font-monospace" id="gift-card-code" placeholder="{{t .lang "profile.gift_card_placeholder"}}" maxlength="19">
                    </div>
                    <small class="text-muted mt-2 d-block">{{t .lang "profile.gift_card_format_hint"}}</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{t .lang "profile.cancel"}}</button>
                    <button type="button" class="btn btn-success" onclick="redeemGiftCard()">
                        <i class="bi bi-check-lg me-1"></i>{{t .lang "profile.redeem"}}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Recharge Modal -->
    <div class="modal fade" id="rechargeModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-wallet2 me-2"></i>{{t .lang "profile.recharge"}}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-3" id="recharge-amounts-container">
                        <!-- Recharge amounts will be rendered by JavaScript -->
                    </div>
                    <div class="mt-4">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control" id="custom-recharge-amount" placeholder="{{t .lang "recharge.custom_amount"}}" min="1" step="0.01">
                            <button class="btn btn-outline-primary" type="button" onclick="selectCustomRechargeAmount()">
                                <i class="bi bi-check-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{t .lang "profile.cancel"}}</button>
                    <button type="button" class="btn btn-success" id="confirm-recharge-btn" onclick="openPaymentFromProfile()" disabled>
                        <i class="bi bi-credit-card me-2"></i>{{t .lang "recharge.recharge_btn"}}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>{{t .lang "payment.title"}}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="bg-light rounded p-3 mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">{{t .lang "payment.product_name"}}</span>
                            <span id="payment-product-name">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">{{t .lang "payment.amount"}}</span>
                            <span class="fw-bold text-primary fs-4" id="payment-amount">¥0.00</span>
                        </div>
                    </div>
                    <p class="text-muted small mb-3">{{t .lang "payment.select_method"}}</p>
                    <div class="d-flex gap-3 mb-4">
                        <div class="payment-method-option flex-fill border rounded p-3 text-center cursor-pointer selected" data-method="alipay" onclick="selectPaymentMethod('alipay')">
                            <i class="bi bi-alipay fs-2 text-primary d-block mb-2"></i>
                            <small>{{t .lang "payment.alipay"}}</small>
                        </div>
                        <div class="payment-method-option flex-fill border rounded p-3 text-center cursor-pointer" data-method="wechat" onclick="selectPaymentMethod('wechat')">
                            <i class="bi bi-wechat fs-2 text-success d-block mb-2"></i>
                            <small>{{t .lang "payment.wechat"}}</small>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 py-3 fw-bold" onclick="submitPaymentFromProfile()">
                        <i class="bi bi-shield-check me-2"></i>{{t .lang "payment.confirm_btn"}}
                    </button>
                    <p class="text-center text-muted small mt-3 mb-0">
                        <i class="bi bi-lock me-1"></i>{{t .lang "payment.secure_note"}}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-key me-2"></i>{{t .lang "profile.change_password_title"}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="change-password-form">
                        <div class="mb-3">
                            <label for="old-password" class="form-label">{{t .lang "profile.old_password"}}</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                <input type="password" class="form-control" id="old-password" placeholder="{{t .lang "profile.old_password_placeholder"}}" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="new-password" class="form-label">{{t .lang "profile.new_password"}}</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                                <input type="password" class="form-control" id="new-password" placeholder="{{t .lang "profile.new_password_placeholder"}}" required minlength="6">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="confirm-password" class="form-label">{{t .lang "profile.confirm_password"}}</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                                <input type="password" class="form-control" id="confirm-password" placeholder="{{t .lang "profile.confirm_password_placeholder"}}" required minlength="6">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{t .lang "profile.cancel"}}</button>
                    <button type="button" class="btn btn-danger" onclick="changePassword()">
                        <i class="bi bi-check-lg me-1"></i>{{t .lang "profile.confirm_change"}}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div class="modal fade" id="messagesModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" style="border-radius: 16px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                    <h5 class="modal-title"><i class="bi bi-bell-fill me-2"></i>{{t .lang "messages.title"}}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- Messages Header -->
                    <div class="d-flex justify-content-between align-items-center p-3 border-bottom" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);">
                        <div class="d-flex align-items-center">
                            <div class="form-check me-2" id="select-all-container" style="display: none;">
                                <input class="form-check-input" type="checkbox" id="select-all-messages" onchange="toggleSelectAllMessages()">
                            </div>
                            <i class="bi bi-envelope-open me-2 text-primary"></i>
                            <span class="fw-semibold">
                                <span id="messages-count">0</span> {{t .lang "messages.inbox"}}
                            </span>
                            <span class="badge bg-primary ms-2" id="unread-count-header" style="display: none;">
                                <span id="unread-count-number">0</span> {{t .lang "messages.unread"}}
                            </span>
                            <span class="badge bg-secondary ms-2" id="selected-count-badge" style="display: none;">
                                <span id="selected-count-number">0</span> {{t .lang "messages.selected"}}
                            </span>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-danger" onclick="batchDeleteMessages()" id="batch-delete-btn" style="display: none;">
                                <i class="bi bi-trash me-1"></i>{{t .lang "messages.batch_delete"}}
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleBatchSelectMode()" id="batch-select-btn">
                                <i class="bi bi-check2-square me-1"></i>{{t .lang "messages.batch_select"}}
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="markAllMessagesAsRead()" id="mark-all-read-btn">
                                <i class="bi bi-check-all me-1"></i>{{t .lang "messages.mark_all_read"}}
                            </button>
                        </div>
                    </div>
                    <!-- Messages List -->
                    <div id="messages-list" style="max-height: 450px; overflow-y: auto;">
                        <div class="text-center py-5 text-muted" id="messages-empty">
                            <i class="bi bi-inbox display-4 d-block mb-3" style="opacity: 0.3;"></i>
                            <h6>{{t .lang "messages.empty_title"}}</h6>
                            <p class="small mb-0">{{t .lang "messages.empty_desc"}}</p>
                        </div>
                    </div>
                    <!-- Messages Pagination -->
                    <div class="messages-pagination" id="messages-pagination" style="display: none;">
                        <button class="btn btn-outline-secondary" id="msg-prev-btn" onclick="loadMessagesPage(currentMessagesPage - 1)" disabled>
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <span class="page-info">
                            <span id="msg-current-page">1</span> / <span id="msg-total-pages">1</span>
                        </span>
                        <button class="btn btn-outline-secondary" id="msg-next-btn" onclick="loadMessagesPage(currentMessagesPage + 1)" disabled>
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Detail Modal -->
    <div class="modal fade" id="messageDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 16px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);">
                    <h5 class="modal-title" id="message-detail-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="message-detail-meta" class="text-muted small mb-3"></div>
                    <div id="message-detail-content" class="message-detail-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="backToMessagesList()">
                        <i class="bi bi-arrow-left me-1"></i>{{t .lang "messages.inbox"}}
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="deleteCurrentMessage()">
                        <i class="bi bi-trash me-1"></i>{{t .lang "messages.delete"}}
                    </button>
                </div>
            </div>
        </div>
    </div>

    {{else}}
    <!-- Not Logged In -->
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-6 text-center">
                <i class="bi bi-person-lock display-1 text-muted mb-4"></i>
                <h2>{{t .lang "profile.login_required"}}</h2>
                <p class="text-muted mb-4">{{t .lang "profile.login_required_desc"}}</p>
                <a href="/auth/login" class="btn btn-primary btn-lg">
                    <i class="bi bi-box-arrow-in-right me-2"></i>{{t .lang "profile.login_now"}}
                </a>
            </div>
        </div>
    </div>
    {{end}}

    <!-- Mobile Bottom Toolbar -->
    <nav class="mobile-toolbar" id="mobile-toolbar">
        <div class="mobile-toolbar-items" id="mobile-toolbar-items">
            <!-- Items will be loaded dynamically -->
        </div>
    </nav>

    {{template "footer" .}}

    {{template "common_scripts" .}}
    <script>
        const currentLang = "{{.lang}}";
        let vipLevels = [];
        let bindingStatus = {};
        let selectedRechargeAmount = 0;
        let paymentMethod = 'alipay';
        let currentMessageId = null;
        let messagesData = [];
        // Pagination state for messages
        let currentMessagesPage = 1;
        let totalMessagesPages = 1;
        let messagesPerPage = 10;
        let totalMessagesCount = 0;
        // Track previous unread count for new message notifications
        // Initialize to -1 to distinguish first load from subsequent updates
        let previousUnreadCount = -1;

        // Utility function to escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadVIPLevels();
            loadUserBalance();
            loadThirdPartyBindingStatus();
            loadMobileToolbar();
            formatCreatedAt();
            initGiftCardInput();
            checkUrlMessages();
            renderRechargeAmounts();
            loadUnreadCount();
        });

        // Check URL parameters for success/error messages
        function checkUrlMessages() {
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            const error = urlParams.get('error');
            
            if (success) {
                if (success === 'google_bind_success' || success === 'steam_bind_success' || success === 'discord_bind_success') {
                    showToast(bindingI18n.bindSuccess, false);
                }
                // Clear the URL parameter
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (error) {
                showToast(decodeURIComponent(error), true);
                // Clear the URL parameter
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // I18n strings for binding
        const bindingI18n = {
            bound: "{{t .lang "binding.bound"}}",
            notBound: "{{t .lang "binding.not_bound"}}",
            bind: "{{t .lang "binding.bind"}}",
            unbind: "{{t .lang "binding.unbind"}}",
            bindDisabled: "{{t .lang "binding.bind_disabled"}}",
            unbindDisabled: "{{t .lang "binding.unbind_disabled"}}",
            unbindConfirmTitle: "{{t .lang "binding.unbind_confirm_title"}}",
            unbindConfirmMessage: "{{t .lang "binding.unbind_confirm_message"}}",
            unbindConfirm: "{{t .lang "binding.unbind_confirm"}}",
            unbindCancel: "{{t .lang "binding.unbind_cancel"}}",
            unbindSuccess: "{{t .lang "binding.unbind_success"}}",
            unbindError: "{{t .lang "binding.unbind_error"}}",
            bindSuccess: "{{t .lang "binding.bind_success"}}",
            bindError: "{{t .lang "binding.bind_error"}}"
        };

        async function loadThirdPartyBindingStatus() {
            try {
                const response = await fetch('/api/auth/third-party-status');
                const result = await response.json();
                if (result.success && result.data) {
                    bindingStatus = result.data;
                    renderBindingStatus();
                }
            } catch (error) {
                console.error('Failed to load binding status:', error);
            }
        }

        function renderBindingStatus() {
            const emptyState = document.getElementById('binding-empty-state');
            let hasAnyBinding = false;

            // Render Google binding status
            if (bindingStatus.google) {
                const googleRow = document.getElementById('binding-google-row');
                const googleStatus = document.getElementById('binding-google-status');
                if (bindingStatus.google.enabled || bindingStatus.google.bound) {
                    googleRow.style.display = 'flex';
                    hasAnyBinding = true;
                    googleStatus.innerHTML = renderBindingButton('google', bindingStatus.google);
                }
            }

            // Render Steam binding status
            if (bindingStatus.steam) {
                const steamRow = document.getElementById('binding-steam-row');
                const steamStatus = document.getElementById('binding-steam-status');
                if (bindingStatus.steam.enabled || bindingStatus.steam.bound) {
                    steamRow.style.display = 'flex';
                    hasAnyBinding = true;
                    steamStatus.innerHTML = renderBindingButton('steam', bindingStatus.steam);
                }
            }

            // Render Discord binding status
            if (bindingStatus.discord) {
                const discordRow = document.getElementById('binding-discord-row');
                const discordStatus = document.getElementById('binding-discord-status');
                if (bindingStatus.discord.enabled || bindingStatus.discord.bound) {
                    discordRow.style.display = 'flex';
                    hasAnyBinding = true;
                    discordStatus.innerHTML = renderBindingButton('discord', bindingStatus.discord);
                }
            }

            // Show/hide empty state
            if (emptyState) {
                emptyState.style.display = hasAnyBinding ? 'none' : 'block';
            }
        }

        function renderBindingButton(provider, status) {
            if (status.bound) {
                // Account is bound - show unbind button or badge
                if (status.allow_unbind) {
                    return `<span class="badge bg-success me-2">${bindingI18n.bound}</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmUnbind('${provider}')">
                                <i class="bi bi-link-break me-1"></i>${bindingI18n.unbind}
                            </button>`;
                } else {
                    return `<span class="badge bg-success">${bindingI18n.bound}</span>
                            <small class="text-muted ms-2">${bindingI18n.unbindDisabled}</small>`;
                }
            } else {
                // Account is not bound - show bind button
                if (status.allow_bind) {
                    return `<span class="badge bg-secondary me-2">${bindingI18n.notBound}</span>
                            <a href="/api/auth/${provider}/bind" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-link me-1"></i>${bindingI18n.bind}
                            </a>`;
                } else {
                    return `<span class="badge bg-secondary">${bindingI18n.notBound}</span>
                            <small class="text-muted ms-2">${bindingI18n.bindDisabled}</small>`;
                }
            }
        }

        function confirmUnbind(provider) {
            const modalHtml = `
                <div class="modal fade" id="unbindConfirmModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>${bindingI18n.unbindConfirmTitle}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body py-4">
                                <p>${bindingI18n.unbindConfirmMessage}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${bindingI18n.unbindCancel}</button>
                                <button type="button" class="btn btn-danger" onclick="performUnbind('${provider}')">
                                    <i class="bi bi-link-break me-1"></i>${bindingI18n.unbindConfirm}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('unbindConfirmModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('unbindConfirmModal')).show();
        }

        async function performUnbind(provider) {
            try {
                const response = await fetch(`/api/auth/unbind/${provider}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('unbindConfirmModal'));
                if (modal) modal.hide();
                
                if (result.success) {
                    showToast(bindingI18n.unbindSuccess, false);
                    // Reload binding status
                    loadThirdPartyBindingStatus();
                } else {
                    showToast(result.message || bindingI18n.unbindError, true);
                }
            } catch (error) {
                showToast(bindingI18n.unbindError, true);
            }
        }

        async function loadMobileToolbar() {
            try {
                const response = await fetch('/api/mobile-toolbar');
                const result = await response.json();
                if (result.success && result.enabled) {
                    renderMobileToolbar(result.data);
                }
            } catch (error) {
                console.error('Failed to load mobile toolbar:', error);
            }
        }

        function renderMobileToolbar(items) {
            const toolbar = document.getElementById('mobile-toolbar');
            const container = document.getElementById('mobile-toolbar-items');
            if (!toolbar || !container || !items || items.length === 0) return;

            toolbar.classList.add('enabled');
            document.body.classList.add('has-mobile-toolbar');

            // Sort by order
            const sortedItems = [...items].sort((a, b) => a.order - b.order);
            const currentPath = window.location.pathname;

            container.innerHTML = sortedItems.map(item => {
                const title = (item.title_i18n && item.title_i18n[currentLang]) || item.title;
                const isActive = currentPath === item.url || (item.url !== '/' && currentPath.startsWith(item.url));
                const activeClass = isActive ? 'active' : '';
                const safeIcon = item.icon || 'bi-link';
                const safeUrl = item.url || '#';
                
                return `<a href="${safeUrl}" class="mobile-toolbar-item ${activeClass}">
                    <i class="${safeIcon}"></i>
                    <span>${title}</span>
                </a>`;
            }).join('');
        }

        async function loadVIPLevels() {
            try {
                const response = await fetch('/api/vip-levels');
                const result = await response.json();
                if (result.success) {
                    vipLevels = result.data || [];
                    updateVIPDisplay();
                }
            } catch (error) {
                console.error('Failed to load VIP levels:', error);
            }
        }

        // I18n strings for VIP expiration display
        const i18nStrings = {
            vipExpireAt: "{{t .lang "profile.vip_expire_at"}}",
            vipPermanent: "{{t .lang "profile.vip_permanent"}}",
            vipExpired: "{{t .lang "profile.vip_expired"}}",
            // Gift card VIP warning i18n
            vipWarningTitle: "{{t .lang "gift_card.vip_warning_title"}}",
            vipWarningMessage: "{{t .lang "gift_card.vip_warning_message"}}",
            vipWarningCurrent: "{{t .lang "gift_card.vip_warning_current"}}",
            vipWarningCardVip: "{{t .lang "gift_card.vip_warning_card_vip"}}",
            vipWarningExpires: "{{t .lang "gift_card.vip_warning_expires"}}",
            vipWarningPermanent: "{{t .lang "gift_card.vip_warning_permanent"}}",
            vipWarningDays: "{{t .lang "gift_card.vip_warning_days"}}",
            vipWarningConfirm: "{{t .lang "gift_card.vip_warning_confirm"}}",
            vipWarningCancel: "{{t .lang "gift_card.vip_warning_cancel"}}",
            vipWarningBalanceNote: "{{t .lang "gift_card.vip_warning_balance_note"}}",
            vipSkipped: "{{t .lang "gift_card.vip_skipped"}}",
            balance: "{{t .lang "gift_card.balance"}}",
            balanceAdded: "{{t .lang "gift_card.balance_added"}}",
            vipGranted: "{{t .lang "gift_card.vip_granted"}}",
            redeemSuccess: "{{t .lang "gift_card.redeem_success"}}",
            redeemSuccessTitle: "{{t .lang "gift_card.redeem_success_title"}}",
            currentBalance: "{{t .lang "gift_card.current_balance"}}",
            confirmBtn: "{{t .lang "gift_card.confirm_btn"}}",
            // Recharge i18n
            rechargeBonus: "{{t .lang "recharge.bonus"}}",
            // Payment i18n
            paymentAlipay: "{{t .lang "payment.alipay"}}",
            paymentWechat: "{{t .lang "payment.wechat"}}",
            paymentProcessing: "{{t .lang "payment.processing"}}",
            paymentNotConfiguredTitle: "{{t .lang "payment.not_configured_title"}}",
            paymentNotConfiguredMsg: "{{t .lang "payment.not_configured_msg"}}",
            paymentOrderInfo: "{{t .lang "payment.order_info"}}",
            paymentClose: "{{t .lang "payment.close"}}",
            paymentRedirectTitle: "{{t .lang "payment.redirect_title"}}",
            paymentRedirectPreparing: "{{t .lang "payment.redirect_preparing"}}",
            paymentRedirectMsg: "{{t .lang "payment.redirect_msg"}}",
            paymentProduct: "{{t .lang "payment.product"}}",
            paymentPayAmount: "{{t .lang "payment.pay_amount"}}",
            paymentMethod: "{{t .lang "payment.method"}}",
            paymentDemoTitle: "{{t .lang "payment.demo_title"}}",
            paymentDemoMsg: "{{t .lang "payment.demo_msg"}}",
            paymentOrderDetails: "{{t .lang "payment.order_details"}}",
            paymentDemoNote: "{{t .lang "payment.demo_note"}}",
            paymentGoConfigure: "{{t .lang "payment.go_configure"}}",
            paymentErrorTitle: "{{t .lang "payment.error_title"}}",
            paymentErrorMsg: "{{t .lang "payment.error_msg"}}",
            paymentSelectAmount: "{{t .lang "payment.select_amount"}}",
            paymentAccountRecharge: "{{t .lang "payment.account_recharge"}}",
            paymentSecureNote: "{{t .lang "payment.secure_note"}}"
        };

        async function loadUserBalance() {
            try {
                const response = await fetch('/api/auth/balance');
                const result = await response.json();
                if (result.success && result.data) {
                    const userBalanceEl = document.getElementById('user-balance');
                    const availableBalanceEl = document.getElementById('available-balance');
                    if (userBalanceEl) userBalanceEl.textContent = result.data.balance.toFixed(2);
                    if (availableBalanceEl) availableBalanceEl.textContent = result.data.balance.toFixed(2);
                    
                    if (result.data.vip_name) {
                        const vipNameEl = document.getElementById('vip-name');
                        const vipLevelName = document.getElementById('vip-level-name');
                        if (vipNameEl) vipNameEl.textContent = result.data.vip_name;
                        if (vipLevelName) vipLevelName.textContent = result.data.vip_name;
                    }
                    
                    // Update VIP expiration display
                    const vipExpireInfo = document.getElementById('vip-expire-info');
                    if (vipExpireInfo && result.data.vip_level > 0) {
                        if (result.data.vip_expire_at) {
                            const expireDate = new Date(result.data.vip_expire_at);
                            const now = new Date();
                            if (expireDate > now) {
                                // Use BCP 47 language tag based on current language
                                const localeMap = {'zh': 'zh-CN', 'en': 'en-US'};
                                const currentLang = '{{.lang}}';
                                const locale = localeMap[currentLang] || 'en-US';
                                // Include hour precision in the date format
                                const formattedDate = expireDate.toLocaleString(locale, {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                vipExpireInfo.textContent = `${i18nStrings.vipExpireAt} ${formattedDate}`;
                            } else {
                                vipExpireInfo.innerHTML = `<span class="text-danger">${i18nStrings.vipExpired}</span>`;
                            }
                        } else {
                            // No expiration date means permanent VIP
                            vipExpireInfo.textContent = `${i18nStrings.vipExpireAt}: ${i18nStrings.vipPermanent}`;
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load user balance:', error);
            }
        }

        function updateVIPDisplay() {
            const vipLevel = {{if .user}}{{.user.VIPLevel}}{{else}}0{{end}};
            const vipConfig = vipLevels.find(v => v.level === vipLevel);
            
            if (vipConfig) {
                const vipBadge = document.getElementById('vip-badge');
                const vipLevelName = document.getElementById('vip-level-name');
                const vipLevelDisplay = document.getElementById('vip-level-display');
                const memberDays = document.getElementById('member-days');
                
                if (vipBadge) {
                    vipBadge.style.background = `linear-gradient(135deg, ${vipConfig.color || '#ffd700'} 0%, ${adjustColor(vipConfig.color || '#ffd700', -30)} 100%)`;
                }
                if (vipLevelName) vipLevelName.textContent = vipConfig.name;
                if (vipLevelDisplay) vipLevelDisplay.textContent = vipConfig.name;
                if (memberDays) {
                    if (vipConfig.duration > 0) {
                        memberDays.textContent = vipConfig.duration;
                    } else {
                        memberDays.textContent = i18nStrings.vipPermanent;
                    }
                }
            } else {
                const memberDays = document.getElementById('member-days');
                if (memberDays) memberDays.textContent = '-';
            }
        }

        function adjustColor(color, amount) {
            const clamp = (val) => Math.min(255, Math.max(0, val));
            let hex = color.replace('#', '');
            if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
            const num = parseInt(hex, 16);
            const r = clamp(((num >> 16) & 0xFF) + amount);
            const g = clamp(((num >> 8) & 0xFF) + amount);
            const b = clamp((num & 0xFF) + amount);
            return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
        }

        function formatCreatedAt() {
            const el = document.getElementById('created-at');
            if (el) {
                const rawDate = el.textContent.trim();
                const date = new Date(rawDate);
                // Check if date is valid
                if (!isNaN(date.getTime()) && date.getFullYear() > 1970) {
                    el.textContent = date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } else {
                    // If date is invalid, show a fallback
                    el.textContent = '-';
                }
            }
        }

        function initGiftCardInput() {
            const codeInput = document.getElementById('gift-card-code');
            if (codeInput) {
                codeInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
                    if (value.length > 16) value = value.substring(0, 16);
                    let formatted = '';
                    for (let i = 0; i < value.length; i++) {
                        if (i > 0 && i % 4 === 0) formatted += '-';
                        formatted += value[i];
                    }
                    e.target.value = formatted;
                });
            }
        }

        async function saveProfile() {
            const displayName = document.getElementById('display-name').value;
            const avatar = document.getElementById('avatar-url').value;

            try {
                const response = await fetch('/api/auth/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        display_name: displayName,
                        avatar: avatar
                    })
                });

                const result = await response.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
                    showToast('个人资料已更新', false);
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(result.message || '保存失败', true);
                }
            } catch (error) {
                showToast('保存失败，请稍后重试', true);
            }
        }

        async function redeemGiftCard(confirmVipConflict = false) {
            const codeInput = document.getElementById('gift-card-code');
            const code = codeInput.value.trim().toUpperCase();
            
            if (!code) {
                showToast('请输入礼品卡码', true);
                return;
            }

            if (code.replace(/-/g, '').length !== 16) {
                showToast('请输入有效的16位礼品卡码', true);
                return;
            }

            try {
                const response = await fetch('/api/auth/redeem-gift-card', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code, confirm: confirmVipConflict })
                });

                const result = await response.json();
                
                // Handle VIP conflict - show warning modal
                if (response.status === 409 && result.requires_confirm) {
                    showVipConflictWarningModal(code, result.data);
                    return;
                }
                
                if (result.success) {
                    codeInput.value = '';
                    bootstrap.Modal.getInstance(document.getElementById('giftCardModal')).hide();
                    
                    // Update balance display
                    if (result.data) {
                        const userBalanceEl = document.getElementById('user-balance');
                        const availableBalanceEl = document.getElementById('available-balance');
                        if (userBalanceEl) userBalanceEl.textContent = result.data.balance.toFixed(2);
                        if (availableBalanceEl) availableBalanceEl.textContent = result.data.balance.toFixed(2);
                    }
                    
                    showRedeemSuccessModal(result.data, result.data?.vip_skipped || false);
                } else {
                    showToast(result.message || '兑换失败', true);
                }
            } catch (error) {
                showToast('兑换失败，请稍后重试', true);
            }
        }

        function showVipConflictWarningModal(code, data) {
            // Format VIP expiration date
            let currentVipExpireText = i18nStrings.vipWarningPermanent;
            if (data.current_vip_expire_at) {
                const expireDate = new Date(data.current_vip_expire_at);
                const localeMap = {'zh': 'zh-CN', 'en': 'en-US'};
                const currentLang = '{{.lang}}';
                const locale = localeMap[currentLang] || 'en-US';
                currentVipExpireText = expireDate.toLocaleDateString(locale, {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            
            // Format card VIP duration - prefer hours if set, otherwise days
            let cardVipDurationText = i18nStrings.vipWarningPermanent;
            if (data.card_vip_hours > 0) {
                cardVipDurationText = `${data.card_vip_hours} ${i18nStrings.vipWarningHours || '小时'}`;
            } else if (data.card_vip_days > 0) {
                cardVipDurationText = `${data.card_vip_days} ${i18nStrings.vipWarningDays}`;
            }
            
            const modalHtml = `
                <div class="modal fade" id="vipConflictModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>${i18nStrings.vipWarningTitle}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body py-4">
                                <div class="alert alert-warning mb-3">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    ${i18nStrings.vipWarningMessage}
                                </div>
                                <div class="bg-light rounded p-3 mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">${i18nStrings.vipWarningCurrent}</span>
                                        <strong>VIP ${data.current_vip_level}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">${i18nStrings.vipWarningExpires}</span>
                                        <strong>${currentVipExpireText}</strong>
                                    </div>
                                    <hr class="my-2">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">${i18nStrings.vipWarningCardVip}</span>
                                        <strong class="text-muted text-decoration-line-through">VIP ${data.card_vip_level} (${cardVipDurationText})</strong>
                                    </div>
                                    ${data.card_amount > 0 ? `
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">${i18nStrings.balance}</span>
                                        <strong class="text-success">¥${data.card_amount.toFixed(2)}</strong>
                                    </div>
                                    ` : ''}
                                </div>
                                ${data.card_amount > 0 ? `
                                <p class="text-info small mb-0">
                                    <i class="bi bi-info-circle me-1"></i>${i18nStrings.vipWarningBalanceNote}
                                </p>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${i18nStrings.vipWarningCancel}</button>
                                <button type="button" class="btn btn-warning" onclick="confirmRedeemWithVipConflict('${code}')">
                                    <i class="bi bi-check-lg me-1"></i>${i18nStrings.vipWarningConfirm}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('vipConflictModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('vipConflictModal')).show();
        }

        async function confirmRedeemWithVipConflict(code) {
            // Close the warning modal
            const warningModal = bootstrap.Modal.getInstance(document.getElementById('vipConflictModal'));
            if (warningModal) warningModal.hide();
            
            // Re-enter the code and trigger redeem with confirmation
            const codeInput = document.getElementById('gift-card-code');
            codeInput.value = code;
            
            // Call redeem with confirmation flag
            await redeemGiftCard(true);
        }

        function showRedeemSuccessModal(data, vipSkipped = false) {
            const amount = data?.amount || 0;
            const newBalance = data?.balance || 0;
            const grantedVipLevel = data?.granted_vip_level || 0;
            const grantedVipDays = data?.granted_vip_days || 0;
            const grantedVipHours = data?.granted_vip_hours || 0;
            
            let rewardContent = '';
            if (amount > 0) {
                rewardContent += `<p class="mb-2">${i18nStrings.balanceAdded}<strong class="text-success fs-4">¥${amount.toFixed(2)}</strong></p>`;
            }
            if (grantedVipLevel > 0 && !vipSkipped) {
                rewardContent += `<p class="mb-2">${i18nStrings.vipGranted}<strong class="text-warning fs-4"><i class="bi bi-gem me-1"></i>VIP${grantedVipLevel}</strong>`;
                // Display hours if set, otherwise days
                if (grantedVipHours > 0) {
                    rewardContent += ` <span class="text-muted">(${grantedVipHours}${i18nStrings.vipWarningHours || '小时'})</span>`;
                } else if (grantedVipDays > 0) {
                    rewardContent += ` <span class="text-muted">(${grantedVipDays}${i18nStrings.vipWarningDays})</span>`;
                } else {
                    rewardContent += ` <span class="text-muted">(${i18nStrings.vipWarningPermanent})</span>`;
                }
                rewardContent += `</p>`;
            }
            if (vipSkipped) {
                rewardContent += `<p class="text-warning small mb-2"><i class="bi bi-info-circle me-1"></i>${i18nStrings.vipSkipped}</p>`;
            }
            
            const modalHtml = `
                <div class="modal fade" id="redeemSuccessModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title"><i class="bi bi-gift me-2"></i>${i18nStrings.redeemSuccess}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-gift display-1 text-success mb-3"></i>
                                <h4>${i18nStrings.redeemSuccessTitle}</h4>
                                ${rewardContent}
                                <p class="text-muted">${i18nStrings.currentBalance}¥${newBalance.toFixed(2)}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                                    <i class="bi bi-check-lg me-2"></i>${i18nStrings.confirmBtn}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('redeemSuccessModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('redeemSuccessModal')).show();
        }

        function showToast(message, isError = false) {
            // Create toast container if not exists
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(container);
            }

            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast ${isError ? 'bg-danger' : 'bg-success'} text-white" role="alert">
                    <div class="toast-body d-flex align-items-center">
                        <i class="bi ${isError ? 'bi-exclamation-circle' : 'bi-check-circle'} me-2"></i>
                        ${message}
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastEl = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
            
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }

        async function changePassword() {
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!oldPassword || !newPassword || !confirmPassword) {
                showToast('请填写所有密码字段', true);
                return;
            }

            if (newPassword.length < 6) {
                showToast('新密码长度至少6个字符', true);
                return;
            }

            if (newPassword !== confirmPassword) {
                showToast('两次输入的新密码不一致', true);
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Clear form
                    document.getElementById('old-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                    bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                    showToast('密码修改成功', false);
                } else {
                    showToast(result.message || '密码修改失败', true);
                }
            } catch (error) {
                showToast('密码修改失败，请稍后重试', true);
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/auth/login';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Language switcher function
        async function setLanguage(lang) {
            try {
                const response = await fetch('/api/i18n/set-language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lang: lang })
                });
                const data = await response.json();
                if (data.success) {
                    window.location.reload();
                }
            } catch (error) {
                console.error('Failed to set language:', error);
            }
        }

        // Recharge functions
        function renderRechargeAmounts() {
            const container = document.getElementById('recharge-amounts-container');
            if (!container) return;
            
            const amounts = [
                { value: 10, bonus: '' },
                { value: 30, bonus: '' },
                { value: 50, bonus: i18nStrings.rechargeBonus + ' ¥2' },
                { value: 100, bonus: i18nStrings.rechargeBonus + ' ¥5' },
                { value: 200, bonus: i18nStrings.rechargeBonus + ' ¥15' },
                { value: 500, bonus: i18nStrings.rechargeBonus + ' ¥50' }
            ];
            
            const fragment = document.createDocumentFragment();
            amounts.forEach(item => {
                const col = document.createElement('div');
                col.className = 'col-4';
                const card = document.createElement('div');
                card.className = 'recharge-amount-card';
                card.dataset.amount = item.value;
                card.onclick = () => selectRechargeAmount(item.value);
                const amountDiv = document.createElement('div');
                amountDiv.className = 'amount';
                amountDiv.textContent = '¥' + item.value;
                const bonusDiv = document.createElement('div');
                bonusDiv.className = 'bonus';
                bonusDiv.innerHTML = item.bonus || '&nbsp;';
                card.appendChild(amountDiv);
                card.appendChild(bonusDiv);
                col.appendChild(card);
                fragment.appendChild(col);
            });
            container.innerHTML = '';
            container.appendChild(fragment);
        }

        function selectRechargeAmount(amount) {
            selectedRechargeAmount = amount;
            document.querySelectorAll('.recharge-amount-card').forEach(card => {
                card.classList.remove('selected');
                if (parseFloat(card.dataset.amount) === amount) {
                    card.classList.add('selected');
                }
            });
            document.getElementById('custom-recharge-amount').value = '';
            document.getElementById('confirm-recharge-btn').disabled = false;
        }

        function selectCustomRechargeAmount() {
            const input = document.getElementById('custom-recharge-amount');
            const amount = parseFloat(input.value);
            if (amount > 0) {
                selectedRechargeAmount = amount;
                document.querySelectorAll('.recharge-amount-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.getElementById('confirm-recharge-btn').disabled = false;
            }
        }

        function openPaymentFromProfile() {
            if (selectedRechargeAmount <= 0) {
                showToast(i18nStrings.paymentSelectAmount, true);
                return;
            }
            
            // Hide recharge modal
            const rechargeModal = bootstrap.Modal.getInstance(document.getElementById('rechargeModal'));
            if (rechargeModal) rechargeModal.hide();
            
            // Show payment modal
            document.getElementById('payment-product-name').textContent = i18nStrings.paymentAccountRecharge;
            document.getElementById('payment-amount').textContent = '¥' + selectedRechargeAmount.toFixed(2);
            
            setTimeout(() => {
                new bootstrap.Modal(document.getElementById('paymentModal')).show();
            }, 300);
        }

        function selectPaymentMethod(method) {
            paymentMethod = method;
            document.querySelectorAll('.payment-method-option').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.method === method) {
                    el.classList.add('selected');
                }
            });
        }

        async function submitPaymentFromProfile() {
            const amount = selectedRechargeAmount;
            const productName = i18nStrings.paymentAccountRecharge;

            const submitBtn = document.querySelector('#paymentModal .btn-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>' + i18nStrings.paymentProcessing;

            try {
                const settingsRes = await fetch('/api/site-settings');
                const settings = await settingsRes.json();
                
                if (!settings.success || !settings.data.payment_enabled) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentNotConfiguredModal(productName, amount);
                    return;
                }

                const paymentRes = await fetch('/api/payment/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_type: 'recharge',
                        product_id: 0,
                        amount: amount,
                        payment_method: paymentMethod
                    })
                });

                const paymentResult = await paymentRes.json();
                
                if (!paymentResult.success) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showToast(paymentResult.message || i18nStrings.paymentErrorMsg, true);
                    return;
                }

                if (paymentResult.demo_mode) {
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentDemoModal(productName, amount);
                    return;
                }

                if (paymentResult.data && paymentResult.data.payment_url) {
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showPaymentRedirectModal(productName, amount, paymentResult.data.payment_url);
                } else {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    showToast(i18nStrings.paymentErrorMsg, true);
                }
                
            } catch (error) {
                console.error('Payment error:', error);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                showToast(i18nStrings.paymentErrorMsg, true);
            }
        }

        function showPaymentNotConfiguredModal(productName, amount) {
            const modalHtml = `
                <div class="modal fade" id="paymentNotConfiguredModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>${i18nStrings.paymentNotConfiguredTitle}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center py-4">
                                <i class="bi bi-gear display-1 text-muted mb-3"></i>
                                <h5>${i18nStrings.paymentNotConfiguredTitle}</h5>
                                <p class="text-muted mb-4">${i18nStrings.paymentNotConfiguredMsg}</p>
                                <div class="bg-light rounded p-3 mb-3">
                                    <small class="text-muted d-block">${i18nStrings.paymentOrderInfo}</small>
                                    <strong>${productName}</strong>
                                    <span class="text-primary ms-2">¥${amount.toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${i18nStrings.paymentClose}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('paymentNotConfiguredModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentNotConfiguredModal')).show();
        }

        function showPaymentRedirectModal(productName, amount, paymentUrl) {
            const methodText = paymentMethod === 'alipay' ? i18nStrings.paymentAlipay : i18nStrings.paymentWechat;
            const modalHtml = `
                <div class="modal fade" id="paymentRedirectModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>${i18nStrings.paymentRedirectTitle}</h5>
                            </div>
                            <div class="modal-body text-center py-5">
                                <div class="spinner-border text-primary mb-4" style="width: 3rem; height: 3rem;" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h5>${i18nStrings.paymentRedirectPreparing}</h5>
                                <p class="text-muted mb-4">${i18nStrings.paymentRedirectMsg}</p>
                                <div class="bg-light rounded p-3 mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted">${i18nStrings.paymentProduct}</span>
                                        <strong>${productName}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span class="text-muted">${i18nStrings.paymentPayAmount}</span>
                                        <strong class="text-primary">¥${amount.toFixed(2)}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span class="text-muted">${i18nStrings.paymentMethod}</span>
                                        <strong>${methodText}</strong>
                                    </div>
                                </div>
                                <p class="text-muted small"><i class="bi bi-shield-check me-1"></i>${i18nStrings.paymentSecureNote}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('paymentRedirectModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentRedirectModal')).show();

            if (paymentUrl) {
                try {
                    const urlObj = new URL(paymentUrl);
                    if (urlObj.protocol === 'https:') {
                        setTimeout(() => { window.location.href = paymentUrl; }, 2000);
                    } else {
                        showToast(i18nStrings.paymentErrorMsg, true);
                    }
                } catch (e) {
                    showToast(i18nStrings.paymentErrorMsg, true);
                }
            }
        }

        function showPaymentDemoModal(productName, amount) {
            const methodText = paymentMethod === 'alipay' ? i18nStrings.paymentAlipay : i18nStrings.paymentWechat;
            const modalHtml = `
                <div class="modal fade" id="paymentDemoModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>${i18nStrings.paymentDemoTitle}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-lightbulb me-2"></i><strong>${i18nStrings.paymentDemoTitle}</strong>
                                </div>
                                <p>${i18nStrings.paymentDemoMsg}</p>
                                <div class="bg-light rounded p-3 mb-3">
                                    <h6 class="mb-2">${i18nStrings.paymentOrderDetails}</h6>
                                    <div class="d-flex justify-content-between">
                                        <span>${i18nStrings.paymentProduct}</span>
                                        <strong>${productName}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>${i18nStrings.paymentPayAmount}</span>
                                        <strong class="text-primary">¥${amount.toFixed(2)}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>${i18nStrings.paymentMethod}</span>
                                        <strong>${methodText}</strong>
                                    </div>
                                </div>
                                <p class="mb-0 text-muted small"><i class="bi bi-gear me-1"></i>${i18nStrings.paymentDemoNote}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${i18nStrings.paymentClose}</button>
                                <a href="/admin/vip" class="btn btn-primary" target="_blank">
                                    <i class="bi bi-gear me-2"></i>${i18nStrings.paymentGoConfigure}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('paymentDemoModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('paymentDemoModal')).show();
        }

        // Message Box i18n strings
        const messagesI18n = {
            title: "{{t .lang "messages.title"}}",
            inbox: "{{t .lang "messages.inbox"}}",
            noMessages: "{{t .lang "messages.no_messages"}}",
            markAllRead: "{{t .lang "messages.mark_all_read"}}",
            unread: "{{t .lang "messages.unread"}}",
            read: "{{t .lang "messages.read"}}",
            deleteConfirm: "{{t .lang "messages.delete_confirm"}}",
            deleteSuccess: "{{t .lang "messages.delete_success"}}",
            markReadSuccess: "{{t .lang "messages.mark_read_success"}}",
            markAllReadSuccess: "{{t .lang "messages.mark_all_read_success"}}",
            newMessages: "{{t .lang "messages.new_messages"}}",
            emptyTitle: "{{t .lang "messages.empty_title"}}",
            emptyDesc: "{{t .lang "messages.empty_desc"}}",
            typeNormal: "{{t .lang "messages.type_normal"}}",
            typeSystem: "{{t .lang "messages.type_system"}}",
            typeAnnouncement: "{{t .lang "messages.type_announcement"}}",
            timeJustNow: "{{t .lang "messages.time_just_now"}}",
            timeMinutesAgo: "{{t .lang "messages.time_minutes_ago"}}",
            timeHoursAgo: "{{t .lang "messages.time_hours_ago"}}",
            timeDaysAgo: "{{t .lang "messages.time_days_ago"}}",
            batchSelect: "{{t .lang "messages.batch_select"}}",
            batchDelete: "{{t .lang "messages.batch_delete"}}",
            batchDeleteConfirm: "{{t .lang "messages.batch_delete_confirm"}}",
            batchDeleteSuccess: "{{t .lang "messages.batch_delete_success"}}",
            selected: "{{t .lang "messages.selected"}}",
            cancelSelect: "{{t .lang "messages.cancel_select"}}",
            deleteFailed: "{{t .lang "messages.delete_failed"}}",
            selectMessage: "{{t .lang "messages.select_message"}}"
        };

        // Batch select mode state
        let batchSelectMode = false;
        let selectedMessageIds = new Set();

        // Load unread message count
        async function loadUnreadCount() {
            try {
                const response = await fetch('/api/messages/unread-count');
                const result = await response.json();
                if (result.success && result.data) {
                    const count = result.data.unread_count || 0;
                    const badge = document.getElementById('unread-badge');
                    const bellIcon = document.querySelector('a[data-bs-target="#messagesModal"] i');
                    
                    if (badge) {
                        if (count > 0) {
                            badge.textContent = count > 99 ? '99+' : count;
                            badge.style.display = 'flex';
                            badge.classList.add('badge-visible');
                            
                            // Only show animations/notifications for new messages after initial load
                            // previousUnreadCount === -1 means this is the first load
                            if (previousUnreadCount !== -1 && count > previousUnreadCount) {
                                // Add bounce animation class
                                badge.classList.remove('badge-bounce');
                                // Force DOM reflow to restart the CSS animation
                                void badge.offsetWidth;
                                badge.classList.add('badge-bounce');
                                
                                // Animate bell icon when there are new messages
                                if (bellIcon) {
                                    bellIcon.classList.remove('bell-shake');
                                    // Force DOM reflow to restart the CSS animation
                                    void bellIcon.offsetWidth;
                                    bellIcon.classList.add('bell-shake');
                                }
                                // Show toast notification for new messages
                                const newCount = count - previousUnreadCount;
                                if (newCount > 0) {
                                    showToast(`${newCount} ${messagesI18n.newMessages}`, false);
                                }
                            }
                        } else {
                            badge.style.display = 'none';
                            badge.classList.remove('badge-visible', 'badge-bounce');
                        }
                    }
                    previousUnreadCount = count;
                }
            } catch (error) {
                console.error('Failed to load unread count:', error);
            }
        }

        // Load messages with pagination
        async function loadMessages() {
            loadMessagesPage(1);
        }

        // Load messages for specific page
        async function loadMessagesPage(page) {
            if (page < 1) page = 1;
            
            try {
                const response = await fetch(`/api/messages?page=${page}&page_size=${messagesPerPage}`);
                const result = await response.json();
                if (result.success && result.data) {
                    messagesData = result.data.messages || [];
                    totalMessagesCount = result.data.total || 0;
                    currentMessagesPage = page;
                    totalMessagesPages = Math.ceil(totalMessagesCount / messagesPerPage) || 1;
                    
                    // Update UI
                    document.getElementById('messages-count').textContent = totalMessagesCount;
                    renderMessages(messagesData);
                    updatePagination();
                    updateUnreadHeader();
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
            }
        }

        // Update pagination controls
        function updatePagination() {
            const paginationDiv = document.getElementById('messages-pagination');
            const prevBtn = document.getElementById('msg-prev-btn');
            const nextBtn = document.getElementById('msg-next-btn');
            const currentPageSpan = document.getElementById('msg-current-page');
            const totalPagesSpan = document.getElementById('msg-total-pages');
            
            if (totalMessagesPages <= 1) {
                paginationDiv.style.display = 'none';
            } else {
                paginationDiv.style.display = 'flex';
                currentPageSpan.textContent = currentMessagesPage;
                totalPagesSpan.textContent = totalMessagesPages;
                prevBtn.disabled = currentMessagesPage <= 1;
                nextBtn.disabled = currentMessagesPage >= totalMessagesPages;
            }
        }

        // Update unread count header in messages modal
        async function updateUnreadHeader() {
            try {
                const response = await fetch('/api/messages/unread-count');
                const result = await response.json();
                if (result.success && result.data) {
                    const count = result.data.unread_count || 0;
                    const unreadHeader = document.getElementById('unread-count-header');
                    const unreadNumber = document.getElementById('unread-count-number');
                    const markAllBtn = document.getElementById('mark-all-read-btn');
                    
                    if (count > 0) {
                        unreadHeader.style.display = 'inline-block';
                        unreadNumber.textContent = count;
                        markAllBtn.disabled = false;
                    } else {
                        unreadHeader.style.display = 'none';
                        markAllBtn.disabled = true;
                    }
                }
            } catch (error) {
                console.error('Failed to update unread header:', error);
            }
        }

        // Render messages list
        function renderMessages(messages) {
            const container = document.getElementById('messages-list');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-inbox display-4 d-block mb-3" style="opacity: 0.3;"></i>
                        <h6>${messagesI18n.emptyTitle}</h6>
                        <p class="small mb-0">${messagesI18n.emptyDesc}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isUnread = !msg.is_read;
                const typeClass = msg.type === 'system' ? 'bg-info' : 
                                 msg.type === 'announcement' ? 'bg-warning text-dark' : 'bg-secondary';
                const typeText = msg.type === 'system' ? messagesI18n.typeSystem : 
                                msg.type === 'announcement' ? messagesI18n.typeAnnouncement : messagesI18n.typeNormal;
                const date = new Date(msg.created_at);
                const timeStr = formatMessageTime(date);
                const previewContent = escapeHtml(msg.content.substring(0, 100)) + (msg.content.length > 100 ? '...' : '');
                const isSelected = selectedMessageIds.has(msg.id);
                const batchModeClass = batchSelectMode ? 'batch-select-mode' : '';
                const selectedClass = isSelected ? 'selected' : '';
                
                return `
                    <div class="message-item ${isUnread ? 'unread' : ''} ${batchModeClass} ${selectedClass}" data-message-id="${msg.id}" onclick="handleMessageClick(event, ${msg.id})">
                        <div class="d-flex align-items-start">
                            <div class="form-check message-checkbox" onclick="event.stopPropagation()">
                                <input class="form-check-input" type="checkbox" id="msg-check-${msg.id}" aria-label="${messagesI18n.selectMessage}: ${escapeHtml(msg.title)}" ${isSelected ? 'checked' : ''} onchange="toggleMessageSelection(${msg.id})">
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="message-title">
                                        ${isUnread ? '<span class="badge bg-danger message-new-badge">NEW</span>' : ''}
                                        <span class="text-truncate" style="max-width: 300px;">${escapeHtml(msg.title)}</span>
                                        <span class="badge ${typeClass} message-type-badge">${typeText}</span>
                                    </div>
                                    <span class="message-time">${timeStr}</span>
                                </div>
                                <div class="message-preview mt-1">${previewContent}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Handle message click - either open or toggle selection based on mode
        function handleMessageClick(event, messageId) {
            if (batchSelectMode) {
                toggleMessageSelection(messageId);
            } else {
                openMessage(messageId);
            }
        }

        // Toggle batch select mode
        function toggleBatchSelectMode() {
            batchSelectMode = !batchSelectMode;
            selectedMessageIds.clear();
            
            const selectAllContainer = document.getElementById('select-all-container');
            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            const batchSelectBtn = document.getElementById('batch-select-btn');
            const selectedCountBadge = document.getElementById('selected-count-badge');
            
            if (batchSelectMode) {
                selectAllContainer.style.display = 'block';
                batchSelectBtn.innerHTML = `<i class="bi bi-x-lg me-1"></i>${messagesI18n.cancelSelect}`;
                batchSelectBtn.classList.remove('btn-outline-secondary');
                batchSelectBtn.classList.add('btn-outline-warning');
            } else {
                selectAllContainer.style.display = 'none';
                batchDeleteBtn.style.display = 'none';
                selectedCountBadge.style.display = 'none';
                batchSelectBtn.innerHTML = `<i class="bi bi-check2-square me-1"></i>${messagesI18n.batchSelect}`;
                batchSelectBtn.classList.remove('btn-outline-warning');
                batchSelectBtn.classList.add('btn-outline-secondary');
                document.getElementById('select-all-messages').checked = false;
            }
            
            // Re-render messages to show/hide checkboxes
            renderMessages(messagesData);
        }

        // Toggle single message selection
        function toggleMessageSelection(messageId) {
            if (selectedMessageIds.has(messageId)) {
                selectedMessageIds.delete(messageId);
            } else {
                selectedMessageIds.add(messageId);
            }
            updateSelectionUI();
        }

        // Toggle select all messages
        function toggleSelectAllMessages() {
            const selectAllCheckbox = document.getElementById('select-all-messages');
            if (selectAllCheckbox.checked) {
                messagesData.forEach(msg => selectedMessageIds.add(msg.id));
            } else {
                selectedMessageIds.clear();
            }
            updateSelectionUI();
            renderMessages(messagesData);
        }

        // Update selection UI
        function updateSelectionUI() {
            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            const selectedCountBadge = document.getElementById('selected-count-badge');
            const selectedCountNumber = document.getElementById('selected-count-number');
            const selectAllCheckbox = document.getElementById('select-all-messages');
            
            const count = selectedMessageIds.size;
            selectedCountNumber.textContent = count;
            
            if (count > 0) {
                batchDeleteBtn.style.display = 'inline-block';
                selectedCountBadge.style.display = 'inline-block';
            } else {
                batchDeleteBtn.style.display = 'none';
                selectedCountBadge.style.display = 'none';
            }
            
            // Update select all checkbox state
            if (messagesData.length > 0 && count === messagesData.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (count > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
            
            // Update individual checkboxes
            messagesData.forEach(msg => {
                const checkbox = document.getElementById(`msg-check-${msg.id}`);
                if (checkbox) {
                    checkbox.checked = selectedMessageIds.has(msg.id);
                }
                const item = document.querySelector(`.message-item[data-message-id="${msg.id}"]`);
                if (item) {
                    if (selectedMessageIds.has(msg.id)) {
                        item.classList.add('selected');
                    } else {
                        item.classList.remove('selected');
                    }
                }
            });
        }

        // Batch delete selected messages
        async function batchDeleteMessages() {
            if (selectedMessageIds.size === 0) return;
            
            const confirmText = messagesI18n.batchDeleteConfirm.replace('{n}', selectedMessageIds.size);
            if (!confirm(confirmText)) return;
            
            const ids = Array.from(selectedMessageIds);
            
            try {
                const response = await fetch('/api/messages/batch-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: ids })
                });
                const result = await response.json();
                
                if (result.success) {
                    const deletedCount = result.data?.deleted_count || ids.length;
                    showToast(messagesI18n.batchDeleteSuccess.replace('{n}', deletedCount), false);
                } else {
                    showToast(result.message || messagesI18n.deleteFailed, true);
                }
            } catch (error) {
                showToast(messagesI18n.deleteFailed, true);
            }
            
            selectedMessageIds.clear();
            
            // Exit batch select mode and reload messages
            toggleBatchSelectMode();
            loadMessagesPage(currentMessagesPage);
            loadUnreadCount();
        }

        // Format message time
        function formatMessageTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return messagesI18n.timeJustNow;
            if (minutes < 60) return messagesI18n.timeMinutesAgo.replace('{n}', minutes);
            if (hours < 24) return messagesI18n.timeHoursAgo.replace('{n}', hours);
            if (days < 7) return messagesI18n.timeDaysAgo.replace('{n}', days);
            
            return date.toLocaleDateString(currentLang === 'zh' ? 'zh-CN' : 'en-US', {
                month: 'short',
                day: 'numeric'
            });
        }

        // Open message detail
        async function openMessage(messageId) {
            currentMessageId = messageId;
            try {
                const response = await fetch(`/api/messages/${messageId}`);
                const result = await response.json();
                if (result.success && result.data) {
                    const msg = result.data;
                    document.getElementById('message-detail-title').textContent = msg.title;
                    
                    const typeText = msg.type === 'system' ? messagesI18n.typeSystem : 
                                    msg.type === 'announcement' ? messagesI18n.typeAnnouncement : messagesI18n.typeNormal;
                    const date = new Date(msg.created_at).toLocaleString(currentLang === 'zh' ? 'zh-CN' : 'en-US');
                    document.getElementById('message-detail-meta').innerHTML = `
                        <span class="badge ${msg.type === 'system' ? 'bg-info' : msg.type === 'announcement' ? 'bg-warning text-dark' : 'bg-secondary'}">${typeText}</span>
                        <span class="ms-2"><i class="bi bi-clock me-1"></i>${date}</span>
                    `;
                    document.getElementById('message-detail-content').textContent = msg.content;
                    
                    // Hide messages modal and show detail modal
                    bootstrap.Modal.getInstance(document.getElementById('messagesModal')).hide();
                    setTimeout(() => {
                        new bootstrap.Modal(document.getElementById('messageDetailModal')).show();
                    }, 200);
                    
                    // Refresh unread count and messages list
                    loadUnreadCount();
                    loadMessagesPage(currentMessagesPage);
                }
            } catch (error) {
                console.error('Failed to open message:', error);
            }
        }

        // Back to messages list from detail
        function backToMessagesList() {
            bootstrap.Modal.getInstance(document.getElementById('messageDetailModal')).hide();
            setTimeout(() => {
                new bootstrap.Modal(document.getElementById('messagesModal')).show();
            }, 200);
        }

        // Delete current message
        async function deleteCurrentMessage() {
            if (!currentMessageId) return;
            
            if (!confirm(messagesI18n.deleteConfirm)) return;
            
            try {
                const response = await fetch(`/api/messages/${currentMessageId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('messageDetailModal')).hide();
                    showToast(messagesI18n.deleteSuccess, false);
                    setTimeout(() => {
                        new bootstrap.Modal(document.getElementById('messagesModal')).show();
                        loadMessagesPage(currentMessagesPage);
                    }, 200);
                    loadUnreadCount();
                } else {
                    showToast(result.message || 'Delete failed', true);
                }
            } catch (error) {
                showToast('Delete failed', true);
            }
        }

        // Mark all messages as read
        async function markAllMessagesAsRead() {
            try {
                const response = await fetch('/api/messages/read-all', {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    showToast(messagesI18n.markAllReadSuccess, false);
                    loadMessagesPage(currentMessagesPage);
                    loadUnreadCount();
                }
            } catch (error) {
                console.error('Failed to mark all as read:', error);
            }
        }

        // Configuration constants for message polling
        const MESSAGE_POLL_INTERVAL_MS = 30000; // 30 seconds

        // Poll for new messages at configured interval
        setInterval(loadUnreadCount, MESSAGE_POLL_INTERVAL_MS);
    </script>
    {{if .custom.GlobalHTML}}{{.custom.GlobalHTML}}{{end}}
</body>
</html>
