<!DOCTYPE html>
<html lang="{{.lang}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{t .lang "register.title"}} - {{t .lang "app.name"}}</title>
    <link href="/static/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/static/vendor/bootstrap-icons/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        .slider-captcha {
            margin-bottom: 1rem;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .slider-captcha-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .slider-captcha-title i {
            margin-right: 8px;
            color: var(--primary-color);
        }
        .slider-track {
            position: relative;
            height: 40px;
            background: linear-gradient(90deg, #e8f5e9 0%, #fff3e0 50%, #ffebee 100%);
            border-radius: 20px;
            overflow: hidden;
        }
        .slider-target {
            position: absolute;
            top: 5px;
            width: 30px;
            height: 30px;
            background: var(--gradient);
            border-radius: 50%;
            opacity: 0.6;
        }
        .slider-thumb {
            position: absolute;
            top: 0;
            left: 0;
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: box-shadow 0.2s;
            z-index: 10;
        }
        .slider-thumb:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .slider-thumb:active {
            cursor: grabbing;
        }
        .slider-thumb i {
            color: var(--primary-color);
            font-size: 18px;
        }
        .slider-captcha.verified .slider-thumb {
            background: #4caf50;
        }
        .slider-captcha.verified .slider-thumb i {
            color: white;
        }
        .slider-hint {
            font-size: 12px;
            color: #999;
            text-align: center;
            margin-top: 8px;
        }
        .slider-captcha.verified .slider-hint {
            color: #4caf50;
        }
    </style>
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="bi bi-person-plus-fill"></i>
                </div>
                <h1>{{t .lang "register.title"}}</h1>
                <p class="text-muted">{{t .lang "register.subtitle"}}</p>
            </div>

            <div id="alert-container"></div>

            <form id="register-form" class="auth-form">
                <div class="mb-3">
                    <label for="email" class="form-label">{{t .lang "register.email"}}</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                        <input type="email" class="form-control" id="email" name="email" placeholder="{{t .lang "register.email.placeholder"}}" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="username" class="form-label">{{t .lang "register.username"}}</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-person"></i></span>
                        <input type="text" class="form-control" id="username" name="username" placeholder="{{t .lang "register.username.placeholder"}}" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="display_name" class="form-label">{{t .lang "register.display_name"}} <span class="text-muted">{{t .lang "register.display_name.optional"}}</span></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-tag"></i></span>
                        <input type="text" class="form-control" id="display_name" name="display_name" placeholder="{{t .lang "register.display_name.placeholder"}}">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">{{t .lang "register.password"}}</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock"></i></span>
                        <input type="password" class="form-control" id="password" name="password" placeholder="{{t .lang "register.password.placeholder"}}" required minlength="6">
                        <button class="btn btn-outline-secondary toggle-password" type="button">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="confirm_password" class="form-label">{{t .lang "register.confirm_password"}}</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" placeholder="{{t .lang "register.confirm_password.placeholder"}}" required>
                        <button class="btn btn-outline-secondary toggle-password" type="button">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>

                {{if .captchaEnabled}}
                <div class="slider-captcha" id="slider-captcha">
                    <div class="slider-captcha-title">
                        <i class="bi bi-shield-check"></i>
                        <span>{{if eq .lang "zh"}}请拖动滑块到指定位置{{else}}Drag the slider to the target{{end}}</span>
                    </div>
                    <div class="slider-track" id="slider-track">
                        <div class="slider-target" id="slider-target"></div>
                        <div class="slider-thumb" id="slider-thumb">
                            <i class="bi bi-arrows-move"></i>
                        </div>
                    </div>
                    <div class="slider-hint" id="slider-hint">{{if eq .lang "zh"}}拖动滑块验证{{else}}Slide to verify{{end}}</div>
                    <input type="hidden" id="captcha_id" name="captcha_id">
                </div>
                {{end}}

                <div class="mb-4">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="agree" required>
                        <label class="form-check-label" for="agree">{{t .lang "register.agree"}} <a href="#" class="text-decoration-none">{{t .lang "register.terms"}}</a> {{t .lang "register.and"}} <a href="#" class="text-decoration-none">{{t .lang "register.privacy"}}</a></label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100 btn-lg">
                    <i class="bi bi-person-plus me-2"></i>{{t .lang "register.submit"}}
                </button>
            </form>

            {{if .googleOAuthEnabled}}
            <div class="auth-divider">
                <span>{{if eq .lang "zh"}}或{{else}}or{{end}}</span>
            </div>

            <div class="social-login">
                <button type="button" class="btn btn-outline-dark w-100" id="google-login-btn">
                    <svg class="google-icon me-2" viewBox="0 0 24 24" width="18" height="18">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    {{t .lang "register.google"}}
                </button>
            </div>
            {{end}}

            <div class="auth-footer">
                <p>{{t .lang "register.has_account"}} <a href="/auth/login{{if .redirect}}?redirect={{urlquery .redirect}}{{end}}">{{t .lang "register.login_now"}}</a></p>
            </div>
        </div>
    </div>

    <script src="/static/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        const lang = '{{.lang}}';
        const captchaEnabled = {{.captchaEnabled}};
        const redirectURL = '{{js .redirect}}';
        const messages = {
            success: '{{t .lang "register.success"}}',
            passwordMismatch: '{{t .lang "register.password_mismatch"}}',
            networkError: '{{t .lang "login.network_error"}}',
            captchaRequired: lang === 'zh' ? '请先完成验证码验证' : 'Please complete the captcha verification',
            captchaSuccess: lang === 'zh' ? '验证成功' : 'Verification successful',
            captchaFailed: lang === 'zh' ? '验证失败，请重试' : 'Verification failed, please try again'
        };

        let captchaVerified = false;
        let captchaId = '';

        {{if .captchaEnabled}}
        // Initialize captcha
        async function initCaptcha() {
            try {
                const response = await fetch('/api/captcha/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.success && data.data.enabled) {
                    captchaId = data.data.id;
                    document.getElementById('captcha_id').value = captchaId;
                    const target = document.getElementById('slider-target');
                    const track = document.getElementById('slider-track');
                    const trackWidth = track.offsetWidth - 30;
                    target.style.left = (data.data.target / 100 * trackWidth) + 'px';
                    target.dataset.target = data.data.target;
                }
            } catch (error) {
                console.error('Failed to init captcha:', error);
            }
        }

        // Slider captcha logic
        const sliderThumb = document.getElementById('slider-thumb');
        const sliderTrack = document.getElementById('slider-track');
        const sliderTarget = document.getElementById('slider-target');
        const sliderHint = document.getElementById('slider-hint');
        const sliderCaptcha = document.getElementById('slider-captcha');

        let isDragging = false;
        let startX = 0;
        let thumbLeft = 0;

        sliderThumb.addEventListener('mousedown', startDrag);
        sliderThumb.addEventListener('touchstart', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);

        function startDrag(e) {
            if (captchaVerified) return;
            isDragging = true;
            startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            thumbLeft = sliderThumb.offsetLeft;
            sliderThumb.style.transition = 'none';
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const diff = currentX - startX;
            const trackWidth = sliderTrack.offsetWidth - 40;
            let newLeft = Math.max(0, Math.min(thumbLeft + diff, trackWidth));
            sliderThumb.style.left = newLeft + 'px';
        }

        async function endDrag() {
            if (!isDragging) return;
            isDragging = false;
            sliderThumb.style.transition = 'left 0.2s';

            const trackWidth = sliderTrack.offsetWidth - 40;
            const position = Math.round(sliderThumb.offsetLeft / trackWidth * 100);

            try {
                const response = await fetch('/api/captcha/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: captchaId, position: position })
                });
                const data = await response.json();

                if (data.success) {
                    captchaVerified = true;
                    sliderCaptcha.classList.add('verified');
                    sliderThumb.innerHTML = '<i class="bi bi-check-lg"></i>';
                    sliderHint.textContent = messages.captchaSuccess;
                } else {
                    sliderThumb.style.left = '0px';
                    sliderHint.textContent = messages.captchaFailed;
                    setTimeout(initCaptcha, 1000);
                }
            } catch (error) {
                sliderThumb.style.left = '0px';
                sliderHint.textContent = messages.captchaFailed;
            }
        }

        initCaptcha();
        {{end}}

        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const username = document.getElementById('username').value;
            const display_name = document.getElementById('display_name').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (password !== confirmPassword) {
                showModal('danger', lang === 'zh' ? '密码错误' : 'Password Error', messages.passwordMismatch);
                return;
            }

            {{if .captchaEnabled}}
            if (!captchaVerified) {
                showModal('warning', lang === 'zh' ? '验证提示' : 'Verification Required', messages.captchaRequired);
                return;
            }
            {{end}}
            
            const payload = { email, username, password, display_name };
            {{if .captchaEnabled}}
            payload.captcha_id = captchaId;
            {{end}}
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Build redirect URL with redirect parameter if present
                    const targetUrl = redirectURL ? '/auth/login?redirect=' + encodeURIComponent(redirectURL) : '/profile';
                    const loginRedirectUrl = redirectURL ? '/auth/login?redirect=' + encodeURIComponent(redirectURL) : '/auth/login';
                    // Auto-login after successful registration
                    try {
                        const loginResponse = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });
                        const loginData = await loginResponse.json();
                        
                        if (loginData.success) {
                            showModal('success', lang === 'zh' ? '注册成功' : 'Registration Successful', 
                                lang === 'zh' ? '注册成功，正在自动登录...' : 'Registration successful, logging in...', true, targetUrl);
                        } else {
                            showModal('success', lang === 'zh' ? '注册成功' : 'Registration Successful', 
                                lang === 'zh' ? '注册成功，请登录' : 'Registration successful, please login', true, loginRedirectUrl);
                        }
                    } catch (loginError) {
                        showModal('success', lang === 'zh' ? '注册成功' : 'Registration Successful', 
                            lang === 'zh' ? '注册成功，请登录' : 'Registration successful, please login', true, loginRedirectUrl);
                    }
                } else {
                    showModal('danger', lang === 'zh' ? '注册失败' : 'Registration Failed', data.message);
                    {{if .captchaEnabled}}
                    captchaVerified = false;
                    sliderCaptcha.classList.remove('verified');
                    sliderThumb.innerHTML = '<i class="bi bi-arrows-move"></i>';
                    sliderThumb.style.left = '0px';
                    sliderHint.textContent = lang === 'zh' ? '拖动滑块验证' : 'Slide to verify';
                    initCaptcha();
                    {{end}}
                }
            } catch (error) {
                showModal('danger', lang === 'zh' ? '网络错误' : 'Network Error', messages.networkError);
            }
        });

        {{if .googleOAuthEnabled}}
        document.getElementById('google-login-btn').addEventListener('click', function() {
            window.location.href = '/api/auth/google/login';
        });
        {{end}}

        // Toggle password visibility
        document.querySelectorAll('.toggle-password').forEach(btn => {
            btn.addEventListener('click', function() {
                const input = this.parentElement.querySelector('input');
                const icon = this.querySelector('i');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.replace('bi-eye', 'bi-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.replace('bi-eye-slash', 'bi-eye');
                }
            });
        });

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        function showModal(type, title, message, autoRedirect = false, redirectUrl = '/') {
            const iconMap = {
                'success': 'bi-check-circle-fill',
                'danger': 'bi-exclamation-circle-fill',
                'warning': 'bi-exclamation-triangle-fill',
                'info': 'bi-info-circle-fill'
            };
            const colorMap = {
                'success': '#28a745',
                'danger': '#dc3545',
                'warning': '#ffc107',
                'info': '#17a2b8'
            };
            
            // Remove existing modal
            const existingModal = document.getElementById('resultModal');
            if (existingModal) existingModal.remove();
            
            const modalHtml = `
                <div class="modal fade" id="resultModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-body text-center py-5">
                                <i class="bi ${iconMap[type]} display-1 mb-3" style="color: ${colorMap[type]}"></i>
                                <h4 class="mb-3">${title}</h4>
                                <p class="text-muted mb-0">${message}</p>
                                ${autoRedirect ? `<p class="text-muted mt-3"><small>${lang === 'zh' ? '即将自动跳转...' : 'Redirecting...'}</small></p>` : ''}
                            </div>
                            ${!autoRedirect ? `
                            <div class="modal-footer justify-content-center border-0 pt-0">
                                <button type="button" class="btn btn-${type === 'success' ? 'success' : 'primary'} px-4" data-bs-dismiss="modal">
                                    ${lang === 'zh' ? '确定' : 'OK'}
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            modal.show();
            
            if (autoRedirect) {
                setTimeout(() => {
                    window.location.href = redirectUrl;
                }, 1500);
            }
        }
    </script>
</body>
</html>
