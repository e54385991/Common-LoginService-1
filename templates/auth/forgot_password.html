<!DOCTYPE html>
<html lang="{{.lang}}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{t .lang "forgot.title"}} - {{t .lang "app.name"}}</title>
    <!-- Inline script to prevent white flash on page load -->
    <script>
        (function() {
            var serverDarkMode = '{{.darkMode}}';
            var theme = 'light';
            if (serverDarkMode === 'dark') {
                theme = 'dark';
            } else if (serverDarkMode === 'light') {
                theme = 'light';
            } else {
                var stored = localStorage.getItem('dark-mode-preference');
                if (stored !== null) {
                    theme = stored === 'true' ? 'dark' : 'light';
                } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    theme = 'dark';
                }
            }
            document.documentElement.setAttribute('data-theme', theme);
            window.serverDarkModeSetting = serverDarkMode;
        })();
    </script>
    <link href="/static/vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/static/vendor/bootstrap-icons/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    {{if .captchaEnabled}}
    <style>
        .slider-captcha {
            margin-bottom: 1rem;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .slider-captcha-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .slider-captcha-title i {
            margin-right: 8px;
            color: var(--primary-color);
        }
        .slider-track {
            position: relative;
            height: 40px;
            background: linear-gradient(90deg, #e8f5e9 0%, #fff3e0 50%, #ffebee 100%);
            border-radius: 20px;
            overflow: hidden;
        }
        .slider-target {
            position: absolute;
            top: 5px;
            width: 30px;
            height: 30px;
            background: var(--gradient);
            border-radius: 50%;
            opacity: 0.6;
        }
        .slider-thumb {
            position: absolute;
            top: 0;
            left: 0;
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: box-shadow 0.2s;
            z-index: 10;
        }
        .slider-thumb:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .slider-thumb:active {
            cursor: grabbing;
        }
        .slider-thumb i {
            color: var(--primary-color);
            font-size: 18px;
        }
        .slider-captcha.verified .slider-thumb {
            background: #4caf50;
        }
        .slider-captcha.verified .slider-thumb i {
            color: white;
        }
        .slider-hint {
            font-size: 12px;
            color: #999;
            text-align: center;
            margin-top: 8px;
        }
        .slider-captcha.verified .slider-hint {
            color: #4caf50;
        }
    </style>
    {{end}}
    {{if .custom.GlobalCSS}}<style>{{.custom.GlobalCSS}}</style>{{end}}
</head>
<body class="auth-page">
    <!-- Language Switcher and Dark Mode Toggle -->
    <div class="lang-switcher">
        <div class="d-flex gap-2">
            <button class="btn dark-mode-toggle" type="button" onclick="toggleDarkMode()" title="Toggle Dark Mode" style="padding: 8px 12px; border-radius: 20px; background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(0, 0, 0, 0.1);">
                <i class="bi bi-moon-fill"></i>
            </button>
            <div class="dropdown">
                <button class="btn dropdown-toggle" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-globe"></i>
                    <span id="currentLang">{{if eq .lang "zh"}}中文{{else}}English{{end}}</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="langDropdown">
                    <li><a class="dropdown-item {{if eq .lang "en"}}active{{end}}" href="#" onclick="setLanguage('en')"><i class="bi bi-check2 {{if ne .lang "en"}}invisible{{end}}"></i> English</a></li>
                    <li><a class="dropdown-item {{if eq .lang "zh"}}active{{end}}" href="#" onclick="setLanguage('zh')"><i class="bi bi-check2 {{if ne .lang "zh"}}invisible{{end}}"></i> 中文</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="bi bi-envelope-paper"></i>
                </div>
                <h1>{{t .lang "forgot.title"}}</h1>
                <p class="text-muted">{{t .lang "forgot.subtitle"}}</p>
            </div>

            <div id="alert-container"></div>

            <form id="forgot-form" class="auth-form">
                <div class="mb-4">
                    <label for="email" class="form-label">{{t .lang "forgot.email"}}</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                        <input type="email" class="form-control" id="email" name="email" placeholder="{{t .lang "forgot.email.placeholder"}}" required>
                    </div>
                </div>

                {{if .captchaEnabled}}<input type="hidden" id="captcha_id" name="captcha_id">{{end}}

                <button type="submit" class="btn btn-primary w-100 btn-lg">
                    <i class="bi bi-send me-2"></i>{{t .lang "forgot.submit"}}
                </button>
            </form>

            <div class="auth-footer">
                <p><a href="/auth/login"><i class="bi bi-arrow-left me-1"></i>{{t .lang "forgot.back"}}</a></p>
            </div>
        </div>
    </div>

    {{if .captchaEnabled}}
    <!-- Captcha Modal -->
    <div class="modal fade" id="captchaModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-shield-check me-2"></i>{{if eq .lang "zh"}}安全验证{{else}}Security Verification{{end}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="slider-captcha" id="slider-captcha">
                        <div class="slider-captcha-title">
                            <i class="bi bi-shield-check"></i>
                            <span>{{if eq .lang "zh"}}请拖动滑块到指定位置{{else}}Drag the slider to the target{{end}}</span>
                        </div>
                        <div class="slider-track" id="slider-track">
                            <div class="slider-target" id="slider-target"></div>
                            <div class="slider-thumb" id="slider-thumb">
                                <i class="bi bi-arrows-move"></i>
                            </div>
                        </div>
                        <div class="slider-hint" id="slider-hint">{{if eq .lang "zh"}}拖动滑块验证{{else}}Slide to verify{{end}}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{end}}

    <script src="/static/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        const lang = '{{.lang}}';
        const captchaEnabled = {{.captchaEnabled}};
        const messages = {
            success: '{{t .lang "forgot.success"}}',
            networkError: '{{t .lang "login.network_error"}}',
            captchaRequired: lang === 'zh' ? '请先完成验证码验证' : 'Please complete the captcha verification',
            captchaSuccess: lang === 'zh' ? '验证成功' : 'Verification successful',
            captchaFailed: lang === 'zh' ? '验证失败，请重试' : 'Verification failed, please try again'
        };

        let captchaVerified = false;
        let captchaId = '';
        let pendingFormData = null;

        {{if .captchaEnabled}}
        let captchaModal;
        
        // Initialize captcha modal
        document.addEventListener('DOMContentLoaded', function() {
            captchaModal = new bootstrap.Modal(document.getElementById('captchaModal'));
        });

        // Initialize captcha
        async function initCaptcha() {
            try {
                const response = await fetch('/api/captcha/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.success && data.data.enabled) {
                    captchaId = data.data.id;
                    document.getElementById('captcha_id').value = captchaId;
                    const target = document.getElementById('slider-target');
                    const track = document.getElementById('slider-track');
                    const trackWidth = track.offsetWidth - 30; // target width
                    target.style.left = (data.data.target / 100 * trackWidth) + 'px';
                    
                    // Store target position
                    target.dataset.target = data.data.target;
                }
            } catch (error) {
                console.error('Failed to init captcha:', error);
            }
        }

        // Reset captcha state
        function resetCaptcha() {
            captchaVerified = false;
            const sliderCaptcha = document.getElementById('slider-captcha');
            const sliderThumb = document.getElementById('slider-thumb');
            const sliderHint = document.getElementById('slider-hint');
            sliderCaptcha.classList.remove('verified');
            sliderThumb.innerHTML = '<i class="bi bi-arrows-move"></i>';
            sliderThumb.style.left = '0px';
            sliderHint.textContent = lang === 'zh' ? '拖动滑块验证' : 'Slide to verify';
            initCaptcha();
        }

        // Slider captcha logic
        const sliderThumb = document.getElementById('slider-thumb');
        const sliderTrack = document.getElementById('slider-track');
        const sliderTarget = document.getElementById('slider-target');
        const sliderHint = document.getElementById('slider-hint');
        const sliderCaptcha = document.getElementById('slider-captcha');

        let isDragging = false;
        let startX = 0;
        let thumbLeft = 0;

        sliderThumb.addEventListener('mousedown', startDrag);
        sliderThumb.addEventListener('touchstart', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);

        function startDrag(e) {
            if (captchaVerified) return;
            isDragging = true;
            startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            thumbLeft = sliderThumb.offsetLeft;
            sliderThumb.style.transition = 'none';
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const diff = currentX - startX;
            const trackWidth = sliderTrack.offsetWidth - 40; // thumb width
            let newLeft = Math.max(0, Math.min(thumbLeft + diff, trackWidth));
            sliderThumb.style.left = newLeft + 'px';
        }

        async function endDrag() {
            if (!isDragging) return;
            isDragging = false;
            sliderThumb.style.transition = 'left 0.2s';

            const trackWidth = sliderTrack.offsetWidth - 40;
            const position = Math.round(sliderThumb.offsetLeft / trackWidth * 100);

            try {
                const response = await fetch('/api/captcha/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: captchaId, position: position })
                });
                const data = await response.json();

                if (data.success) {
                    captchaVerified = true;
                    sliderCaptcha.classList.add('verified');
                    sliderThumb.innerHTML = '<i class="bi bi-check-lg"></i>';
                    sliderHint.textContent = messages.captchaSuccess;
                    
                    // Auto submit after successful captcha
                    setTimeout(() => {
                        captchaModal.hide();
                        if (pendingFormData) {
                            // Add captcha_id to the pending data before submitting
                            pendingFormData.captcha_id = captchaId;
                            performForgotPassword(pendingFormData);
                        }
                    }, 500);
                } else {
                    // Reset slider
                    sliderThumb.style.left = '0px';
                    sliderHint.textContent = messages.captchaFailed;
                    // Regenerate captcha
                    setTimeout(initCaptcha, 1000);
                }
            } catch (error) {
                sliderThumb.style.left = '0px';
                sliderHint.textContent = messages.captchaFailed;
            }
        }
        {{end}}

        // Perform actual forgot password request
        async function performForgotPassword(data) {
            try {
                const response = await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', messages.success);
                    document.getElementById('forgot-form').style.display = 'none';
                } else {
                    showAlert('danger', result.message);
                    {{if .captchaEnabled}}
                    resetCaptcha();
                    {{end}}
                }
            } catch (error) {
                showAlert('danger', messages.networkError);
            }
        }

        document.getElementById('forgot-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const payload = { email };
            
            {{if .captchaEnabled}}
            if (!captchaVerified) {
                // Store pending data and show captcha modal
                pendingFormData = payload;
                initCaptcha();
                captchaModal.show();
                return;
            }
            payload.captcha_id = captchaId;
            {{end}}
            
            performForgotPassword(payload);
        });

        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        // setLanguage function is now in /static/js/app.js
    </script>
    {{if .custom.GlobalHTML}}{{.custom.GlobalHTML}}{{end}}
</body>
</html>
